<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Cookie-based authentication is a simple and powerful mechanism to enable website user login in a RESTful and lightweight way; the Takes framework does it with a few composable decorators." /> <meta name="keywords" content="cookie authentication best practices, cookie authentication security, cookie authentication web api, cookie based authentication, cookies for authentication" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2015-05-18 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="How Cookie-Based Authentication Works in the Takes Framework"/> <meta name="twitter:description" property="og:description" content="Cookie-based authentication is a simple and powerful mechanism to enable website user login in a RESTful and lightweight way; the Takes framework does it with a few composable decorators."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?3a3b5d6c83f"/> <link rel="apple-touch-icon" href="/favicon.ico?3a3b5d6c83f"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?3a3b5d6c83f"/> <link rel="stylesheet" href="/css/icons.css?3a3b5d6c83f"/> <link rel="canonical" href="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" /> <title>How Cookie-Based Authentication Works in the Takes Framework</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;385</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2015/05/18/cookie-based-authentication.html</code></p><h1 itemprop="name headline mainEntityOfPage">How Cookie-Based Authentication Works in the Takes Framework</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2015-05-18T00:00:00+00:00"> 18 May 2015 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2015/05/18/cookie-based-authentication.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'><img src='/images/icons/java-white.svg' alt='Java'/>java</a> <a href='/tag/pets.html' class='tag notranslate'>pets</a></p><nav class="buttons notranslate desktop-only"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html&amp;text=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="https://reddit.com/submit?url=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html%3F2015-20&amp;title=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="https://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2015/05/18/cookie-based-authentication.html%3F2015-20&amp;t=How+Cookie-Based+Authentication+Works+in+the+Takes+Framework" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div > <figure class="badge"><a href="http://www.takes.org"><img src="http://www.takes.org/logo.png" style="width:96px;max-width:100%;" alt="badge" /></a></figure><p>When you enter your email and password into the Facebook login page, you get into your account. Then, wherever you go in the site, you always see your photo at the top right corner of the page. Facebook remembers you and doesn’t ask for the password again and again. This works thanks to <a href="https://en.wikipedia.org/wiki/HTTP_cookie">HTTP cookies</a> and is called <em>cookie-based authentication</em>. Even though this mechanism often causes some security problems, it is very popular and simple. Here is how <a href="http://www.takes.org">Takes</a> makes it possible in a few lines of code.</p><p>First, let’s see how it works. Moreover, let’s see how I believe it should work.</p><p>Step one: The user enters an email and password and clicks “submit.” The server receives a POST request with this information inside:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST / HTTP/1.1
Host: www.facebook.com
Content-Type: application/x-www-form-urlencoded

email=me@yegor256.com&amp;password=itisasecret
</code></pre></div></div><p>The server matches the provided information with its records and decides what to do. If the information is invalid, it returns the same login page, asking you to enter it all again. If the information is valid, the server returns something like this:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com
</code></pre></div></div><p>Since the response status code is 303, the browser goes to the page specified in the <code class="language-plaintext highlighter-rouge">Location</code> header and opens the front page of the site. This is what it sends to the server:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: www.facebook.com
Cookie: user=me@yegor256.com
</code></pre></div></div><p>The server gets my email from the <code class="language-plaintext highlighter-rouge">Cookie</code> header and understands that it’s me again! No need to ask for the password once more. The server trusts the information from the cookie. That’s it. That’s what cookie-based authentication is all about.</p><h2 id="wait--what-about-security">Wait … What About Security?</h2><p>Right, what about security? If the server trusts any browser request with a user email in the <code class="language-plaintext highlighter-rouge">Cookie</code> header, anyone would be able to send my email from another place and get access to my account.</p><p>The first step to prevent this is to encrypt the email with a secret encryption key, known only to the server. Nobody except the server itself will be able to encrypt it the same way the server needs to decrypt it. The response would look like this, using an example of encryption by <a href="https://en.wikipedia.org/wiki/XOR_cipher">XOR cipher</a> with <code class="language-plaintext highlighter-rouge">bamboo</code> as a secret key:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39
</code></pre></div></div><p>This is not the best encryption mechanism, though; for proper encryption, it’s better to use something stronger like <a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>.</p><p>This all sounds good, but what if someone hijacks the traffic between the server and the browser and gets a hold of a properly encrypted email cookie? In this case, the thief would be able to use the same cookie for authentication even without knowing its content. The server would trust the information and let the person into my account. This type of attack is called <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle</a> (MITM). To prevent this from happening, we should use HTTPS and inform the browser that the cookie is sensitive and should never be returned to the server without SSL encryption. That’s done by an extra flag in the <code class="language-plaintext highlighter-rouge">Set-Cookie</code> header:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure
</code></pre></div></div><p>There is yet another type of attack associated with cookie-based authentication, based on a browser’s ability to expose all cookies associated with a web page to JavaScript executed inside it. An attacker may inject some malicious JavaScript code into the page (Don’t ask me how … this will happen only if your entire HTML rendering is done wrong), and this code will gain access to the cookie. Then, the code will send the cookie somewhere else so the attacker can collect it. This type of attack is called <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a> (XSS). To prevent this, there is another flag for the <code class="language-plaintext highlighter-rouge">Set-Cookie</code> header, called <code class="language-plaintext highlighter-rouge">HttpOnly</code>:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 303 See Other
Location: www.facebook.com
Set-Cookie: user=me@yegor256.com; Secure; HttpOnly
</code></pre></div></div><p>The presence of this flag will tell the browser that this particular cookie can be transferred back to the server only through HTTP requests. JavaScript won’t have access to it.</p><h2 id="how-its-done-in-takes">How It’s Done in Takes</h2><p>Here is how this cookie-based authentication mechanism is designed in the <a href="http://www.takes.org">Takes</a> framework. The entire framework consists of <em>takes</em>, which receive requests and produce responses (<a href="/2015/03/22/takes-java-web-framework.html">this article</a> explains the framework in more detail). When the request comes in, we should find the authentication cookie in the <code class="language-plaintext highlighter-rouge">Cookie</code> header and translate it to the user credentials. When the response goes out, we should add the <code class="language-plaintext highlighter-rouge">Set-Cookie</code> header to it with the encrypted user credentials. That’s it. Just these two steps.</p><p>Let’s say we have an account page that is supposed to show the current user’s balance:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="nc">Take</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Balances</span> <span class="n">balances</span><span class="o">;</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="c1">// get it from request</span>
    <span class="k">return</span> <span class="nf">RsHTML</span><span class="o">(</span>
      <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
        <span class="s">"&lt;html&gt;Your balance is %s&lt;/html&gt;"</span><span class="o">,</span>
        <span class="k">this</span><span class="o">.</span><span class="na">balances</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Right after the <code class="language-plaintext highlighter-rouge">request</code> comes in, we should retrieve the identity of the user, encoded inside an authenticating cookie. To make this mechanism reusable, we have the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html"><code class="language-plaintext highlighter-rouge">TkAuth</code></a> decorator, which wraps an existing <em>take</em>, decodes an incoming cookie, and adds a new <code class="language-plaintext highlighter-rouge">TkAuth</code> header to the request with the user’s identification information:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="nc">Codec</span> <span class="n">codec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcPlain</span><span class="o">()));</span>
<span class="kd">final</span> <span class="nc">Pass</span> <span class="n">pass</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PsCookie</span><span class="o">(</span><span class="n">codec</span><span class="o">);</span>
<span class="k">new</span> <span class="nf">TkAuth</span><span class="o">(</span><span class="k">new</span> <span class="nc">TkAccount</span><span class="o">(),</span> <span class="n">pass</span><span class="o">);</span>
</code></pre></div></div><p>Again, when <code class="language-plaintext highlighter-rouge">TkAuth</code> receives a request with an authenticating cookie inside, it asks <code class="language-plaintext highlighter-rouge">pass</code> to decode the cookie and return either a valid <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html"><code class="language-plaintext highlighter-rouge">Identity</code></a> or <code class="language-plaintext highlighter-rouge">Identity.ANONYMOUS</code>.</p><p>Then, when the response goes back to the browser, <code class="language-plaintext highlighter-rouge">TkAuth</code> asks <code class="language-plaintext highlighter-rouge">pass</code> to encode the identity back into a string and adds <code class="language-plaintext highlighter-rouge">Set-Cookie</code> to the response.</p><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html"><code class="language-plaintext highlighter-rouge">PsCookie</code></a> uses an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html"><code class="language-plaintext highlighter-rouge">Codec</code></a> in order to do these backward and forward encoding operations.</p><p>When our <code class="language-plaintext highlighter-rouge">TkAccount</code> <em>take</em> wants to retrieve a currently authenticated user identity from the request, it can use <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html"><code class="language-plaintext highlighter-rouge">RqAuth</code></a>, a utility decorator of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code class="language-plaintext highlighter-rouge">Request</code></a>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkAccount</span> <span class="kd">implements</span> <span class="nc">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">act</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Identity</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RqAuth</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">identity</span><span class="o">();</span>
    <span class="c1">// other manipulations with the user</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">RqAuth</code> decorator uses the header, added by <code class="language-plaintext highlighter-rouge">PsCookie</code>, in order to authenticate the user and create an <code class="language-plaintext highlighter-rouge">Identity</code> object.</p><h2 id="how-is-it-composable">How Is It Composable?</h2><p>This mechanism is indeed very extensible and “composable.” Let’s say we want to skip authentication during integration testing. Here is how:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application "take"</span>
  <span class="k">new</span> <span class="nf">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">PsFake</span><span class="o">(</span><span class="cm">/* if running integration tests */</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html"><code class="language-plaintext highlighter-rouge">PsChain</code></a> implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html"><code class="language-plaintext highlighter-rouge">Pass</code></a> and attempts to authenticate the user by asking all encapsulated passes, one by one. The first one in the chain is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html"><code class="language-plaintext highlighter-rouge">PsFake</code></a>. Using a single boolean argument in its constructor, it makes a decision whether to return a fake identity or return nothing. With just a single boolean trigger, we can switch off the entire authentication mechanism in the app.</p><p>Let’s say you want to authenticate users through Facebook OAuth. Here is how:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application "take"</span>
  <span class="k">new</span> <span class="nf">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="nc">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nf">PsFacebook</span><span class="o">(</span>
          <span class="s">"... Facebook API key ..."</span><span class="o">,</span>
          <span class="s">"... Facebook API secret ..."</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="nf">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div><p>When a user clicks on the login link on your site, the browser goes to <code class="language-plaintext highlighter-rouge">facebook.com</code>, where his or her identity is verified. Then, Facebook returns a <code class="language-plaintext highlighter-rouge">302</code> redirection response with a <code class="language-plaintext highlighter-rouge">Location</code> header set to the URL we provide in the login link. The link must include something like this: <code class="language-plaintext highlighter-rouge">?PsByFlag=PsFacebook</code>. This will tell <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html"><code class="language-plaintext highlighter-rouge">PsByFlag</code></a> that this request authenticates a user.</p><p><code class="language-plaintext highlighter-rouge">PsByFlag</code> will iterate through all encapsulated “pairs” and try to find the right one. <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html"><code class="language-plaintext highlighter-rouge">PsFacebook</code></a> will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.</p><p>Here is how we can implement a logout mechanism:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">TkAuth</span><span class="o">(</span>
  <span class="n">take</span><span class="o">,</span> <span class="c1">// original application "take"</span>
  <span class="k">new</span> <span class="nf">PsChain</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">PsByFlag</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="nc">PsFacebook</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nf">PsFacebook</span><span class="o">(</span>
          <span class="s">"... Facebook API key ..."</span><span class="o">,</span>
          <span class="s">"... Facebook API secret ..."</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="k">new</span> <span class="nc">PsByFlag</span><span class="o">.</span><span class="na">Pair</span><span class="o">(</span>
        <span class="nc">PsLogout</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
        <span class="k">new</span> <span class="nf">PsLogout</span><span class="o">()</span>
      <span class="o">)</span>
    <span class="o">),</span>
    <span class="k">new</span> <span class="nf">PsCookie</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">CcHex</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcXOR</span><span class="o">(</span><span class="k">new</span> <span class="nc">CcPlain</span><span class="o">()))</span>
    <span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div><p>Now, we can add <code class="language-plaintext highlighter-rouge">?PsByFlag=PsLogout</code> to any link on the site and it will log the current user out.</p><p>You can see how all this works in a real application by checking out the <a href="https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java"><code class="language-plaintext highlighter-rouge">TkAppAuth</code></a> class in <a href="https://www.rultor.com">Rultor</a>.</p></div></article></div><div class="wrapper" aria-hidden="true"> <related-posts /></div><div class="disqus" role="complementary" aria-hidden="true"><p class="disqus_hint" > Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?3a3b5d6c83f"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
