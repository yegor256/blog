<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>XML Data and XSL Views in Takes Framework</title>
    <link rel="canonical" href="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html"
        },
        "headline": "XML Data and XSL Views in Takes Framework",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2015-06-25",
        "dateModified": "2015-06-25",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "XML+XSLT rendering for a web page is a powerful mechanism that
is intensively used in the Takes framework; this post explains
it in detail.
",
        "keywords": ["xml xsl web page", "xsl web framework java", "xslt java web framework", "xslt web page", "xslt for web app"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2015/06/25/xml-data-xsl-views-takes-framework.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>25 June 2015</p>
      <h1>XML Data and XSL Views in Takes Framework</h1>
      

<p>A year ago, I <a href="/2014/06/25/xml-and-xslt-in-browser.html">tried to explain</a>
how effectively data and its presentation can be separated
in a web application with the help of XML and XSL. In a few words,
instead of using <a href="https://en.wikipedia.org/wiki/Comparison_of_web_template_engines">templating</a>
(like JSP, Velocity, FreeMarker, etc.) and injection of data into HTML,
we compose them in the form of an XML document and then let
the XSL stylesheet transform them into HTML. Here is a brief example
of how all this can be used together with the <a href="https://www.takes.org">Takes framework</a>.</p>



<p>First, let’s agree that templating is a bad idea in the first place. Yes, I mean
it. The entire design of JSP is wrong, with all due respect to its creators.
Here is how it works: Let’s say my website has to fetch the current exchange rate of
the euro from a database and show it on the home page. Here’s how my <code class="language-plaintext highlighter-rouge">index.jsp</code>
would look:</p>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>EUR/USD: <span class="nt">&lt;%=</span> <span class="n">rates</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="nt">%&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>In order to create HTML, the JSP engine will have to call <code class="language-plaintext highlighter-rouge">get()</code> on object
<code class="language-plaintext highlighter-rouge">rates</code> and render what’s returned through <code class="language-plaintext highlighter-rouge">toString()</code>. It’s a terrible
design for a few reasons. First, the view is tightly coupled with the model.
Second, the flexibility of rendering is very limited. Third, the result of
rendering is not reusable, and views are not stackable. There are many other
reasons … more about them in one of the next articles.</p>



<p>Let’s see how this should be done right. First, we let our model generate
the output in XML format, for example:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.1"?&gt;</span>
<span class="nt">&lt;page&gt;</span>
  <span class="nt">&lt;rate&gt;</span>1.1324<span class="nt">&lt;/rate&gt;</span>
<span class="nt">&lt;/page&gt;</span>
</code></pre></div></div>

<p>This is what the model will produce, having no knowledge of the view. Then,
we create the view as an XSL stylesheet, which will transform XML into HTML:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;xsl:stylesheet</span> <span class="na">version=</span><span class="s">"1.0"</span>
  <span class="na">xmlns:xsl=</span><span class="s">"https://www.w3.org/1999/XSL/Transform"</span>
  <span class="na">xmlns=</span><span class="s">"https://www.w3.org/1999/xhtml"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:template</span> <span class="na">match=</span><span class="s">"page"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;html&gt;</span>
      <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>
          <span class="nt">&lt;xsl:text&gt;</span>EUR/USD: <span class="nt">&lt;/xsl:text&gt;</span>
          <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"rate"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;/html&gt;</span>
  <span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:stylesheet&gt;</span>
</code></pre></div></div>

<p>As you see, the view doesn’t know anything about the model in terms of
implementation. All it knows is the format of XML data output produced
by the model. Here is how you design it in the <a href="https://www.takes.org">Takes framework</a>.
Let’s start with a simple example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="nc">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="nc">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>It’s a simple web application that starts a web server
and never ends (it waits for connections in daemon mode). To make it work,
we should create a simple “take” named <code class="language-plaintext highlighter-rouge">TkApp</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="nc">TkWrap</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">RsText</span><span class="o">(</span>
        <span class="s">"&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;"</span>
      <span class="o">),</span>
      <span class="s">"application/xml"</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This “take” always returns the same XML response, but it doesn’t
do any XSL transformation yet. We need to add the <code class="language-plaintext highlighter-rouge">RsXSLT</code> class to the picture:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">RsText</span><span class="o">(</span>
        <span class="s">"&lt;?xml-stylesheet type='text/xsl' href='/xsl/index.xsl'?&gt;"</span>
        <span class="o">+</span> <span class="s">"&lt;page&gt;&lt;rate&gt;1.1324&lt;/rate&gt;&lt;/page&gt;"</span>
      <span class="o">),</span>
      <span class="s">"application/xml"</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Excuse me for using string concatenation, which is a
<a href="/2014/06/19/avoid-string-concatenation.html">bad practice</a>;
it’s merely for the simplicity of the example.</p>

<p>As you see, I also added an XML stylesheet processing instruction to
the XML. <code class="language-plaintext highlighter-rouge">RsXSLT</code> will understand it and try to find the <code class="language-plaintext highlighter-rouge">/xsl/index.xsl</code>
resource on classpath. You see the content of that file above.</p>

<p>That’s it.</p>

<p>Well, not really. Building XML from strings is not a good idea. We
have a better instrument in the Takes framework. We use <a href="https://www.xembly.org">Xembly</a>,
which is a simple imperative language for building and modifying
XML documents. More about it here:
<a href="/2014/04/09/xembly-intro.html">Xembly, an Assembly for XML</a>.</p>

<p>Here is how our <code class="language-plaintext highlighter-rouge">TkApp</code> would look:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">RsXSLT</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">RsWithType</span><span class="o">(</span>
      <span class="k">new</span> <span class="nf">RsXembly</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">XeChain</span><span class="o">(</span>
          <span class="k">new</span> <span class="nf">XeStylesheet</span><span class="o">(</span><span class="s">"/xsl/index.xsl"</span><span class="o">),</span>
          <span class="k">new</span> <span class="nf">XeAppend</span><span class="o">(</span>
            <span class="s">"page"</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">XeDirectives</span><span class="o">(</span>
              <span class="k">new</span> <span class="nf">Directives</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"rate"</span><span class="o">).</span><span class="na">set</span><span class="o">(</span><span class="s">"1.1324"</span><span class="o">)</span>
            <span class="o">)</span>
          <span class="o">)</span>
        <span class="o">)</span>
      <span class="o">),</span>
      <span class="s">"application/xml"</span>
    <span class="o">)</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The most important class here is
<a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/RsXembly.html"><code class="language-plaintext highlighter-rouge">RsXembly</code></a>.
The idea is to let
model classes expose their data through Xembly “directives,” which
will later be applied to a DOM structure by <code class="language-plaintext highlighter-rouge">RsXembly</code>.</p>

<p><code class="language-plaintext highlighter-rouge">XeChain</code>, <code class="language-plaintext highlighter-rouge">XeStylesheet</code>, <code class="language-plaintext highlighter-rouge">XeAppend</code>, and <code class="language-plaintext highlighter-rouge">XeDirectives</code> expose
directives but with different meanings
(they are all instances of an <code class="language-plaintext highlighter-rouge">XeSource</code> interface).
Their names describe their
intentions rather well.
<a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeChain.html"><code class="language-plaintext highlighter-rouge">XeChain</code></a>
just chains everything that is
delivered by encapsulated “directive sources.”
<a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeStylesheet.html"><code class="language-plaintext highlighter-rouge">XeStylesheet</code></a>
returns directives that create a single XML processing instruction.
<a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeAppend.html"><code class="language-plaintext highlighter-rouge">XeAppend</code></a>
creates an XML node and adds encapsulated directives to it.
<a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/xe/XeDirectives.html"><code class="language-plaintext highlighter-rouge">XeDirectives</code></a>
simply returns what’s inside.</p>

<p>In the end, this code will create exactly the same XML document
as I created above with string concatenation.</p>

<p>The beauty of this approach is in the perfect
<a href="/2018/09/18/fear-of-coupling.html">decoupling</a>
of data generation
and XML building and translation between XML and HTML. It is perfectly reusable
and “stackable.” We can transform the data in XML format multiple times,
applying different XSL stylesheets to each one. We can even transform them into
<a href="/2015/11/16/json-vs-xml.html">JSON</a>
without changing a line of code in model classes.</p>

<p>Moreover, we can format them differently, using rather powerful XSLT 2.0
instruments. XSLT by itself is a powerful and purely functional language that
enables any possible data manipulations. No templating engine is even close
to it.</p>

<p>Take a look at how it works in the
<a href="https://github.com/yegor256/rultor/blob/1.55/src/main/java/com/rultor/web/RsPage.java"><code class="language-plaintext highlighter-rouge">RsPage</code></a>
class in Rultor, for example.</p>

    </article>
  </body>
</html>
