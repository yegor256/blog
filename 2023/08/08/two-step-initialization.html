<!DOCTYPE html> <html xmlns="https://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Sometimes you might be tempted to use a two-stage construction for your object. However, I suggest reevaluating your design principles if you feel such an inclination." /> <meta name="keywords" content="init method, initialize method, two-stage construction, two-step construction" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2023-08-08 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Is Two-Step Initialization a Solution or a Symptom?"/> <meta name="twitter:description" property="og:description" content="Sometimes you might be tempted to use a two-stage construction for your object. However, I suggest reevaluating your design principles if you feel such an inclination."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2023/08/08/two-step-initialization.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?da1749a7f3b"/> <link rel="apple-touch-icon" href="/favicon.ico?da1749a7f3b"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?da1749a7f3b"/> <link rel="stylesheet" href="/css/icons.css?da1749a7f3b"/> <link rel="canonical" href="https://www.yegor256.com/2023/08/08/two-step-initialization.html" /> <title>Is Two-Step Initialization a Solution or a Symptom?</title> <meta name='og:image' content='https://www.yegor256.com/images/2023/08/nirvana.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2023/08/nirvana.jpg'/><meta name='og:image:width' content='1600'/> <meta name='twitter:image:width' content='1600'/><meta name='og:image:height' content='675'/> <meta name='twitter:image:height' content='675'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Нирвана (2008) by Igor Voloshin'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;467</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/research.html" title="My research directions and progress">Research</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="https://www.iccq.ru" title="International Conference on Code Quality">ICCQ</a></li> <li ><a href="https://www.kaicode.org" title="Open Source Festival">KaiCode</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2023/08/08/two-step-initialization.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2023/08/08/two-step-initialization.html</code></p><h1 itemprop="name headline mainEntityOfPage">Is Two-Step Initialization a Solution or a Symptom?</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2023-08-08T00:00:00+00:00"> 8 August 2023 </time> </li> <li class="desktop-only" itemprop="locationCreated">Moscow, Russia</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2023/08/08/two-step-initialization.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><ul class="subline"> <li title="The page is translated by ChatGPT from English to a few languages"> Translated by <i class="icon icon-chatgpt notranslate" aria-hidden="true"></i> to </li> <li title="Click to see this page translated to Chinese"> <a href='https://www.yegor256.com/zh/2023/08/08/two-step-initialization.html'>中文</a> </li> <li title="Click to see this page translated to Russian"> <a href='https://www.yegor256.com/ru/2023/08/08/two-step-initialization.html'>русский</a> </li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'><img src='/images/icons/java-white.svg' alt='Java'/>java</a> <a href='/tag/oop.html' class='tag notranslate'><img src='/images/icons/cactus.svg' alt='OOP'/>oop</a></p><nav class="buttons notranslate desktop-only"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2023/08/08/two-step-initialization.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2023/08/08/two-step-initialization.html&amp;text=Is+Two-Step+Initialization+a+Solution+or+a+Symptom%3F" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2023/08/08/two-step-initialization.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="https://reddit.com/submit?url=https://www.yegor256.com/2023/08/08/two-step-initialization.html%3F2023-32&amp;title=Is+Two-Step+Initialization+a+Solution+or+a+Symptom%3F" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="https://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2023/08/08/two-step-initialization.html%3F2023-32&amp;t=Is+Two-Step+Initialization+a+Solution+or+a+Symptom%3F" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> <a href="#" title="Cite it via BibTeX" class="button" onclick="$('#bibtex').toggle(); return false;"> <i class="icon icon-tex notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><div id="bibtex" style="display: none"><p>Please, cite this blog post via <a href="https://www.bibtex.org/">BibTeX</a> as such:</p><pre style="color:#053c5e;">@misc&#123;bugayenko2023blog0808,
  author = &#123;Bugayenko, Yegor&#125;,
  title = &#123;&#123;Is Two-Step Initialization a Solution or a Symptom?&#125;&#125;,
  howpublished = &#123;\url&#123;https://www.yegor256.com/230808.html&#125;&#125;,
  year = &#123;2023&#125;,
  month = &#123;aug&#125;,
  note = &#123;[Online; accessed 09-06-2024]&#125;
&#125;</pre></div><p>At times, it might appear practical to execute additional initialization steps for an object after its constructor has completed. However, I’m of the belief that such requirements signal underlying design flaws, such as object mutability, base class fragility, violation of layering, and unfocused abstraction. A constructor should be good enough for all scenarios. If it’s not, refactor the object.</p><figure class="jb_picture"><img itemprop="image" alt="Нирвана (2008) by Igor Voloshin" src="/images/2023/08/nirvana.jpg" longdesc="#879ce886" /><figcaption id="879ce886">Нирвана (2008) by Igor Voloshin</figcaption></figure><p>This is how it usually happens (I found it in <a href="https://github.com/apache/kafka/blob/e0b7499103df9222140cdbf7047494d92913987e/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/secured/RefreshingHttpsJwks.java">Apache Kafka</a>):</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">X</span><span class="o">&gt;</span> <span class="n">items</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isInitialized</span><span class="o">;</span>
  <span class="nc">Foo</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// initialize other fields</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// fill up "items" with data</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">isInitialized</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>It is expected that the object is used this way:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="o">();</span>
<span class="n">x</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</code></pre></div></div><p>There might be practical justifications for this <em>two-stage construction</em>, which, <a href="https://learn.microsoft.com/en-us/cpp/mfc/one-stage-and-two-stage-construction-of-objects?view=msvc-170">as per Microsoft</a>, is touted as an “always safer” approach to object creation. Yet, I’m convinced that each of these reasons signifies a flawed design and should serve as a catalyst for refactoring.</p><h2 id="resource-leakage">Resource Leakage</h2><p>Consider an <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">auto-closeable</a> Java class that opens a stream in its constructor and then reasonably expects it to be closed in the <code class="language-plaintext highlighter-rouge">close()</code> method:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="kd">implements</span> <span class="nc">Closeable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">InputStream</span> <span class="n">in</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Book</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"a.tex"</span><span class="o">));</span>
    <span class="c1">// a bit later:</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"oops!"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>However, if the runtime exception is raised in the constructor, the stream will not be closed and the resource <a href="https://stackoverflow.com/a/29243066/187141">will be leaked</a>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">Book</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">())</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">close()</code> will not be called by the <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a> statement, as the object will not be fully constructed and its initialization won’t be completed. However, even if the initialization isn’t finalized, the instance of <code class="language-plaintext highlighter-rouge">FileInputStream</code> will do part of its work: it will open the file. It will never close it though.</p><p>Two-steps initialization might be a solution:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="kd">implements</span> <span class="nc">Closeable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">InputStream</span> <span class="n">in</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Book</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// nothing</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"a.tex"</span><span class="o">));</span>
    <span class="c1">// a bit later:</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"oops!"</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Now, the code can be used in the following manner, which is indeed safer because the stream will always be closed:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">Book</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">())</span> <span class="o">{</span>
  <span class="n">b</span><span class="o">.</span><span class="na">init</span><span class="o">();</span> <span class="c1">// IOException raised here</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>Even though this may be a good workaround, it is only a cover for the design flaw: mutability of the attribute. A better solution would be to get rid of <a href="/2014/06/09/objects-should-be-immutable.html">mutability</a> of the <code class="language-plaintext highlighter-rouge">Book</code> and remove the <code class="language-plaintext highlighter-rouge">init()</code> method.</p><p>Thus, the <a href="https://en.wikipedia.org/wiki/Initialization_%28programming%29">initialization</a> of the stream should be done outside of the <code class="language-plaintext highlighter-rouge">Book</code> object and then provided to it as an argument of the constructor (pay attention to the <code class="language-plaintext highlighter-rouge">final</code> modifier of the <code class="language-plaintext highlighter-rouge">in</code> field):</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="kd">implements</span> <span class="nc">Closeable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">InputStream</span> <span class="n">in</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">Book</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">in</span> <span class="o">=</span> <span class="n">in</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Then, this is how we can use it:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"a.tex"</span><span class="o">)))</span> <span class="o">{</span>
  <span class="nc">Book</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>Now, both the stream and the book will definitely be closed.</p><p>The root cause of the issue here stems from the <a href="/2014/06/09/objects-should-be-immutable.html">mutability</a> of the <code class="language-plaintext highlighter-rouge">in</code> attribute, which creates potential for resource leakage. If we were to agree upfront that every object must be immutable, this problem wouldn’t arise in the first place. We wouldn’t need a workaround like two-step initialization, because we wouldn’t encounter a class where an attribute might remain <a href="/2014/05/13/why-null-is-bad.html">uninitialized</a>. It seems that this example serves as <a href="/2014/11/07/how-immutability-helps.html">yet another</a> testament to the benefits of object immutability.</p><h2 id="fragile-base-class">Fragile Base Class</h2><p>Consider this parent class, with an immutable attribute <code class="language-plaintext highlighter-rouge">title</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="nc">Product</span><span class="o">(</span><span class="nc">String</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Title: %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Now, let’s extend it (again, the <code class="language-plaintext highlighter-rouge">author</code> attribute is immutable):</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="kd">extends</span> <span class="nc">Product</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">author</span><span class="o">;</span>
  <span class="nc">Book</span><span class="o">(</span><span class="nc">String</span> <span class="n">t</span><span class="o">,</span> <span class="nc">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">author</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Author: %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">author</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>What do you think will be printed after we do the following?</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="s">"Object Thinking"</span><span class="o">,</span> <span class="s">"David West"</span><span class="o">);</span>
</code></pre></div></div><p>This is what:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">Title:</span> <span class="nc">Object</span> <span class="nc">Thinking</span>
<span class="nl">Author:</span> <span class="kc">null</span>
</code></pre></div></div><p>Why does the <code class="language-plaintext highlighter-rouge">author</code> print as <code class="language-plaintext highlighter-rouge">null</code> when we provided the <code class="language-plaintext highlighter-rouge">"David West"</code> string in the constructor? The reason is that <code class="language-plaintext highlighter-rouge">super()</code>, the constructor of the parent class, was invoked before <code class="language-plaintext highlighter-rouge">this.author</code> was initialized. The constructor of the <code class="language-plaintext highlighter-rouge">Product</code> class called its own <a href="https://en.wikipedia.org/wiki/Virtual_function">virtual</a> method <code class="language-plaintext highlighter-rouge">print()</code>, which the derived class <code class="language-plaintext highlighter-rouge">Book</code> had overridden. This issue can be more generically referred to as the “<a href="https://en.wikipedia.org/wiki/Fragile_base_class">fragile base class</a>” problem: the base class calls its own method, expecting it to operate as defined, but this method is unexpectedly replaced by a different implementation in the derived class, leading to unintended and incorrect behavior. Such potential for method replacement is what renders the base class fragile.</p><p>Using two-phase construction could address this issue by keeping attribute initialization in the constructor while relocating the “printing” functionality to a new <code class="language-plaintext highlighter-rouge">init()</code> method. However, this approach merely masks the underlying design flaw: the class’s inherent fragility.</p><p>A more comprehensive solution is twofold. Firstly, maintain constructors code-free, as <a href="/2015/05/07/ctors-must-be-code-free.html">suggested earlier</a>. Secondly, opt for <a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition over inheritance</a>, as has also been <a href="/2016/09/13/inheritance-is-procedural.html">previously recommended</a>.” This is how:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="nc">Product</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="nc">Product</span><span class="o">(</span><span class="nc">String</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Title: %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Product</span> <span class="n">product</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">author</span><span class="o">;</span>
  <span class="nc">Book</span><span class="o">(</span><span class="nc">String</span> <span class="n">t</span><span class="o">,</span> <span class="nc">String</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">author</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">product</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"Author: %s\n"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">author</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Now, both classes are marked as <code class="language-plaintext highlighter-rouge">final</code>, making it technically impossible to override any of their methods. Instead of extending <code class="language-plaintext highlighter-rouge">Product</code>, the <code class="language-plaintext highlighter-rouge">Book</code> class encapsulates an instance of it. The <code class="language-plaintext highlighter-rouge">print()</code> method in the <code class="language-plaintext highlighter-rouge">Book</code> class oversees the printing functionality, delegating part of this responsibility to <code class="language-plaintext highlighter-rouge">product.print()</code>. Such a design becomes the only viable option if we mutually agree from the outset that all constructors should remain <a href="/2015/05/07/ctors-must-be-code-free.html">code-free</a> and that implementation inheritance is <a href="/2016/09/13/inheritance-is-procedural.html">off-limits</a>.</p><h2 id="defaults-and-configs">Defaults and Configs</h2><p>If you’ve coded in Java for a sufficient amount of time, you’ll undoubtedly find this design approach quite familiar:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Database</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">host</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">login</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
  <span class="nc">Database</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="mi">5432</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">login</span> <span class="o">=</span> <span class="s">"pgsql"</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">Config</span> <span class="n">cfg</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="na">getHost</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">login</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="na">getLogin</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Here, the constructor assigns default values to four object attributes, while the <code class="language-plaintext highlighter-rouge">init()</code> method subsequently updates them based on the values from the “configuration” <a href="/2016/07/06/data-transfer-object.html">DTO</a>. This method of object initialization may seem more appealing than a series of <a href="/2014/09/16/getters-and-setters-are-evil.html">setter</a> calls, as it ensures all necessary attributes are assigned simultaneously, with none overlooked. Such assurance isn’t guaranteed with isolated <a href="/2014/09/16/getters-and-setters-are-evil.html">setters</a>. Furthermore, the DTO can be auto-populated from an XML or JSON file, which, when passed to the <code class="language-plaintext highlighter-rouge">init()</code> method, further streamlines the code:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Database</span><span class="o">();</span> <span class="c1">// first initialization step</span>
<span class="kt">var</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">loadFromXML</span><span class="o">(</span><span class="s">"db-config.xml"</span><span class="o">);</span>
<span class="n">db</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">cfg</span><span class="o">);</span> <span class="c1">// second initialization step</span>
</code></pre></div></div><p>However, this merely masks the underlying design flaw: the class is too expansive. It’s not about the lines of code, but rather the multitude of external elements it tries to abstract: the Internet address, the TCP port, the login string, the password, and likely more in the future. While the <code class="language-plaintext highlighter-rouge">Config</code> DTO currently suffices due to its modest size, it seems to pave the way for future expansion, tempting programmers to augment it as they see fit. As the size of <code class="language-plaintext highlighter-rouge">Config</code> increases, so will the number of attributes in <code class="language-plaintext highlighter-rouge">Database</code>. It’s probable that they will soon fall out of sync. Over time, it may become challenging to discern if constructing the <code class="language-plaintext highlighter-rouge">Database</code> object readies it for operation, or if a preliminary <code class="language-plaintext highlighter-rouge">init()</code> call is required. Further, will just invoking <code class="language-plaintext highlighter-rouge">init()</code> be sufficient to utilize the object fully?</p><p>If we had initially agreed that our objects should not encapsulate more than three attributes, as <a href="/2014/12/15/how-much-your-objects-encapsulate.html">suggested earlier</a>, we would have refactored this class. The <code class="language-plaintext highlighter-rouge">init()</code> method would be removed, and all necessary parameters would be passed through its <a href="/2015/05/28/one-primary-constructor.html">primary or secondary</a> constructors. Keeping all attributes immutable would be helpful too.</p><p>It seems that even the <a href="https://en.wikipedia.org/wiki/Builder_pattern">Builder design pattern</a> would be a better solution than the <code class="language-plaintext highlighter-rouge">init()</code> method in this particular case.</p><h2 id="violation-of-layering">Violation of Layering</h2><p>Consider the following two Java classes, which depend on each other:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Order</span> <span class="n">order</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">language</span><span class="o">;</span>
  <span class="nc">Book</span><span class="o">(</span><span class="nc">Order</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">order</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">language</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">language</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Book</span> <span class="n">book</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">total</span><span class="o">;</span>
  <span class="nc">Order</span><span class="o">(</span><span class="nc">Book</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">book</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> 
    <span class="k">this</span><span class="o">.</span><span class="na">total</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">price</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Clearly, instantiating either the <code class="language-plaintext highlighter-rouge">Book</code> or the <code class="language-plaintext highlighter-rouge">Order</code> is impossible, as each requires the other to be instantiated first. Two-phase construction accompanied by <a href="/2014/06/09/objects-should-be-immutable.html">attributes mutability</a> and <a href="/2014/09/16/getters-and-setters-are-evil.html">setters</a> may look like a solution:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Order</span> <span class="n">order</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">language</span><span class="o">;</span>
  <span class="kt">void</span> <span class="nf">setOrder</span><span class="o">(</span><span class="nc">Order</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">order</span> <span class="o">=</span> <span class="n">o</span><span class="o">;</span> <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">language</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">order</span><span class="o">.</span><span class="na">language</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">Book</span> <span class="n">book</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">total</span><span class="o">;</span>
  <span class="kt">void</span> <span class="nf">setBook</span><span class="o">(</span><span class="nc">Book</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">book</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="o">}</span>
  <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">total</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="na">price</span><span class="o">()</span> <span class="o">+</span> <span class="mi">10</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Now, it’s possible to instantiate them:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">();</span>
<span class="n">book</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Book</span><span class="o">();</span>
<span class="n">order</span><span class="o">.</span><span class="na">setBook</span><span class="o">(</span><span class="n">book</span><span class="o">);</span>
<span class="n">book</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
<span class="n">order</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
<span class="n">book</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
</code></pre></div></div><p>However, this design exhibits a significant flaw: both the <code class="language-plaintext highlighter-rouge">order</code> and <code class="language-plaintext highlighter-rouge">book</code> objects remain in an incomplete state until their respective <code class="language-plaintext highlighter-rouge">init()</code> methods are invoked. As the code takes shape, its original author understands the correct sequence of method calls: the constructor first, followed by the setter, and only then the <code class="language-plaintext highlighter-rouge">init()</code> method. However, in the future, as others modify the code, this <a href="/2015/12/08/temporal-coupling-between-method-calls.html">temporal coupling</a> between method calls could be easily missed. An inadvertent call to <code class="language-plaintext highlighter-rouge">init()</code> prior to the setter could result in runtime errors that are difficult to diagnose.</p><p>The underlying issue here stems from a violation of the layering principle present in the design of both <code class="language-plaintext highlighter-rouge">Book</code> and <code class="language-plaintext highlighter-rouge">Order</code>: they are mutually dependent. If I recall correctly, Martin Fowler postulated that “a layer can only access layers beneath it.” In the context of our book-and-order design, there’s no clear distinction of these layers: it’s indeterminable which is foundational to the other. The difficulties in instantiation are just manifestations of this issue, and two-step initialization serves more as a band-aid rather than an actual solution.</p><p>I’m at a loss for how to enhance this code directly. It’s likely that the entire architecture needs a thorough reassessment, with the introduction of more adequate abstractions in place of <code class="language-plaintext highlighter-rouge">Book</code> and <code class="language-plaintext highlighter-rouge">Order</code>.</p><hr /><p>It appears that two-step initialization doesn’t truly solve problems; rather, it merely masks them for a time. While you can have <code class="language-plaintext highlighter-rouge">init()</code> methods in your objects, they look like flags with “I failed to design this class properly!” written on them.</p></div></article></div><script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script><div class="disqus" role="complementary" aria-hidden="true"><p class="disqus_hint" > Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0]; this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span>, 2014&ndash;<span itemprop="copyrightYear">2024</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?da1749a7f3b"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
