<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Simplified GitHub Login for a Ruby Web App</title>
    <link rel="canonical" href="https://www.yegor256.com/2018/06/19/glogin.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2018/06/19/glogin.html"
        },
        "headline": "Simplified GitHub Login for a Ruby Web App",
        "image": {
          "@type": "ImageObject",
          "url": "/images/2018/06/savages.jpg",
          "height": 955,
          "width": 1463
        },
        "datePublished": "2018-06-19",
        "dateModified": "2018-06-19",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "I created a simple Ruby gem that enabled GitHub
OAuth login for a Ruby web app; works for me
together with Sinatra, most probably will work with
other frameworks.
",
        "keywords": ["ruby", "github oauth login", "ruby github oauth", "github login ruby", "ruby web github login"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2018/06/19/glogin.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>19 June 2018</p>
      <h1>Simplified GitHub Login for a Ruby Web App</h1>
      <p>You know what <a href="https://en.wikipedia.org/wiki/OAuth">OAuth</a>
login is, right? It’s when your users click “login”
and get redirected to Facebook, Twitter, Google, or some other
website which then identifies them. Then they go back to your website and you
know who they are. It’s very convenient for them. It’s convenient for you
too, since you don’t need to implement the login functionality and don’t
need to keep their credentials in a database. I created a simple
<a href="https://github.com/yegor256/glogin">Ruby gem</a>
to simplify this operation for GitHub only. Here is how it works.</p>



<amp-img src="/images/2018/06/savages.jpg" alt="The Savages (2007) by Tamara Jenkins" height="955" width="1463" layout="responsive"></amp-img>

<p>First, you will have to register your application in GitHub,
as <a href="https://developer.github.com/apps/building-integrations/setting-up-and-registering-oauth-apps/">this page</a>
explains. This is how it works with
<a href="https://www.sinatrarb.com/">Sinatra</a>,
but you can do something similar in any framework.</p>

<p>First, somewhere in the global space, before the app starts:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'glogin'</span>
<span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:glogin</span><span class="p">,</span> <span class="no">GLogin</span><span class="o">::</span><span class="no">Auth</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="c1"># You get this from GitHub, when you register your</span>
    <span class="c1"># web application:</span>
    <span class="n">client_id</span><span class="p">,</span>
    <span class="c1"># Make sure this value is coming from a secure</span>
    <span class="c1"># place and is NOT visible in the source code:</span>
    <span class="n">client_secret</span><span class="p">,</span>
    <span class="c1"># This is what you will register in GitHub as an</span>
    <span class="c1"># authorization callback URL:</span>
    <span class="s1">'https://www.example.com/github-callback'</span>
  <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Next, for all web pages we need to parse a cookie, if it exists,
and convert it into a user:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/cookies'</span>
<span class="n">before</span> <span class="s1">'/*'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">cookies</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span>
    <span class="k">begin</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">GLogin</span><span class="o">::</span><span class="no">Cookie</span><span class="o">::</span><span class="no">Closed</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
        <span class="n">cookies</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">],</span>
        <span class="c1"># This must be some long text to be used to</span>
        <span class="c1"># encrypt the value in the cookie:</span>
        <span class="n">encryption_secret</span>
      <span class="p">).</span><span class="nf">to_user</span>
    <span class="k">rescue</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">CipherError</span> <span class="o">=&gt;</span> <span class="n">_</span>
      <span class="c1"># Nothing happens here, the user is not logged in.</span>
      <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:glogin</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If the <code class="language-plaintext highlighter-rouge">glogin</code> cookie comes in and contains valid data,
a local variable <code class="language-plaintext highlighter-rouge">@user</code> will be set to something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="ss">login: </span><span class="s1">'yegor256'</span><span class="p">,</span> <span class="ss">avatar: </span><span class="s1">'http://...'</span> <span class="p">}</span>
</code></pre></div></div>

<p>Next, we need a URL for GitHub OAuth callback:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s1">'/github-callback'</span> <span class="k">do</span>
  <span class="n">cookies</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span> <span class="o">=</span> <span class="no">GLogin</span><span class="o">::</span><span class="no">Cookie</span><span class="o">::</span><span class="no">Open</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="n">settings</span><span class="p">.</span><span class="nf">glogin</span><span class="p">.</span><span class="nf">user</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:code</span><span class="p">]),</span>
    <span class="c1"># The same encryption secret that we were using above:</span>
    <span class="n">encryption_secret</span>
  <span class="p">).</span><span class="nf">to_s</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Finally, we need a logout URL:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s1">'/logout'</span> <span class="k">do</span>
  <span class="n">cookies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="ss">:glogin</span><span class="p">)</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>One more thing is the login URL you will need for your front page. Here
it is:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">settings</span><span class="p">.</span><span class="nf">glogin</span><span class="p">.</span><span class="nf">login_uri</span>
</code></pre></div></div>

<p>For unit testing you can just provide an empty string as a <code class="language-plaintext highlighter-rouge">secret</code> for
<code class="language-plaintext highlighter-rouge">GLogin::Cookie::Open</code> and <code class="language-plaintext highlighter-rouge">GLogin::Cookie::Closed</code> and the encryption will be disabled:
whatever comes from the cookie will be trusted. For testing
it will be convenient to provide a user name in a query string, like this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:9292/?glogin=tester
</code></pre></div></div>

<p>To enable that, it’s recommended you add this line (see how
it works in <a href="https://github.com/zold-io/wts.zold.io">zold-io/wts.zold.io</a>):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/cookies'</span>
<span class="n">before</span> <span class="s1">'/*'</span> <span class="k">do</span>
  <span class="n">cookies</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span> <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span>
  <span class="k">if</span> <span class="n">cookies</span><span class="p">[</span><span class="ss">:glogin</span><span class="p">]</span>
    <span class="c1"># same as above</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I use this gem in
<a href="https://github.com/yegor256/sixnines">sixnines</a>,
<a href="https://github.com/yegor256/0pdd">0pdd</a>,
and <a href="https://github.com/zold-io/wts.zold.io">Zold</a>
web apps on top of Sinatra (all open source).</p>

    </article>
  </body>
</html>
