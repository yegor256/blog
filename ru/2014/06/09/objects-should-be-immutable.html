<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="The article gives arguments about why classes/objects in object-oriented programming have to be immutable, i.e. never modify their encapsulated state" /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Objects Should Be Immutable"/> <meta name="twitter:description" property="og:description" content="The article gives arguments about why classes/objects in object-oriented programming have to be immutable, i.e. never modify their encapsulated state"/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2014/06/09/objects-should-be-immutable.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?19fbb713f25"/> <link rel="apple-touch-icon" href="/favicon.ico?19fbb713f25"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?19fbb713f25"/> <link rel="stylesheet" href="/css/icons.css?19fbb713f25"/> <link rel="canonical" href="https://www.yegor256.com/ru/2014/06/09/objects-should-be-immutable.html" /> <title>Objects Should Be Immutable</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;392</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/research.html" title="My research directions and progress">Research</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">Objects Should Be Immutable</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>В объектно-ориентированном программировании объект считается неизменяемым, если его состояние не может быть изменено после создания. В Java хорошим примером неизменяемого объекта является <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/String.html"><code class="language-plaintext highlighter-rouge">String</code></a>. После создания его состояние нельзя изменить. Мы можем запросить создание новых строк, но его собственное состояние никогда не изменится.</p><p>Однако в JDK не так много неизменяемых классов. Возьмем, например, класс <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Date.html"><code class="language-plaintext highlighter-rouge">Date</code></a>. Его состояние можно изменить с помощью метода <code class="language-plaintext highlighter-rouge">setTime()</code>.</p><p>Не знаю, почему разработчики JDK решили сделать эти два очень похожих класса по-разному. Однако я считаю, что дизайн изменяемого <code class="language-plaintext highlighter-rouge">Date</code> имеет много недостатков, в то время как неизменяемый <code class="language-plaintext highlighter-rouge">String</code> более соответствует объектно-ориентированной парадигме.</p><p>Более того, я считаю, что <strong>в идеальном объектно-ориентированном мире все классы должны быть неизменяемыми</strong>. К сожалению, иногда это технически невозможно из-за ограничений в JVM. Тем не менее, мы всегда должны стремиться к лучшему.</p><p>Это неполный список аргументов в пользу неизменяемости:</p><ul> <li><p>истинно неизменяемые объекты всегда являются потокобезопасными</p></li> <li><p>они помогают избежать временной связности</p></li> <li><p>их использование не оказывает побочных эффектов (без защитных копий)</p></li> <li><p>проблема изменяемости идентичности избегается</p></li> <li><p>они всегда имеют <a href="https://stackoverflow.com/questions/29842845/">атомарность сбоя</a></p></li> <li><p>они намного проще кэшировать</p></li> <li><p>они предотвращают NULL ссылки, которые являются плохими</p></li></ul><p>Давайте обсудим наиболее важные аргументы по одному.</p><p>Первый и наиболее очевидный аргумент заключается в том, что неизменяемые объекты являются потокобезопасными. Это означает, что несколько потоков могут получать доступ к одному и тому же объекту одновременно, не конфликтуя с другим потоком.</p><p>Если методы объекта не могут изменять его состояние, независимо от того, сколько из них и как часто они вызываются параллельно, они будут работать в своем собственном пространстве памяти в стеке.</p><p>Гоэтц и др. подробно объяснили преимущества неизменяемых объектов в своей очень известной книге “Java Concurrency in Practice” (настоятельно рекомендуется).</p><p>Вот пример временной связи (в коде выполняются два последовательных HTTP POST-запроса, где второй запрос содержит тело HTTP).</p><p>Этот код работает. Однако, следует помнить, что первый запрос должен быть настроен до того, как может произойти второй запрос. Если мы решим удалить первый запрос из скрипта, мы также удалим вторую и третью строку, и не получим никаких ошибок от компилятора.</p><p>Теперь скрипт сломан, хотя он компилировался без ошибок. В этом и заключается временная связность - в коде всегда есть скрытая информация, которую программист должен помнить. В этом примере мы должны помнить, что конфигурация для первого запроса также используется для второго.</p><p>Мы должны помнить, что второй запрос всегда должен оставаться вместе и выполняться после первого.</p><p>Если бы класс <code class="language-plaintext highlighter-rouge">Request</code> был неизменяемым, первый отрывок вообще не работал бы и был бы переписан так:</p><p>Теперь эти два запроса не связаны друг с другом. Мы можем безопасно удалить первый, и второй всё равно будет работать правильно. Вы можете указать на наличие дублирования кода. Да, мы должны избавиться от него и переписать код:</p><p>Видите ли, рефакторинг ничего не сломал, и у нас все еще нет временной связности. Первый запрос может быть безопасно удален из кода, не затрагивая второй.</p><p>Я надеюсь, что этот пример показывает, что код, работающий с неизменяемыми объектами, более читабелен и поддерживаем, потому что он не имеет временной связности.</p><p>Давайте попробуем использовать наш класс <code class="language-plaintext highlighter-rouge">Request</code> в новом методе (теперь он изменяемый):</p><p>Давайте попробуем выполнить два запроса — первый с методом GET и второй с методом POST:</p><p>Метод <code class="language-plaintext highlighter-rouge">post()</code> имеет “побочный эффект” - он вносит изменения в изменяемый объект <code class="language-plaintext highlighter-rouge">request</code>. В данном случае такие изменения не ожидаются. Мы ожидаем, что он выполнит POST-запрос и вернет его тело. Мы не хотим читать его документацию только для того, чтобы узнать, что за кулисами он также изменяет передаваемый ему в качестве аргумента запрос.</p><p>Само собой разумеется, такие побочные эффекты приводят к ошибкам и проблемам с поддержкой. Было бы намного лучше работать с неизменяемым <code class="language-plaintext highlighter-rouge">Request</code>.</p><p>В данном случае у нас не может быть никаких побочных эффектов. Никто не может изменить наш объект <code class="language-plaintext highlighter-rouge">request</code>, независимо от того, где он используется и насколько глубоко передается через стек вызовов методов.</p><p>Этот код абсолютно безопасен и не вызывает побочных эффектов.</p><p>Очень часто мы хотим, чтобы объекты были идентичными, если их внутренние состояния совпадают. Класс <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Date.html"><code class="language-plaintext highlighter-rouge">Date</code></a> является хорошим примером:</p><p>Есть два разных объекта; однако они равны друг другу, потому что их инкапсулированные состояния одинаковы. Это становится возможным благодаря их настраиваемой перегруженной реализации методов <code class="language-plaintext highlighter-rouge">equals()</code> и <code class="language-plaintext highlighter-rouge">hashCode()</code>.</p><p>Последствием такого удобного подхода, используемого с изменяемыми объектами, является то, что каждый раз при изменении состояния объекта меняется его идентичность.</p><p>Это может выглядеть естественно, пока вы не начнете использовать изменяемые объекты в качестве ключей в картах:</p><p>При изменении состояния объекта <code class="language-plaintext highlighter-rouge">date</code> мы не ожидаем, что он изменит свою идентичность. Мы не ожидаем потери записи в карте только потому, что изменено состояние ее ключа. Однако именно это происходит в приведенном выше примере.</p><p>Когда мы добавляем объект в карту, его <code class="language-plaintext highlighter-rouge">hashCode()</code> возвращает одно значение. Это значение используется <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html"><code class="language-plaintext highlighter-rouge">HashMap</code></a> для размещения записи во внутренней хэш-таблице. Когда мы вызываем <code class="language-plaintext highlighter-rouge">containsKey()</code>, хэш-код объекта отличается (поскольку он основан на его внутреннем состоянии), и <code class="language-plaintext highlighter-rouge">HashMap</code> не может найти его во внутренней хэш-таблице.</p><p>Это очень раздражающая и сложная для отладки побочная эффекты изменяемых объектов. Неизменяемые объекты полностью избегают этого.</p><p>Вот простой пример:</p><p>Очевидно, что объект класса <code class="language-plaintext highlighter-rouge">Stack</code> останется в поврежденном состоянии, если он вызывает исключение времени выполнения при переполнении. Его свойство <code class="language-plaintext highlighter-rouge">size</code> будет увеличиваться, в то время как <code class="language-plaintext highlighter-rouge">items</code> не получит новый элемент.</p><p>Неизменяемость предотвращает эту проблему. Объект никогда не будет оставаться в поврежденном состоянии, потому что его состояние изменяется только в его конструкторе. Конструктор либо завершится с ошибкой, отклоняя создание объекта, либо успешно завершится, создавая действительный неподвижный объект, которые никогда не изменяет свое инкапсулированное состояние.</p><p>Для получения дополнительной информации по этой теме прочитайте <a href="http://amzn.to/2cs4aiR"><em>Effective Java</em></a> от Joshua Bloch.</p><p>Существует несколько аргументов против неизменности.</p><ol> <li>«Обновление существующего объекта обходится дешевле, чем создание нового». Компания Oracle <a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/immutable.html">считает</a>, что «Влияние создания объекта часто переоценивается и может быть компенсировано некоторой эффективностью, связанной с неизменяемыми объектами. К ним относятся уменьшение накладных расходов, связанных с сборкой мусора, и устранение необходимости кода для защиты изменяемых объектов от повреждений». Я согласен.</li> </ol><p>Если у вас есть еще какие-то аргументы, пожалуйста, оставьте их ниже, и я постараюсь прокомментировать.</p><p>P.S. Проверьте <a href="http://www.takes.org">takes.org</a>, Java веб-фреймворк, состоящий полностью из неизменяемых объектов.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2023-11-28 at 15:21</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?19fbb713f25"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
