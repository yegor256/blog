<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="This article illustrates by example how immutability forces you to design small and cohesive objects, while mutability causes scope creep and tight coupling." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="How Immutability Helps"/> <meta name="twitter:description" property="og:description" content="This article illustrates by example how immutability forces you to design small and cohesive objects, while mutability causes scope creep and tight coupling."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2014/11/07/how-immutability-helps.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?19fbb713f25"/> <link rel="apple-touch-icon" href="/favicon.ico?19fbb713f25"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?19fbb713f25"/> <link rel="stylesheet" href="/css/icons.css?19fbb713f25"/> <link rel="canonical" href="https://www.yegor256.com/ru/2014/11/07/how-immutability-helps.html" /> <title>How Immutability Helps</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;392</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/research.html" title="My research directions and progress">Research</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">How Immutability Helps</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2014/11/07/how-immutability-helps.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>В нескольких недавних постах, включая “Getters/Setters. Evil. Period. Objects Should Be Immutable” и “Dependency Injection Containers are Code Polluters”, я всемирно назвал все изменяемые объекты с “сеттерами” (методы объекта, начинающиеся с <code class="language-plaintext highlighter-rouge">set</code>) злом. Моя аргументация в основном была основана на метафорах и абстрактных примерах. Однако, очевидно, это не было достаточно убедительно для многих из вас - я получил несколько запросов с просьбой предоставить более конкретные и практические примеры.</p><p>Таким образом, чтобы продемонстрировать мое крайне негативное отношение к “изменяемости с помощью сеттеров”, я взял существующую библиотеку на языке Java <a href="http://commons.apache.org/proper/commons-email/">commons-email</a> от Apache и переработал ее по-своему, без сеттеров и с учетом “объектного мышления”. Я выпустил свою библиотеку в рамках семьи <a href="http://www.jcabi.com">jcabi</a> - <a href="http://email.jcabi.com">jcabi-email</a>. Давайте посмотрим, какие преимущества мы получаем от “чистого” объектно-ориентированного и неизменяемого подхода, без геттеров.</p><p>Вот как будет выглядеть ваш код, если вы отправляете электронное письмо с помощью commons-email:</p><p>Вот как вы делаете то же самое с <a href="http://email.jcabi.com">jcabi-email</a>:</p><p>Я думаю, разница очевидна.</p><p>В первом примере вы имеете дело с монструозным классом, который может сделать все за вас, включая отправку вашего MIME-сообщения через SMTP, создание сообщения, настройку его параметров, добавление MIME-частей и т. д. Класс <a href="http://svn.apache.org/viewvc/commons/proper/email/tags/EMAIL_1_3_3/src/main/java/org/apache/commons/mail/Email.java?revision=1609295&amp;view=co"><code class="language-plaintext highlighter-rouge">Email</code></a> из библиотеки commons-email действительно огромный - 33 приватных свойства, более сотни методов, около двух тысяч строк кода. Сначала вы настраиваете класс с помощью набора сеттеров, а затем просите его отправить электронное письмо с помощью метода <code class="language-plaintext highlighter-rouge">send()</code>.</p><p>Во втором примере у нас есть семь объектов, созданных при помощи семи вызовов <code class="language-plaintext highlighter-rouge">new</code>. <code class="language-plaintext highlighter-rouge">Postman</code> отвечает за упаковку MIME-сообщения; <code class="language-plaintext highlighter-rouge">SMTP</code> отвечает за отправку его через SMTP; штампы (<code class="language-plaintext highlighter-rouge">StSender</code>, <code class="language-plaintext highlighter-rouge">StRecipient</code> и <code class="language-plaintext highlighter-rouge">StSubject</code>) отвечают за настройку MIME-сообщения перед доставкой; вложение <code class="language-plaintext highlighter-rouge">EnPlain</code> отвечает за создание MIME-части для сообщения, которое мы собираемся отправить. Мы создаем эти семь объектов, инкапсулируя один в другой, а затем просим почтальона отправить конверт с помощью метода <code class="language-plaintext highlighter-rouge">send()</code>.</p><p>С точки зрения пользователя, почти нет никаких проблем. <code class="language-plaintext highlighter-rouge">Email</code> - мощный класс с несколькими элементами управления - просто нажмите на нужный и задача будет выполнена. Однако с точки зрения разработчика класс <code class="language-plaintext highlighter-rouge">Email</code> - это кошмар. Главным образом потому, что класс очень большой и сложно поддерживать.</p><p><em>Поскольку класс настолько большой</em>, каждый раз, когда вы хотите расширить его, введя новый метод, вы сталкиваетесь с фактом, что делаете класс еще хуже - длиннее, менее связанным, менее читаемым, менее поддерживаемым и т. д. У вас есть ощущение, что вы копаетесь в чем-то грязном и что нет надежды сделать его более чистым. Я уверен, вы знакомы с этим ощущением - большинство устаревших приложений выглядят так. У них есть огромные многострочные “классы” (на самом деле программы на COBOL, написанные на Java), которые были унаследованы от нескольких поколений программистов перед вами. Когда вы начинаете, вы полны энергии, но через несколько минут прокрутки такого “класса” вы говорите: “к черту, это почти суббота”.</p><p><em>Поскольку класс настолько большой</em>, больше нет сокрытия данных или инкапсуляции - 33 переменные доступны более чем 100 методам. Что скрыто? Этот файл <code class="language-plaintext highlighter-rouge">Email.java</code> на самом деле является большим процедурным скриптом из 2000 строк, ошибочно названным “классом”. Ничего не скрыто, как только вы пересекаете границу класса, вызывая один из его методов. После этого у вас есть полный доступ ко всем данным, которые вам могут понадобиться. Почему это плохо? Хорошо, зачем нам вообще нужна инкапсуляция? Для защиты одного программиста от другого, так называемого защитного программирования. Когда я занят изменением темы MIME-сообщения, я хочу быть уверенным, что меня не помешает какая-то другая активность метода, который случайно меняет отправителя и касается моей темы. Инкапсуляция помогает нам ограничить область проблемы, в то время как этот класс <code class="language-plaintext highlighter-rouge">Email</code> делает точно противоположное.</p><p><em>Поскольку класс настолько большой</em>, его модульное тестирование еще сложнее, чем сам класс. Почему? Из-за множественных взаимозависимостей между его методами и свойствами. Чтобы протестировать <code class="language-plaintext highlighter-rouge">setCharset()</code>, вам нужно подготовить весь объект, вызвав несколько других методов, затем вам нужно вызвать <code class="language-plaintext highlighter-rouge">send()</code>, чтобы убедиться, что отправляемое сообщение действительно использует указанную кодировку. Таким образом, чтобы протестировать однострочный метод <code class="language-plaintext highlighter-rouge">setCharset()</code>, вы запускаете весь сценарий интеграционного тестирования отправки полного MIME-сообщения через SMTP. Очевидно, если что-то изменится в одном из методов, почти каждый тестовый метод будет затронут. Другими словами, тесты очень хрупкие, ненадежные и излишне сложные.</p><p>Я могу продолжать и продолжать с этим “<em>поскольку класс настолько большой</em>”, но я думаю, что очевидно, что маленький, связный класс всегда лучше большого. Это очевидно для меня, для вас и для любого объектно-ориентированного программиста. Но почему это не так очевидно для разработчиков Apache Commons Email? Я не думаю, что они глупые или непросвещённые. В чем же дело?</p><p>Так всегда происходит. Вы начинаете проектировать класс как нечто связное, прочное и небольшое. Ваши намерения очень положительные. Очень скоро вы понимаете, что есть что-то еще, что должно делать этот класс. Затем, что-то еще. Затем, еще больше.</p><p>Лучший способ сделать ваш класс все более и более мощным - это добавить сеттеры, которые вводят параметры конфигурации в класс, чтобы он мог обрабатывать их внутри, не так ли?</p><p>Это корневая причина проблемы! Корневая причина - наша способность <em>вставлять</em> данные в изменяемые объекты с помощью методов конфигурации, также известных как “сеттеры”. Когда объект изменяемый и позволяет нам добавлять сеттеры в любое время, мы будем делать это без ограничений.</p><p>Позвольте мне сказать это так - <em>изменяемые классы имеют тенденцию расти в размерах и терять связность</em>.</p><p>Если бы авторы commons-email сделали этот класс <code class="language-plaintext highlighter-rouge">Email</code> неизменяемым с самого начала, они не смогли бы добавить в него так много методов и инкапсулировать так много свойств. Они не смогли бы превратить его в чудовище. Почему? Потому что неизменяемый объект принимает состояние только через конструктор. Можете представить 33-аргументный конструктор? Конечно, нет.</p><p>Когда вы делаете свой класс неизменяемым с самого начала, вы вынуждены сохранять его связность, небольшие размеры, прочность и надежность. Потому что вы не можете инкапсулировать слишком много и не можете изменять то, что инкапсулировано. Просто два или три аргумента конструктора, и вы готовы.</p><p>Когда я разрабатывал <a href="https://github.com/jcabi/jcabi-email">jcabi-email</a>, я начал с небольшого и простого класса: <a href="https://github.com/jcabi/jcabi-email/blob/1.3/src/main/java/com/jcabi/email/Postman.java"><code class="language-plaintext highlighter-rouge">Postman</code></a>. Что ж, это интерфейс, так как я никогда не создаю классы без интерфейса. Итак, <code class="language-plaintext highlighter-rouge">Postman</code> - это… почтальон. Он доставляет сообщения другим людям. Сначала я создал его версию по умолчанию (я опускаю конструктор для краткости):</p><p>Хороший старт, работает. Что теперь? Что ж, <a href="http://docs.oracle.com/javaee/7/api/javax/jms/Message.html"><code class="language-plaintext highlighter-rouge">Message</code></a> сложно построить. Это сложный класс из JDK, который требует некоторых манипуляций, прежде чем он может стать красивым HTML-письмом. Поэтому я создал конверт, который будет создавать этот сложный объект для меня (обратите внимание, и <a href="https://github.com/jcabi/jcabi-email/blob/1.3/src/main/java/com/jcabi/email/Postman.java"><code class="language-plaintext highlighter-rouge">Postman</code></a>, и <a href="https://github.com/jcabi/jcabi-email/blob/1.3/src/main/java/com/jcabi/email/Envelope.java"><code class="language-plaintext highlighter-rouge">Envelope</code></a> являются неизменяемыми и аннотированы <a href="http://aspects.jcabi.com/apidocs-0.20/com/jcabi/aspects/Immutable.html">@Immutable</a> из <a href="http://aspects.jcabi.com/annotation-immutable.html">jcabi-aspects</a>).</p><p>Я также провожу рефакторинг <code class="language-plaintext highlighter-rouge">Postman</code>, чтобы он принимал конверт, а не сообщение.</p><p>Пока все идет хорошо. Теперь давайте попробуем создать простую реализацию <code class="language-plaintext highlighter-rouge">Envelope</code>.</p><p>Он работает, но пока не выполняет никаких полезных действий. Он только создает абсолютно пустое MIME-сообщение и возвращает его. Как насчет добавления темы и адресов <code class="language-plaintext highlighter-rouge">To:</code> и <code class="language-plaintext highlighter-rouge">From:</code> (обратите внимание, класс <a href="http://email.jcabi.com/apidocs-1.10/com/jcabi/email/Envelope.Mime.html"><code class="language-plaintext highlighter-rouge">MIME</code></a> также является неизменяемым)?</p><p>Выглядит правильно и работает. Но всё же слишком примитивно. Как насчёт <code class="language-plaintext highlighter-rouge">CC:</code> и <code class="language-plaintext highlighter-rouge">BCC:</code>? А что насчёт текста письма? Как насчёт прикреплённых PDF файлов? Что, если я хочу указать кодировку сообщения? Как насчёт <code class="language-plaintext highlighter-rouge">Reply-To</code>?</p><p>Могу ли я добавить все эти параметры в конструктор? Помните, что класс является неизменяемым, и я не могу добавить метод <code class="language-plaintext highlighter-rouge">setReplyTo()</code>. Мне нужно передать аргумент <code class="language-plaintext highlighter-rouge">replyTo</code> в его конструктор. Это невозможно, потому что у конструктора будет слишком много аргументов, и никто не сможет его использовать.</p><p>Ну, я начал задумываться: как мы можем разбить концепцию “конверта” на более мелкие концепции — и вот что я придумал. Как настоящий конверт в реальной жизни, мой объект <code class="language-plaintext highlighter-rouge">MIME</code> будет иметь марки. Марки будут отвечать за настройку объекта <code class="language-plaintext highlighter-rouge">Message</code> (снова, <a href="https://github.com/jcabi/jcabi-email/blob/1.3/src/main/java/com/jcabi/email/Stamp.java"><code class="language-plaintext highlighter-rouge">Stamp</code></a> является неизменяемым, так же как и все его реализации):</p><p>Теперь я могу упростить мой класс <a href="https://github.com/jcabi/jcabi-email/blob/1.3/src/main/java/com/jcabi/email/Envelope.java"><code class="language-plaintext highlighter-rouge">MIME</code></a> до следующего:</p><p>Теперь я создам печати для темы, для <code class="language-plaintext highlighter-rouge">Кому:</code>, для <code class="language-plaintext highlighter-rouge">От:</code>, для <code class="language-plaintext highlighter-rouge">Копия:</code>, для <code class="language-plaintext highlighter-rouge">Скрытая копия:</code>, и так далее. Столько печатей, сколько мне нужно. Класс <code class="language-plaintext highlighter-rouge">MIME</code> останется таким же - небольшим, связным, читаемым, надежным и т.д.</p><p>Важно здесь то, почему я решил провести рефакторинг, когда класс был относительно небольшим. Действительно, я начал беспокоиться о этих классах печатей, когда мой класс <code class="language-plaintext highlighter-rouge">MIME</code> был всего 25 строк.</p><p>Вот именно суть этой статьи - <em>неизменяемость заставляет вас проектировать маленькие и связные объекты</em>.</p><p>Без неизменяемости я пошел бы по тому же пути, что и commons-email. Мой класс <code class="language-plaintext highlighter-rouge">MIME</code> стал бы все больше и рано или поздно стал бы таким же большим, как <code class="language-plaintext highlighter-rouge">Email</code> из commons-email. Единственное, что остановило меня, - это необходимость провести рефакторинг, потому что я не мог передать все аргументы через конструктор.</p><p>Без неизменяемости у меня не было бы такого стимула, и я бы сделал то же самое, что и разработчики Apache с commons-email - раздул класс и превратил его в неподдерживаемое чудовище.</p><p>Вот <a href="http://email.jcabi.com">jcabi-email</a>. Надеюсь, этот пример был достаточно иллюстративным и что вы начнете писать более чистый код с помощью неизменяемых объектов.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2023-11-28 at 15:37</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?19fbb713f25"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
