<!doctypehtml><html xmlns="http://www.w3.org/1999/xhtml"lang="en-US"xml:lang="en-US"itemscope=""itemtype="http://schema.org/WebSite"><meta charset="utf-8"><meta name="description"content="Sometimes you might be tempted to use a two-stage construction for your object. However, I suggest reevaluating your design principles if you feel such an inclination."><meta name="keywords"content=""><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><meta name="google-site-verification"content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8"><meta name="author"content="Yegor Bugayenko"><meta name="og:site_name"content="Yegor Bugayenko"><meta name="og:type"content="article"><meta name="og:locale"content="en_US"><meta name="twitter:account_id"content="4503599630178231"><meta name="twitter:creator"content="@yegor256"><meta name="twitter:site"content="@yegor256"><meta name="twitter:title"property="og:title"content="Is Two-Step Initialization a Solution or a Symptom?"><meta name="twitter:description"property="og:description"content="Sometimes you might be tempted to use a two-stage construction for your object. However, I suggest reevaluating your design principles if you feel such an inclination."><meta name="twitter:url"property="og:url"content="https://www.yegor256.com/ru/2023/08/08/two-step-initialization.html"><meta name="telegram:channel"content="AAAAAEJFMRzsRTRxM3ec6A"><link rel="search"type="application/opensearchdescription+xml"href="/opensearch.xml"title="yegor256"><link rel="shortcut icon"href="/favicon.ico?522722f4f92"><link rel="apple-touch-icon"href="/favicon.ico?522722f4f92"><link rel="alternate"type="application/rss+xml"title="RSS for yegor256.com"href="https://www.yegor256.com/rss.xml"><link rel="stylesheet"href="/css/layout.css?522722f4f92"><link rel="stylesheet"href="/css/icons.css?522722f4f92"><link rel="canonical"href="https://www.yegor256.com/ru/2023/08/08/two-step-initialization.html"><title>Is Two-Step Initialization a Solution or a Symptom?</title><div class="wrapper"><aside class="header-toggle unprintable"id="header-toggle"title="Show the menu"onclick='$("#header").show(),$("#header-toggle").hide()'>&#9776;</aside><header class="header"id="header"><div class="face"><a href="/about-me.html#form"class="sub"title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html"style="position:relative"><img src="/images/face-256x256.jpg"class="photo"alt="Yegor Bugayenko"></a></div><nav><ul class="menu social notranslate"><li><a href="https://twitter.com/intent/follow?screen_name=yegor256"rel="nofollow"title="Follow me on Twitter"><i class="icon icon-twitter notranslate"aria-hidden="true"></i></a><li><a href="/rss.xml"rel="nofollow"title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://github.com/yegor256"rel="nofollow"title="My GitHub profile"><i class="icon icon-github notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="http://stackoverflow.com/users/187141/yegor256"rel="nofollow"title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.facebook.com/yegor256"rel="nofollow"title="Follow me on Facebook"><i class="icon icon-facebook notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://instagram.com/yegor256"rel="nofollow"title="Follow me on Instagram"><i class="icon icon-instagram notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.linkedin.com/in/yegor256"rel="nofollow"title="My LinkedIn profile"><i class="icon icon-linkedin notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.youtube.com/c/yegor256?sub_confirmation=1"rel="nofollow"title="My Youtube video channel"><i class="icon icon-youtube notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.pinterest.com/yegor256/"rel="nofollow"title="My Pinterest boards"><i class="icon icon-pinterest notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://angel.co/yegor256"rel="nofollow"title="My AngelList profile"><i class="icon icon-angellist notranslate"aria-hidden="true"></i></a><li><a href="https://soundcloud.com/yegor256"rel="nofollow"title="My podcast"><i class="icon icon-podcast notranslate"aria-hidden="true"></i></a><li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721"rel="nofollow"title="My iTunes podcast"><i class="icon icon-itunes notranslate"aria-hidden="true"></i></a><li><a href="https://t.me/yegor256news"rel="nofollow"title="My Telegram public channel"><i class="icon icon-telegram notranslate"aria-hidden="true"></i></a><li><a href="mailto:blog@yegor256.com"rel="nofollow"title="Email me any time"><i class="icon icon-mail notranslate"aria-hidden="true"></i></a></ul><ul class="menu"><li><a href="/"title="Home page">Home</a><li><a href="/best.html"title="Best articles to read">12&#160;Best</a><li><a href="/contents.html"title="The contents of the entire blog">All&#160;390</a><li><a href="/teaching.html"title="My courses and lectures">Teaching</a><li><a href="/talks.html"title="Future and past conference talks">Talks</a><li><a href="/books.html"title="The books I wrote">Books</a><li><a href="/research.html"title="My research directions and progress">Research</a><li><a href="/pets.html"title="My loved pet projects">Pets</a><li><a href="/testimonials.html"title="What some people say about me">Testimonials</a><li><a href="/shift-m.html"title="Audio podcast about project management">Shift-M</a><li><a href="/paintings.html"title="My paintings for sale">Art</a><li><a href="https://ru.yegor256.com/"title="Немного на русском языке о политике в России, Украине и мире">Политика</a></ul></nav><div class="search"><form action="https://www.google.com/search"itemprop="potentialAction"itemscope=""itemtype="http://schema.org/SearchAction"><meta itemprop="target"content="https://www.google.com/search?q={q}"><input name="sitesearch"value="yegor256.com"type="hidden"> <input itemprop="query-input"id="search-query"class="field field-text"required="required"onfocus='$(".google").css("visibility","visible")'name="q"placeholder="Search..."autocomplete="off"> <input type="image"src="/images/google-search-icon.svg"class="google"title="Search via Google"alt="Search via Google"></form></div><div class="hot"><ul></ul></div></header></div><section itemscope=""itemtype="http://schema.org/BlogPosting"><div class="wrapper"><header><h1 itemprop="name headline mainEntityOfPage">Is Two-Step Initialization a Solution or a Symptom?</h1></header><article class="main"itemprop="articleBody"style="font-family:sans-serif;font-size:.9em;line-height:1.2em"><p style="color:#c42c00">The following text is a <em>partial</em> translation of the <a href="https://www.yegor256.com/2023/08/08/two-step-initialization.html">original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:<p>Иногда может показаться целесообразным выполнить дополнительные инициализационные шаги для объекта после завершения его конструктора. Однако я считаю, что такие требования указывают на недостатки в основном проектировании, такие как изменяемость объекта, хрупкость базового класса, нарушение слоистости и несосредоточенность абстракции. Конструктор должен быть достаточно хорошим для всех сценариев. Если это не так, переделайте объект.<p>Обычно это происходит так (я нашел это в <a href="https://github.com/apache/kafka/blob/e0b7499103df9222140cdbf7047494d92913987e/clients/src/main/java/org/apache/kafka/common/security/oauthbearer/internals/secured/RefreshingHttpsJwks.java">Apache Kafka</a>):<p>Ожидается, что объект используется следующим образом:<p>Могут быть практические обоснования для такой <em>двухэтапной конструкции</em>, которая, <a href="https://learn.microsoft.com/en-us/cpp/mfc/one-stage-and-two-stage-construction-of-objects?view=msvc-170">в соответствии с Microsoft</a>, является «всегда более безопасным» подходом к созданию объектов. Однако я убежден, что каждое из этих обоснований указывает на недостаточно проработанный дизайн и должно служить катализатором для рефакторинга.<p>Рассмотрим Java-класс <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html">auto-closeable</a>, который открывает поток в своем конструкторе и затем ожидает его закрытия в методе <code class="language-plaintext highlighter-rouge">close()</code>.<p>Однако, если исключение времени выполнения возникнет в конструкторе, поток не закроется и ресурс <a href="https://stackoverflow.com/a/29243066/187141">будет утекать</a>:<p>Метод <code class="language-plaintext highlighter-rouge">close()</code> не будет вызван оператором <a href="https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html">try-with-resources</a>, так как объект не будет полностью создан и его инициализация не будет завершена. Однако, даже если инициализация не будет завершена, экземпляр <code class="language-plaintext highlighter-rouge">FileInputStream</code> выполнит часть своей работы: он откроет файл. Однако, он никогда не закроет его.<p>Двухшаговая инициализация может быть решением:<p>Теперь код можно использовать следующим образом, что действительно безопасно, потому что поток всегда будет закрыт:<p>Несмотря на то, что это может быть хорошим обходным путем, это только прикрытие конструктивного недостатка: изменяемость атрибута. Лучшим решением было бы избавиться от изменяемости «Book» и удалить метод «init()».<p>Таким образом, <a href="https://en.wikipedia.org/wiki/Initialization_%28programming%29">инициализация</a> потока должна выполняться вне объекта «Book», а затем передаваться ему в качестве аргумента конструктора (обратите внимание на модификатор <code class="language-plaintext highlighter-rouge">final</code> поля <code class="language-plaintext highlighter-rouge">in</code>).<p>Затем, вот как мы можем использовать это:<p>Теперь поток и книга определенно будут закрыты.<p>Коренная причина проблемы здесь связана с изменяемостью атрибута <code class="language-plaintext highlighter-rouge">in</code>, что создает потенциал для утечки ресурсов. Если бы мы согласились заранее, что каждый объект должен быть неизменяемым, эта проблема не возникла бы в первую очередь. Нам не потребовалось бы временное решение, наподобие двухэтапной инициализации, потому что мы не столкнулись бы с классом, в котором атрибут может оставаться неинициализированным. Кажется, что это пример еще одного подтверждения преимуществ неизменяемости объектов.<p>Рассмотрим этот родительский класс, с неизменяемым атрибутом <code class="language-plaintext highlighter-rouge">title</code>:<p>Теперь давайте расширим его (снова, атрибут <code class="language-plaintext highlighter-rouge">author</code> неизменяемый):<p>Что, по вашему мнению, будет напечатано после выполнения следующих действий?<p>This is what:<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Title: Object Thinking
Author: null
</code></pre></div></div><p>Почему <code class="language-plaintext highlighter-rouge">author</code> выводится как <code class="language-plaintext highlighter-rouge">null</code>, когда мы передали строку <code class="language-plaintext highlighter-rouge">"David West"</code> в конструктор? Причина в том, что <code class="language-plaintext highlighter-rouge">super()</code>, конструктор родительского класса, был вызван до инициализации <code class="language-plaintext highlighter-rouge">this.author</code>. Конструктор класса <code class="language-plaintext highlighter-rouge">Product</code> вызвал свой собственный <a href="https://ru.wikipedia.org/wiki/%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F">виртуальный</a> метод <code class="language-plaintext highlighter-rouge">print()</code>, который был переопределен в производном классе <code class="language-plaintext highlighter-rouge">Book</code>. Эта проблема может быть более общепринятой именно как проблема “<a href="https://ru.wikipedia.org/wiki/%D0%A5%D1%80%D1%83%D0%BF%D0%BA%D0%B8%D0%B9_%D0%B1%D0%B0%D0%B7%D0%BE%D0%B2%D1%8B%D0%B9_%D0%BA%D0%BB%D0%B0%D1%81%D1%81">хрупкого базового класса</a>”: базовый класс вызывает свой собственный метод, ожидая, что он будет работать как определено, но этот метод неожиданно заменяется другой реализацией в производном классе, что приводит к непреднамеренному и неправильному поведению. Такая возможность замены метода делает базовый класс хрупким.<p>Использование двухфазовой конструкции может решить эту проблему, сохраняя инициализацию атрибутов в конструкторе, а “печатающую” функциональность переносит в новый метод <code class="language-plaintext highlighter-rouge">init()</code>. Однако такой подход только замаскирует основной дизайнерский недостаток: внутреннюю хрупкость класса.<p>Более всестороннее решение двухстороннее. Во-первых, поддерживайте конструкторы без кода, как ранее предлагалось. Во-вторых, отдавайте предпочтение <a href="https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%BC%D0%BF%D0%BE%D0%B7%D0%B8%D1%86%D0%B8%D1%8F_%D0%B2%D0%BC%D0%B5%D1%81%D1%82%D0%BE_%D0%BD%D0%B0%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F">композиции вместо наследования</a>, как также ранее рекомендовалось. Вот как:<p>Теперь оба класса помечены как <code class="language-plaintext highlighter-rouge">final</code>, что технически делает невозможным переопределение любого из их методов. Вместо расширения <code class="language-plaintext highlighter-rouge">Product</code>, класс <code class="language-plaintext highlighter-rouge">Book</code> инкапсулирует экземпляр этого класса. Метод <code class="language-plaintext highlighter-rouge">print()</code> в классе <code class="language-plaintext highlighter-rouge">Book</code> отвечает за функциональность печати, передавая часть этой ответственности методу <code class="language-plaintext highlighter-rouge">product.print()</code>. Такой дизайн становится единственным жизнеспособным вариантом, если мы соглашаемся с самого начала, что все конструкторы должны оставаться без кода и что наследование реализации недопустимо.<p>Если вы достаточно долго программировали на Java, то, несомненно, вам будет знаком этот подход к проектированию.<p>Здесь конструктор присваивает значения по умолчанию четырем атрибутам объекта, а метод <code class="language-plaintext highlighter-rouge">init()</code> впоследствии обновляет их на основе значений из объекта передачи данных “configuration” (DTO). Этот способ инициализации объекта может показаться более привлекательным, чем последовательность вызовов сеттеров, поскольку он гарантирует, что все необходимые атрибуты присваиваются одновременно и ни один из них не пропускается. Такая гарантия не гарантируется при использовании отдельных сеттеров. Кроме того, объект передачи данных (DTO) может быть автоматически заполнен из XML- или JSON-файла, что при передаче в метод <code class="language-plaintext highlighter-rouge">init()</code> еще более упрощает код.<p>Однако это только замаскировывает основную конструктивную ошибку: класс слишком объемный. Здесь дело не в количестве строк кода, а в множестве внешних элементов, которые он пытается абстрагировать: интернет-адрес, TCP-порт, строка входа, пароль и, возможно, еще много чего в будущем. В настоящее время <code class="language-plaintext highlighter-rouge">Config</code> DTO достаточно маленький, но он, кажется, заложен для будущего расширения, что соблазняет программистов расширять его по своему усмотрению. С увеличением размера <code class="language-plaintext highlighter-rouge">Config</code> будет расти и количество атрибутов в <code class="language-plaintext highlighter-rouge">Database</code>. Скорее всего, они скоро перестанут совпадать. Со временем может возникнуть сложность в определении, готов ли объект <code class="language-plaintext highlighter-rouge">Database</code> к работе после его создания, или требуется предварительный вызов <code class="language-plaintext highlighter-rouge">init()</code>. Более того, будет ли достаточным просто вызов <code class="language-plaintext highlighter-rouge">init()</code> для полного использования объекта?<p>Если бы мы изначально согласились, что наши объекты не должны инкапсулировать более трех атрибутов, как ранее предложено, мы бы провели рефакторинг этого класса. Метод <code class="language-plaintext highlighter-rouge">init()</code> был бы удален, и все необходимые параметры передавались бы через его основные или вторичные конструкторы. Также полезным было бы сохранение всех атрибутов в неизменяемом состоянии.<p>Кажется, что даже шаблон проектирования <a href="https://ru.wikipedia.org/wiki/%D0%A1%D1%82%D1%80%D0%BE%D0%B8%D1%82%D0%B5%D0%BB%D1%8C_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)">Строитель</a> был бы лучшим решением, чем метод <code class="language-plaintext highlighter-rouge">init()</code> в этом конкретном случае.<p>Рассмотрим следующие два класса Java, которые зависят друг от друга:<p>Ясно, что невозможно создать экземпляр либо <code class="language-plaintext highlighter-rouge">Book</code>, либо <code class="language-plaintext highlighter-rouge">Order</code>, так как каждый из них требует предварительного создания другого. Решением может быть двухфазовая конструкция с возможностью изменения атрибутов и использованием сеттеров.<p>Теперь их можно создавать:<p>Однако этот дизайн имеет значительный недостаток: объекты <code class="language-plaintext highlighter-rouge">order</code> и <code class="language-plaintext highlighter-rouge">book</code> остаются неполными до вызова соответствующих методов <code class="language-plaintext highlighter-rouge">init()</code>. По мере разработки кода исходный автор понимает правильную последовательность вызовов методов: сначала конструктор, затем сеттер, и только потом метод <code class="language-plaintext highlighter-rouge">init()</code>. Однако в будущем, когда другие изменят код, это временное связывание между вызовами методов может быть легко упущено. Ненамеренный вызов <code class="language-plaintext highlighter-rouge">init()</code> перед сеттером может привести к ошибкам времени выполнения, которые сложно диагностировать.<p>Основная проблема здесь связана с нарушением принципа слоистости, присутствующего в дизайне как <code class="language-plaintext highlighter-rouge">Book</code>, так и <code class="language-plaintext highlighter-rouge">Order</code>: они взаимозависимы. Если я правильно помню, Мартин Фаулер утверждал, что “слою разрешается обращаться только к слоям ниже него”. В контексте нашего дизайна книги и заказа нет четкого разграничения этих слоев: невозможно определить, какой из них является основополагающим для другого. Проблемы с инициализацией являются только проявлениями этой проблемы, и двухэтапная инициализация служит скорее временным решением, а не реальным решением.<p>Я не знаю, как можно улучшить этот код напрямую. Вероятно, всю архитектуру необходимо тщательно пересмотреть, с введением более соответствующих абстракций вместо <code class="language-plaintext highlighter-rouge">Book</code> и <code class="language-plaintext highlighter-rouge">Order</code>.<p>Кажется, что двухэтапная инициализация на самом деле не решает проблемы, а лишь временно их маскирует. Хотя вы можете иметь методы <code class="language-plaintext highlighter-rouge">init()</code> в ваших объектах, они выглядят как флаги с надписью “Я не смог правильно спроектировать этот класс!”.<p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2023-11-18 at 05:29</article></div><div class="wrapper"><footer class="footer"><p>&copy; <span itemscope=""itemprop="copyrightHolder"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span> </span>2014&ndash;<span itemprop="copyrightYear">2023</span></footer></div></section><div class="wrapper unprintable"style="text-align:center;margin-top:2em"><a href="https://www.sixnines.io/h/3ba1652f"><img src="//www.sixnines.io/b/3ba1652f?style=flat"alt="sixnines availability badge"></a>&nbsp; <a href="https://github.com/yegor256/blog/stargazers"><img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square"alt="GitHub stars"></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script><script src="/js/all.js?522722f4f92"></script><script>var disqus_shortname="yegor256"</script><script id="dsq-count-scr"src="//yegor256.disqus.com/count.js"async="async"></script><script>((e,a,t,g,n)=>{e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),n=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",n.parentNode.insertBefore(g,n)})(window,document,"script"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script><script>Cd=document,Cr="&"+Math.random(),Cp="&s=1",Cd.cookie="b=b",Cd.cookie&&(Cp+="&c=1"),Cp+="&t="+(new Date).getTimezoneOffset(),self!=top&&(Cp+="&f=1")</script><script>navigator.javaEnabled()&&(Cp+="&j=1")</script><script>"undefined"!=typeof screen&&(Cp+="&w="+screen.width+"&h="+screen.height+"&d="+(screen.colorDepth||screen.pixelDepth))</script><script>Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+"&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+"' border='0' width='1' height='1'/>")</script><script type="application/ld+json">{ "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] }</script>