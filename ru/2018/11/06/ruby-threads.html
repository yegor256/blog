<!doctypehtml><html xmlns="https://www.w3.org/1999/xhtml"lang="en-US"xml:lang="en-US"itemscope=""itemtype="http://schema.org/WebSite"><meta charset="utf-8"><meta name="description"content="Do you test your Ruby classes for thread safety? If you do, you may find this new Ruby gem useful. It helps you start multiple threads, run the code inside, and validate the output."><meta name="keywords"content=""><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><meta name="google-site-verification"content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8"><meta name="author"content="Yegor Bugayenko"><meta name="og:site_name"content="Yegor Bugayenko"><meta name="og:type"content="article"><meta name="og:locale"content="en_US"><meta name="twitter:account_id"content="4503599630178231"><meta name="twitter:creator"content="@yegor256"><meta name="twitter:site"content="@yegor256"><meta name="twitter:title"property="og:title"content="Do You Test Ruby Code for Thread Safety?"><meta name="twitter:description"property="og:description"content="Do you test your Ruby classes for thread safety? If you do, you may find this new Ruby gem useful. It helps you start multiple threads, run the code inside, and validate the output."><meta name="twitter:url"property="og:url"content="https://www.yegor256.com/ru/2018/11/06/ruby-threads.html"><meta name="telegram:channel"content="AAAAAEJFMRzsRTRxM3ec6A"><link rel="search"type="application/opensearchdescription+xml"href="/opensearch.xml"title="yegor256"><link rel="shortcut icon"href="/favicon.ico?3be988b2c92"><link rel="apple-touch-icon"href="/favicon.ico?3be988b2c92"><link rel="alternate"type="application/rss+xml"title="RSS for yegor256.com"href="https://www.yegor256.com/rss.xml"><link rel="stylesheet"href="/css/layout.css?3be988b2c92"><link rel="stylesheet"href="/css/icons.css?3be988b2c92"><link rel="canonical"href="https://www.yegor256.com/ru/2018/11/06/ruby-threads.html"><title>Do You Test Ruby Code for Thread Safety?</title><div class="wrapper"><aside class="header-toggle unprintable"id="header-toggle"title="Show the menu"onclick='$("#header").show(),$("#header-toggle").hide()'>&#9776;</aside><header class="header"id="header"><div class="face"><a href="/about-me.html#form"class="sub"title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html"style="position:relative"><img src="/images/santa-hat.svg"alt="Santa hat"style="position:absolute;width:115px;left:-30px;top:-120px"> <img src="/images/face-256x256.jpg"class="photo"alt="Yegor Bugayenko"></a></div><nav><ul class="menu social notranslate"><li><a href="https://twitter.com/intent/follow?screen_name=yegor256"rel="nofollow"title="Follow me on Twitter"><i class="icon icon-twitter notranslate"aria-hidden="true"></i></a><li><a href="/rss.xml"rel="nofollow"title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://github.com/yegor256"rel="nofollow"title="My GitHub profile"><i class="icon icon-github notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="http://stackoverflow.com/users/187141/yegor256"rel="nofollow"title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.facebook.com/yegor256"rel="nofollow"title="Follow me on Facebook"><i class="icon icon-facebook notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://instagram.com/yegor256"rel="nofollow"title="Follow me on Instagram"><i class="icon icon-instagram notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.linkedin.com/in/yegor256"rel="nofollow"title="My LinkedIn profile"><i class="icon icon-linkedin notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.youtube.com/c/yegor256?sub_confirmation=1"rel="nofollow"title="My Youtube video channel"><i class="icon icon-youtube notranslate"aria-hidden="true"></i></a><li><a href="https://soundcloud.com/yegor256"rel="nofollow"title="My podcast"><i class="icon icon-podcast notranslate"aria-hidden="true"></i></a><li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721"rel="nofollow"title="My iTunes podcast"><i class="icon icon-itunes notranslate"aria-hidden="true"></i></a><li><a href="https://t.me/yegor256news"rel="nofollow"title="My Telegram public channel"><i class="icon icon-telegram notranslate"aria-hidden="true"></i></a><li><a href="mailto:blog@yegor256.com"rel="nofollow"title="Email me any time"><i class="icon icon-mail notranslate"aria-hidden="true"></i></a></ul><ul class="menu"><li><a href="/"title="Home page">Home</a><li><a href="/best.html"title="Best articles to read">12&#160;Best</a><li><a href="/contents.html"title="The contents of the entire blog">All&#160;395</a><li><a href="/teaching.html"title="My courses and lectures">Teaching</a><li><a href="/talks.html"title="Future and past conference talks">Talks</a><li><a href="/books.html"title="The books I wrote">Books</a><li><a href="/research.html"title="My research directions and progress">Research</a><li><a href="/pets.html"title="My loved pet projects">Pets</a><li><a href="/testimonials.html"title="What some people say about me">Testimonials</a><li><a href="/shift-m.html"title="Audio podcast about project management">Shift-M</a><li><a href="/paintings.html"title="My paintings for sale">Art</a><li><a href="https://ru.yegor256.com/"title="Немного на русском языке о политике в России, Украине и мире">Политика</a></ul></nav><div class="search"><form action="https://www.google.com/search"itemprop="potentialAction"itemscope=""itemtype="http://schema.org/SearchAction"><meta itemprop="target"content="https://www.google.com/search?q={q}"><input name="sitesearch"value="yegor256.com"type="hidden"> <input itemprop="query-input"id="search-query"class="field field-text"required="required"onfocus='$(".google").css("visibility","visible")'name="q"placeholder="Search..."autocomplete="off"> <input type="image"src="/images/google-search-icon.svg"class="google"title="Search via Google"alt="Search via Google"></form></div><div class="hot"><ul></ul></div></header></div><section itemscope=""itemtype="http://schema.org/BlogPosting"><div class="wrapper"><header><h1 itemprop="name headline mainEntityOfPage">Do You Test Ruby Code for Thread Safety?</h1></header><article class="main"itemprop="articleBody"style="font-family:sans-serif;font-size:.9em;line-height:1.2em"><p style="color:#c42c00">The following text is a <em>partial</em> translation of the <a href="https://www.yegor256.com/2018/11/06/ruby-threads.html">original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:<p>Вы являетесь разработчиком Ruby? Если да, то я уверен, что у вас есть очень смутное представление о том, что такое параллелизм и потокобезопасность. Не обижайтесь, но именно это я понял, работая с кодом на Ruby и общаясь с программистами Ruby за последние полгода. Я активно пишу на Ruby в последнее время и мне нравится язык и экосистема, сопутствующая ему. Zold, экспериментальная криптовалюта, которую мы создаем, практически полностью написана на Ruby. Что это вам говорит? Мне нравится Ruby. Но когда речь заходит о параллелизме, есть пустые места. Очень много.<p>Взгляните на этот класс Ruby:<p>Это простой веб-сервер. Он работает — попробуйте запустить его так (вам понадобится установленный Ruby 2.3+).<p>Затем откройте <code class="language-plaintext highlighter-rouge">http://localhost:4567</code> и вы увидите счетчик. Обновите страницу, и счетчик увеличится. Попробуйте снова. Это работает. Счетчик находится в файле <code class="language-plaintext highlighter-rouge">idx.txt</code> и является, по сути, глобальной переменной, которую мы увеличиваем при каждом HTTP-запросе.<p>Давайте создадим модульный тест для этого, чтобы убедиться, что он автоматически тестируется:<p>ОК, это не юнит-тест, скорее, это интеграционный тест. Сначала мы запускаем веб-сервер в отдельном потоке. Затем мы ждем одну секунду, чтобы этому потоку было достаточно времени для инициализации сервера. Я знаю, это очень неэстетичный подход, но у меня нет ничего лучше для этого небольшого примера. Затем мы отправляем HTTP-запрос и сравниваем его с ожидаемым числом 1. Наконец, мы останавливаем веб-сервер.<p>Пока все идет хорошо. Теперь вопрос в том, что произойдет, когда к серверу будет отправлено много запросов? Будет ли он по-прежнему возвращать правильные последовательные числа? Давайте проверим:<p>Здесь мы делаем тысячу запросов и помещаем все полученные числа в массив. Затем мы применяем функцию <code class="language-plaintext highlighter-rouge">uniq</code> к массиву и считаем количество его элементов. Если их количество равно тысяче, значит все работает правильно и мы получили список последовательных, уникальных чисел. Я только что проверил это и оно работает.<p>Но мы делаем запросы один за другим, поэтому наш сервер не имеет никаких проблем. Мы не делаем запросы одновременно. Они строго следуют друг за другом. Давайте попробуем использовать несколько дополнительных потоков для симуляции параллельного выполнения HTTP-запросов.<p>Прежде всего, мы сохраняем список чисел в <a href="http://ruby-concurrency.github.io/concurrent-ruby/master/Concurrent/Set.html"><code class="language-plaintext highlighter-rouge">Concurrent::Set</code></a>, который является потокобезопасной версией Ruby <a href="http://ruby-doc.org/stdlib-2.4.0/libdoc/set/rdoc/Set.html"><code class="language-plaintext highlighter-rouge">Set</code></a>. Во-вторых, мы запускаем пять фоновых потоков, каждый из которых делает 200 HTTP-запросов. Они все выполняются параллельно, и мы ждем их завершения, вызывая <code class="language-plaintext highlighter-rouge">join</code> для каждого из них. Наконец, мы извлекаем числа из Set и проверяем правильность списка.<p>Неудивительно, что это не удалось.<p>Конечно, вы знаете почему. Потому что реализация не является <em>потокобезопасной</em>. Когда один поток читает файл, другой пишет в него. В конечном итоге, и очень скоро, они сталкиваются, и содержимое файла нарушается. Чем больше потоков мы используем в тесте, тем менее точным будет результат.<p>Чтобы упростить этот тип тестирования, я создал <a href="https://github.com/yegor256/threads">threads</a>, простой Ruby-гем. Вот как это работает:<p>Это всё. Эта одна строка с <code class="language-plaintext highlighter-rouge">Threads.new()</code> заменяет все остальные строки, где нам нужно создавать потоки, убедиться, что они начинаются одновременно, а затем собирать их результаты и убедиться, что их трассы стека видны в консоли, если они “падают” (по умолчанию, журнал ошибок фонового потока не виден).<p>Попробуйте этот gem в своих проектах, он уже довольно хорошо протестирован, и я использую его во всех своих тестах параллелизма.<p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2023-12-27 at 14:03</article></div><div class="wrapper"><footer class="footer"><p>&copy; <span itemscope=""itemprop="copyrightHolder"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span> </span>2014&ndash;<span itemprop="copyrightYear">2023</span></footer></div></section><div class="wrapper unprintable"style="text-align:center;margin-top:2em"><a href="https://www.sixnines.io/h/3ba1652f"><img src="//www.sixnines.io/b/3ba1652f?style=flat"alt="sixnines availability badge"></a>&nbsp; <a href="https://github.com/yegor256/blog/stargazers"><img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square"alt="GitHub stars"></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script><script src="/js/all.js?3be988b2c92"></script><script>var disqus_shortname="yegor256"</script><script id="dsq-count-scr"src="//yegor256.disqus.com/count.js"async="async"></script><script>((e,a,t,g,n,c)=>{e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,n=a.createElement(t),c=a.getElementsByTagName(t)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(n,c)})(window,document,"script","ga"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script><script>Cd=document,Cr="&"+Math.random(),Cp="&s=1",Cd.cookie="b=b",Cd.cookie&&(Cp+="&c=1"),Cp+="&t="+(new Date).getTimezoneOffset(),self!=top&&(Cp+="&f=1")</script><script>navigator.javaEnabled()&&(Cp+="&j=1")</script><script>"undefined"!=typeof screen&&(Cp+="&w="+screen.width+"&h="+screen.height+"&d="+(screen.colorDepth||screen.pixelDepth))</script><script>Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+"&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+"' border='0' width='1' height='1'/>")</script><script type="application/ld+json">{ "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] }</script>