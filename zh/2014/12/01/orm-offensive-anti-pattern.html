<!doctypehtml><html xmlns="https://www.w3.org/1999/xhtml"lang="en-US"xml:lang="en-US"itemscope=""itemtype="http://schema.org/WebSite"><meta charset="utf-8"><meta name="description"content="Object-relational mapping is a design pattern that violates encapsulation, one of the fundamental principles of OOP, but what is a possible alternative to it?"><meta name="keywords"content=""><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><meta name="google-site-verification"content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8"><meta name="author"content="Yegor Bugayenko"><meta name="og:site_name"content="Yegor Bugayenko"><meta name="og:type"content="article"><meta name="og:locale"content="en_US"><meta name="twitter:account_id"content="4503599630178231"><meta name="twitter:creator"content="@yegor256"><meta name="twitter:site"content="@yegor256"><meta name="twitter:title"property="og:title"content="ORM Is an Offensive Anti-Pattern"><meta name="twitter:description"property="og:description"content="Object-relational mapping is a design pattern that violates encapsulation, one of the fundamental principles of OOP, but what is a possible alternative to it?"><meta name="twitter:url"property="og:url"content="https://www.yegor256.com/zh/2014/12/01/orm-offensive-anti-pattern.html"><meta name="telegram:channel"content="AAAAAEJFMRzsRTRxM3ec6A"><link rel="search"type="application/opensearchdescription+xml"href="/opensearch.xml"title="yegor256"><link rel="shortcut icon"href="/favicon.ico?f9162203ae1"><link rel="apple-touch-icon"href="/favicon.ico?f9162203ae1"><link rel="alternate"type="application/rss+xml"title="RSS for yegor256.com"href="https://www.yegor256.com/rss.xml"><link rel="stylesheet"href="/css/layout.css?f9162203ae1"><link rel="stylesheet"href="/css/icons.css?f9162203ae1"><link rel="canonical"href="https://www.yegor256.com/zh/2014/12/01/orm-offensive-anti-pattern.html"><title>ORM Is an Offensive Anti-Pattern</title><div class="wrapper"><aside class="header-toggle unprintable"id="header-toggle"title="Show the menu"onclick='$("#header").show(),$("#header-toggle").hide()'>&#9776;</aside><header class="header"id="header"><div class="face"><a href="/about-me.html#form"class="sub"title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html"style="position:relative"><img src="/images/santa-hat.svg"alt="Santa hat"style="position:absolute;width:115px;left:-30px;top:-120px"> <img src="/images/face-256x256.jpg"class="photo"alt="Yegor Bugayenko"></a></div><nav><ul class="menu social notranslate"><li><a href="https://twitter.com/intent/follow?screen_name=yegor256"rel="nofollow"title="Follow me on Twitter"><i class="icon icon-twitter notranslate"aria-hidden="true"></i></a><li><a href="/rss.xml"rel="nofollow"title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://github.com/yegor256"rel="nofollow"title="My GitHub profile"><i class="icon icon-github notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="http://stackoverflow.com/users/187141/yegor256"rel="nofollow"title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.facebook.com/yegor256"rel="nofollow"title="Follow me on Facebook"><i class="icon icon-facebook notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://instagram.com/yegor256"rel="nofollow"title="Follow me on Instagram"><i class="icon icon-instagram notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.linkedin.com/in/yegor256"rel="nofollow"title="My LinkedIn profile"><i class="icon icon-linkedin notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.youtube.com/c/yegor256?sub_confirmation=1"rel="nofollow"title="My Youtube video channel"><i class="icon icon-youtube notranslate"aria-hidden="true"></i></a><li><a href="https://soundcloud.com/yegor256"rel="nofollow"title="My podcast"><i class="icon icon-podcast notranslate"aria-hidden="true"></i></a><li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721"rel="nofollow"title="My iTunes podcast"><i class="icon icon-itunes notranslate"aria-hidden="true"></i></a><li><a href="https://t.me/yegor256news"rel="nofollow"title="My Telegram public channel"><i class="icon icon-telegram notranslate"aria-hidden="true"></i></a><li><a href="mailto:blog@yegor256.com"rel="nofollow"title="Email me any time"><i class="icon icon-mail notranslate"aria-hidden="true"></i></a></ul><ul class="menu"><li><a href="/"title="Home page">Home</a><li><a href="/best.html"title="Best articles to read">12&#160;Best</a><li><a href="/contents.html"title="The contents of the entire blog">All&#160;395</a><li><a href="/teaching.html"title="My courses and lectures">Teaching</a><li><a href="/talks.html"title="Future and past conference talks">Talks</a><li><a href="/books.html"title="The books I wrote">Books</a><li><a href="/research.html"title="My research directions and progress">Research</a><li><a href="/pets.html"title="My loved pet projects">Pets</a><li><a href="/testimonials.html"title="What some people say about me">Testimonials</a><li><a href="/shift-m.html"title="Audio podcast about project management">Shift-M</a><li><a href="/paintings.html"title="My paintings for sale">Art</a><li><a href="https://ru.yegor256.com/"title="Немного на русском языке о политике в России, Украине и мире">Политика</a></ul></nav><div class="search"><form action="https://www.google.com/search"itemprop="potentialAction"itemscope=""itemtype="http://schema.org/SearchAction"><meta itemprop="target"content="https://www.google.com/search?q={q}"><input name="sitesearch"value="yegor256.com"type="hidden"> <input itemprop="query-input"id="search-query"class="field field-text"required="required"onfocus='$(".google").css("visibility","visible")'name="q"placeholder="Search..."autocomplete="off"> <input type="image"src="/images/google-search-icon.svg"class="google"title="Search via Google"alt="Search via Google"></form></div><div class="hot"><ul></ul></div></header></div><section itemscope=""itemtype="http://schema.org/BlogPosting"><div class="wrapper"><header><h1 itemprop="name headline mainEntityOfPage">ORM Is an Offensive Anti-Pattern</h1></header><article class="main"itemprop="articleBody"style="font-family:sans-serif;font-size:.9em;line-height:1.2em"><p style="color:#c42c00">The following text is a <em>partial</em> translation of the <a href="https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html">original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:<p>TL;DR ORM是一个糟糕的反模式，违反了面向对象编程的所有原则，将对象分解并转化为愚笨和被动的数据包。在任何应用程序中都没有理由存在ORM，无论是小型Web应用程序还是具有数千个表和对它们进行CRUD操作的企业级系统。替代方案是<strong>能够使用SQL的对象</strong>。<p><a href="https://en.wikipedia.org/wiki/Object-relational_mapping">对象关系映射</a>（ORM）是一种从面向对象语言（例如Java）访问关系数据库的技术（也称为设计模式）。几乎每种语言都有多种ORM的实现，例如：Java的<a href="http://hibernate.org/orm/">Hibernate</a>，Ruby on Rails的ActiveRecord，PHP的<a href="https://www.doctrine-project.org/">Doctrine</a>，以及Python的<a href="https://www.sqlalchemy.org/">SQLAlchemy</a>。在Java中，ORM设计甚至被标准化为<a href="https://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a>。<p>首先，让我们通过示例来看看ORM是如何工作的。我们使用Java，PostgreSQL和Hibernate。假设我们在数据库中有一个名为<code class="language-plaintext highlighter-rouge">post</code>的单个表：<p>现在我们希望从我们的Java应用程序中CRUD操作这个表格（CRUD代表创建、读取、更新和删除）。首先，我们应该创建一个<code class="language-plaintext highlighter-rouge">Post</code>类（对不起，它很长，但这是我能做的最好的）。<p>在使用Hibernate之前，我们必须创建一个会话工厂。<p>这个工厂将在我们每次想要操作<code class="language-plaintext highlighter-rouge">Post</code>对象时提供一个”会话”。每次与会话有关的操作都应该放在这个代码块中：<p>当会话准备好时，我们可以通过以下方式从数据库表中获取所有帖子的列表：<p>我认为这里的情况很清楚。Hibernate是一个庞大而强大的引擎，它与数据库建立连接，执行必要的SQL <code class="language-plaintext highlighter-rouge">SELECT</code>请求，并检索数据。然后它创建<code class="language-plaintext highlighter-rouge">Post</code>类的实例，并将其填充到数据中。当对象传递给我们时，它已经填充了数据，我们应该使用getter方法来提取它们，就像我们在上面使用<code class="language-plaintext highlighter-rouge">getTitle()</code>一样。<p>当我们想要执行反向操作并将对象发送到数据库时，我们做的一切都是相同的，只是顺序相反。我们创建<code class="language-plaintext highlighter-rouge">Post</code>类的实例，将其填充数据，并要求Hibernate保存它：<p>这就是几乎每个ORM的工作原理。基本原则始终相同—ORM对象是带有数据的贫血封装。我们与ORM框架进行交互，而框架与数据库进行交互。对象只帮助我们将请求发送给ORM框架并理解其响应。除了getter和setter之外，对象没有其他方法。它们甚至不知道它们来自哪个数据库。<p>这就是对象关系映射的工作原理。<p>你可能会问，它有什么问题？一切都有问题！<p>严肃地说，出了什么问题？Hibernate已经是Java中最受欢迎的库之一超过10年了。全球几乎每个SQL密集型应用程序都在使用它。每个Java教程都会提到Hibernate（或者<a href="https://en.wikipedia.org/wiki/List_of_object-relational_mapping_software">其他ORM</a>如TopLink或OpenJPA）用于与数据库连接的应用程序。它是一个标准的<em>事实上</em>，但我还是说它是错的？是的。<p>我声称ORM背后的整个理念是错误的。它的发明也许是空引用之后面向对象编程的第二个重大错误。<p>实际上，我并不是唯一一个这样说的人，肯定也不是第一个。关于这个主题已经由非常受人尊敬的作者发表了很多文章，包括Martin Fowler的<a href="https://martinfowler.com/bliki/OrmHate.html">OrmHate</a>（并不反对ORM，但还是值得一提），Jeff Atwood的<a href="http://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/">Object-Relational Mapping Is the Vietnam of Computer Science</a>，Ted Neward的<a href="http://blogs.tedneward.com/post/the-vietnam-of-computer-science/">The Vietnam of Computer Science</a>，Laurie Voss的<a href="http://seldo.com/weblog/2011/08/11/orm_is_an_antipattern">ORM Is an Anti-Pattern</a>，以及其他许多人的观点。<p>然而，我的论点与他们说的不同。尽管他们的理由是实际和有效的，比如“ORM很慢”或者“数据库升级很困难”，但他们忽略了主要观点。你可以在Bozhidar Bozhanov的<a href="http://techblog.bozho.net/orm-haters-dont-get-it/">ORM Haters Don’t Get It</a>博文中看到对这些实际论点的很好的回答。<p>主要观点是，ORM不是将数据库交互封装在对象内部，而是将其抽离开来，从而破坏了一个完整和内聚的生物体。对象的一部分保留数据，而另一部分在ORM引擎（会话工厂）内部实现，知道如何处理这些数据并将其传输到关系数据库中。看看这张图片，它说明了ORM在做什么。<p>作为一名帖子的读者，我必须处理两个组件：1）ORM和2）返回给我的“截断”的对象。我要交互的行为应该通过面向对象的单个入口点提供。在ORM的情况下，我通过<strong>两个</strong>入口点获得这个行为-ORM引擎和我们甚至不能称之为对象的“东西”。<p>由于这种对面向对象范式的可怕和冒犯性违反，我们已经有了许多在受人尊敬的出版物中提到过的实际问题。我只能再添加一些。<p><strong>SQL并没有被隐藏</strong>。ORM的用户必须使用SQL（或其方言，如<a href="https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/queryhql.html">HQL</a>）。看看上面的例子，我们调用<code class="language-plaintext highlighter-rouge">session.createQuery("FROM Post")</code>来获取所有的帖子。尽管它不是SQL，但它非常类似。因此，关系模型并没有封装在对象内部，而是暴露给整个应用程序。每个人，每个对象都不可避免地必须处理关系模型以获取或保存东西。因此，ORM并没有隐藏和包装SQL，而是把整个应用程序污染了。<p><strong>难以测试</strong>。当某个对象正在处理帖子列表时，它需要处理一个<code class="language-plaintext highlighter-rouge">SessionFactory</code>实例。我们如何模拟这个依赖关系？我们必须创建一个它的模拟对象吗？这个任务有多复杂？看看上面的代码，你就会意识到那个单元测试将会是多么冗长和繁琐。相反，我们可以编写集成测试，并将整个应用程序连接到测试版本的PostgreSQL。在这种情况下，不需要模拟<code class="language-plaintext highlighter-rouge">SessionFactory</code>，但这样的测试将会相当慢，更重要的是，我们与数据库无关的对象将会被测试针对数据库实例。这是一个糟糕的设计。<p>让我再重申一遍。ORM的实际问题只是后果。根本的缺点是ORM将对象分离开来，严重和冒犯性地违反了对象的本质思想。<p>什么是替代方案？让我以例子来展示给你。我们试着用我的方式设计那个类，<code class="language-plaintext highlighter-rouge">Post</code>。我们需要将它拆分为两个类：<code class="language-plaintext highlighter-rouge">Post</code>和<code class="language-plaintext highlighter-rouge">Posts</code>，单数和复数形式。我在之前的一篇文章中已经提到过，一个好的对象总是对现实生活实体的抽象。以下是这个原则在实践中的运用。我们有两个实体：数据库表和表行。因此，我们将创建两个类；<code class="language-plaintext highlighter-rouge">Posts</code>将代表表，而<code class="language-plaintext highlighter-rouge">Post</code>将代表行。<p>正如我在那篇文章中也提到的，每个对象都应该按照合同工作并实现一个接口。让我们从两个接口开始设计。当然，我们的对象将是不可变的。以下是<code class="language-plaintext highlighter-rouge">Posts</code>的样子：<p>这是一个<code class="language-plaintext highlighter-rouge">Post</code>的样子：<p>以下是我们如何列出数据库表中的所有帖子：<p>以下是我们创建新帖子的步骤：<p>如你所见，我们现在有真正的对象了。它们负责所有操作，完美地隐藏了它们的实现细节。没有事务、会话或工厂。我们甚至不知道这些对象是真的在与PostgreSQL通信还是它们将所有数据保存在文本文件中。我们只需要从“Posts”中获得列出所有帖子和创建新帖子的能力。实现细节完全被隐藏了起来。现在让我们看看如何实现这两个类。<p>我将使用<a href="https://jdbc.jcabi.com">jcabi-jdbc</a>作为JDBC包装器，但你可以使用其他类似的工具，比如<a href="https://www.jooq.org">jOOQ</a>，或者如果你喜欢的话，直接使用纯JDBC也可以。这并不重要。重要的是你的数据库交互被封装在对象内部。让我们从“Posts”开始，在类“PgPosts”中实现它（“pg”代表PostgreSQL）。<p>接下来，让我们在<code class="language-plaintext highlighter-rouge">PgPost</code>类中实现<code class="language-plaintext highlighter-rouge">Post</code>接口。<p>这是使用我们刚刚创建的类进行完整数据库交互场景的样子。<p>你可以在<a href="https://github.com/aintshy/hub/tree/0.7.2/src/main/java/com/aintshy/pgsql">这里</a>看到一个完整的实际示例。这是一个开源的Web应用程序，使用与上面解释的相同方法与PostgreSQL一起工作，即使用SQL语言进行操作的对象。<p>我能听到你尖叫：“性能呢？”在上面的那个脚本中，我们对数据库进行了许多多余的往返。首先，我们使用<code class="language-plaintext highlighter-rouge">SELECT id</code>检索帖子的ID，然后为了获取它们的标题，我们为每个帖子额外调用了<code class="language-plaintext highlighter-rouge">SELECT title</code>。这是低效的，或者简单地说，太慢了。<p>不用担心；这是面向对象编程，意味着它是灵活的！让我们创建一个<code class="language-plaintext highlighter-rouge">PgPost</code>的装饰器，在其构造函数中接受所有数据并将其内部缓存，永久保存下来。<p>请注意：这个装饰器对于PostgreSQL或JDBC一无所知。它只是装饰一个类型为<code class="language-plaintext highlighter-rouge">Post</code>的对象，并预先缓存日期和标题。与往常一样，这个装饰器也是不可变的。<p>现在让我们创建另一个<code class="language-plaintext highlighter-rouge">Posts</code>的实现，它将返回“常量”对象：<p>现在，这个新类的<code class="language-plaintext highlighter-rouge">iterate()</code>方法返回的所有帖子都预先加载了日期和标题，只需进行一次数据库请求。<p>通过使用装饰器和多个实现相同接口的类，您可以组合任何所需的功能。最重要的是，在扩展功能的同时，设计的复杂性没有增加，因为类的大小没有增加。相反，我们引入了保持内聚性和稳定性的新类，因为它们很小。<p>每个对象应该处理自己的事务，并以与<code class="language-plaintext highlighter-rouge">SELECT</code>或<code class="language-plaintext highlighter-rouge">INSERT</code>查询相同的方式封装它们。这将导致嵌套事务，只要数据库服务器支持它们，这是完全可以的。如果没有这样的支持，可以创建一个会话范围的事务对象，该对象将接受一个“可调用”类。例如：<p>然后，当您想要将几个对象操作包装在一个事务中时，请按照以下方式进行：<p>这段代码将创建一个新帖子并对其发表评论。如果其中一个调用失败，整个事务将被回滚。<p>这种方法对我来说看起来很面向对象。我称之为“会说SQL的对象”，因为它们知道如何与数据库服务器进行SQL通信。这是它们的技能，完美地封装在它们的边界内。<p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2024-01-09 at 18:03</article></div><div class="wrapper"><footer class="footer"><p>&copy; <span itemscope=""itemprop="copyrightHolder"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span> </span>2014&ndash;<span itemprop="copyrightYear">2024</span></footer></div></section><div class="wrapper unprintable"style="text-align:center;margin-top:2em"><a href="https://www.sixnines.io/h/3ba1652f"><img src="//www.sixnines.io/b/3ba1652f?style=flat"alt="sixnines availability badge"></a>&nbsp; <a href="https://github.com/yegor256/blog/stargazers"><img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square"alt="GitHub stars"></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script><script src="/js/all.js?f9162203ae1"></script><script>var disqus_shortname="yegor256"</script><script id="dsq-count-scr"src="//yegor256.disqus.com/count.js"async="async"></script><script>((e,a,t,g,n,c)=>{e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,n=a.createElement(t),c=a.getElementsByTagName(t)[0],n.async=1,n.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(n,c)})(window,document,"script","ga"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script><script>Cd=document,Cr="&"+Math.random(),Cp="&s=1",Cd.cookie="b=b",Cd.cookie&&(Cp+="&c=1"),Cp+="&t="+(new Date).getTimezoneOffset(),self!=top&&(Cp+="&f=1")</script><script>navigator.javaEnabled()&&(Cp+="&j=1")</script><script>"undefined"!=typeof screen&&(Cp+="&w="+screen.width+"&h="+screen.height+"&d="+(screen.colorDepth||screen.pixelDepth))</script><script>Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+"&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+"' border='0' width='1' height='1'/>")</script><script type="application/ld+json">{ "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] }</script>