<!doctypehtml><html xmlns="http://www.w3.org/1999/xhtml"lang="en-US"xml:lang="en-US"itemscope=""itemtype="http://schema.org/WebSite"><meta charset="utf-8"><meta name="description"content="The article explains how DynamoDB Local can be used in Rake integration testing; a practical example of SixNines.io testing is provided."><meta name="keywords"content=""><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><meta name="google-site-verification"content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8"><meta name="author"content="Yegor Bugayenko"><meta name="og:site_name"content="Yegor Bugayenko"><meta name="og:type"content="article"><meta name="og:locale"content="en_US"><meta name="twitter:account_id"content="4503599630178231"><meta name="twitter:creator"content="@yegor256"><meta name="twitter:site"content="@yegor256"><meta name="twitter:title"property="og:title"content="DynamoDB + Rake + Maven + Rack::Test"><meta name="twitter:description"property="og:description"content="The article explains how DynamoDB Local can be used in Rake integration testing; a practical example of SixNines.io testing is provided."><meta name="twitter:url"property="og:url"content="https://www.yegor256.com/zh/2017/06/13/dynamodb-rack-maven.html"><meta name="telegram:channel"content="AAAAAEJFMRzsRTRxM3ec6A"><link rel="search"type="application/opensearchdescription+xml"href="/opensearch.xml"title="yegor256"><link rel="shortcut icon"href="/favicon.ico?36c03a29597"><link rel="apple-touch-icon"href="/favicon.ico?36c03a29597"><link rel="alternate"type="application/rss+xml"title="RSS for yegor256.com"href="https://www.yegor256.com/rss.xml"><link rel="stylesheet"href="/css/layout.css?36c03a29597"><link rel="stylesheet"href="/css/icons.css?36c03a29597"><link rel="canonical"href="https://www.yegor256.com/zh/2017/06/13/dynamodb-rack-maven.html"><title>DynamoDB + Rake + Maven + Rack::Test</title><div class="wrapper"><aside class="header-toggle unprintable"id="header-toggle"title="Show the menu"onclick='$("#header").show(),$("#header-toggle").hide()'>&#9776;</aside><header class="header"id="header"><div class="face"><a href="/about-me.html#form"class="sub"title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html"style="position:relative"><img src="/images/face-256x256.jpg"class="photo"alt="Yegor Bugayenko"></a></div><nav><ul class="menu social notranslate"><li><a href="https://twitter.com/intent/follow?screen_name=yegor256"rel="nofollow"title="Follow me on Twitter"><i class="icon icon-twitter notranslate"aria-hidden="true"></i></a><li><a href="/rss.xml"rel="nofollow"title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://github.com/yegor256"rel="nofollow"title="My GitHub profile"><i class="icon icon-github notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="http://stackoverflow.com/users/187141/yegor256"rel="nofollow"title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.facebook.com/yegor256"rel="nofollow"title="Follow me on Facebook"><i class="icon icon-facebook notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://instagram.com/yegor256"rel="nofollow"title="Follow me on Instagram"><i class="icon icon-instagram notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.linkedin.com/in/yegor256"rel="nofollow"title="My LinkedIn profile"><i class="icon icon-linkedin notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.youtube.com/c/yegor256?sub_confirmation=1"rel="nofollow"title="My Youtube video channel"><i class="icon icon-youtube notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.pinterest.com/yegor256/"rel="nofollow"title="My Pinterest boards"><i class="icon icon-pinterest notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://angel.co/yegor256"rel="nofollow"title="My AngelList profile"><i class="icon icon-angellist notranslate"aria-hidden="true"></i></a><li><a href="https://soundcloud.com/yegor256"rel="nofollow"title="My podcast"><i class="icon icon-podcast notranslate"aria-hidden="true"></i></a><li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721"rel="nofollow"title="My iTunes podcast"><i class="icon icon-itunes notranslate"aria-hidden="true"></i></a><li><a href="https://t.me/yegor256news"rel="nofollow"title="My Telegram public channel"><i class="icon icon-telegram notranslate"aria-hidden="true"></i></a><li><a href="mailto:blog@yegor256.com"rel="nofollow"title="Email me any time"><i class="icon icon-mail notranslate"aria-hidden="true"></i></a></ul><ul class="menu"><li><a href="/"title="Home page">Home</a><li><a href="/best.html"title="Best articles to read">12&#160;Best</a><li><a href="/contents.html"title="The contents of the entire blog">All&#160;390</a><li><a href="/teaching.html"title="My courses and lectures">Teaching</a><li><a href="/talks.html"title="Future and past conference talks">Talks</a><li><a href="/books.html"title="The books I wrote">Books</a><li><a href="/research.html"title="My research directions and progress">Research</a><li><a href="/pets.html"title="My loved pet projects">Pets</a><li><a href="/testimonials.html"title="What some people say about me">Testimonials</a><li><a href="/shift-m.html"title="Audio podcast about project management">Shift-M</a><li><a href="/paintings.html"title="My paintings for sale">Art</a><li><a href="https://ru.yegor256.com/"title="Немного на русском языке о политике в России, Украине и мире">Политика</a></ul></nav><div class="search"><form action="https://www.google.com/search"itemprop="potentialAction"itemscope=""itemtype="http://schema.org/SearchAction"><meta itemprop="target"content="https://www.google.com/search?q={q}"><input name="sitesearch"value="yegor256.com"type="hidden"> <input itemprop="query-input"id="search-query"class="field field-text"required="required"onfocus='$(".google").css("visibility","visible")'name="q"placeholder="Search..."autocomplete="off"> <input type="image"src="/images/google-search-icon.svg"class="google"title="Search via Google"alt="Search via Google"></form></div><div class="hot"><ul></ul></div></header></div><section itemscope=""itemtype="http://schema.org/BlogPosting"><div class="wrapper"><header><h1 itemprop="name headline mainEntityOfPage">DynamoDB + Rake + Maven + Rack::Test</h1></header><article class="main"itemprop="articleBody"style="font-family:sans-serif;font-size:.9em;line-height:1.2em"><p style="color:#c42c00">The following text is a <em>partial</em> translation of the <a href="https://www.yegor256.com/2017/06/13/dynamodb-rack-maven.html">original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:<p>在我的一个名为SixNines.io的Ruby宠物网络应用程序中，我正在使用<a href="https://aws.amazon.com/dynamodb/">DynamoDB</a>，这是由<a href="https://aws.amazon.com/">AWS</a>提供的一种NoSQL云数据库。它的功能非常强大，但问题是很难创建一个集成测试，以确保我的代码与”真实”的DynamoDB服务器和表一起工作。让我向你展示如何解决这个问题。该代码是开源的，你可以在<a href="https://github.com/yegor256/sixnines">yegor256/sixnines</a> GitHub存储库中查看。<p>首先，您需要使用由AWS创建的<a href="https://aws.amazon.com/blogs/aws/dynamodb-local-for-desktop-development/">DynamoDB Local</a>命令行工具进行测试。在进行集成测试之前，您需要启动它并在测试完成后停止。<p>为了使事情更简单，我建议您使用<a href="http://dynamodb.jcabi.com/"><code class="language-plaintext highlighter-rouge">jcabi-dynamodb-maven-plugin</code></a>，这是我几年前开发的一个<a href="https://maven.apache.org/">Maven</a>插件。您需要将<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml"><code class="language-plaintext highlighter-rouge">pom.xml</code></a>添加到您的代码库中，并从<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile"><code class="language-plaintext highlighter-rouge">Rakefile</code></a>启动/停止Maven，就像我在<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L50-L67">这里</a>所做的一样。<p>首先，我要删除<code class="language-plaintext highlighter-rouge">dynamodb-local/target</code>目录，这是Maven保存临时文件的目录，以确保我们始终从头开始。<p>然后，我使用<code class="language-plaintext highlighter-rouge">Process.spawn</code>作为后台进程启动<code class="language-plaintext highlighter-rouge">mvn install</code>，并使用<code class="language-plaintext highlighter-rouge">pid</code>作为其进程ID（这在Windows上不起作用，只在Linux/Mac上有效）。然后我立即注册一个<a href="https://ruby-doc.org/core-2.2.3/Kernel.html#method-i-at_exit"><code class="language-plaintext highlighter-rouge">at_exit</code></a>的Ruby钩子，如果Ruby因任何原因而死亡，该钩子将被执行。我相信很明显，我为什么要这样做——为了避免在Rake完成或终止后在后台运行垃圾。<p>请注意，我使用的是<code class="language-plaintext highlighter-rouge">kill -TERM</code>而不是<code class="language-plaintext highlighter-rouge">kill -KILL</code>，以便给Maven一个机会来完成所有工作，正确终止DynamoDB Local，关闭其TCP端口并退出。<p>接下来，我要检查<code class="language-plaintext highlighter-rouge">sn-endpoints</code>这个表在DynamoDB Local中的状态。如果服务器正在运行，它就应该存在。根据<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/tables/sn-endpoints.json"><code class="language-plaintext highlighter-rouge">sn-endpoints.json</code></a>中的JSON配置，它将由<code class="language-plaintext highlighter-rouge">jcabi-dynamodb-maven-plugin</code>创建。<p>然而，这个表可能不会立即准备好，因为需要时间来启动Maven、启动服务器并在其中创建表。这就是为什么，如果出现异常，我会捕获它，等待5秒钟然后重试。我会一直尝试多次，直到服务器准备好。最终它会准备好的。在我的MacBook上大约需要12-15秒，也就是2-3次尝试/异常。<p>我的类需要在集成测试期间知道如何连接到服务器。在生产环境中，它们需要连接到AWS，在测试中，它们必须知道我刚刚启动的DynamoDB本地实例。这就是我在<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb"><code class="language-plaintext highlighter-rouge">Dynamo</code></a>类中的内容，它负责与DynamoDB进行连接。它根据环境变量<code class="language-plaintext highlighter-rouge">RACK_ENV</code>的决定来确定连接位置，该变量在<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test__helper.rb#L25"><code class="language-plaintext highlighter-rouge">test__helper.rb</code></a>中设置为<code class="language-plaintext highlighter-rouge">"test"</code>，<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L39"><code class="language-plaintext highlighter-rouge">rake/testtask</code></a>会在所有其他测试之前加载它，感谢其名称中的双下划线。<p>如果环境变量设置为<code class="language-plaintext highlighter-rouge">"test"</code>，<code class="language-plaintext highlighter-rouge">Dynamo</code>将从YAML文件<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb#L37"><code class="language-plaintext highlighter-rouge">dynamodb-local/target/dynamo.yml</code></a>中获取连接参数，该文件是由<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L79-L100"><code class="language-plaintext highlighter-rouge">maven-resources-plugin:copy-resources</code></a>创建的。DynamoDB Local数据库的TCP端口将在<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/config/dynamo.yml">此处</a>找到，以及DynamoDB的身份验证密钥和密码。<p>这是最容易的部分。我只需按照生产中的要求使用我的对象，并将它们连接到 DynamoDB 本地而不是 AWS。<p>为了测试整个应用程序，我使用 Rack::Test 进行一系列的 HTTP 调用。例如，<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test_sixnines.rb#L143-L147">在这里</a>，我试图渲染 Jeff 的用户账户页面。它的 HTTP 响应代码应该是 200。<p>现在您可以从命令行运行整个测试。您可以在发布新版本时查看Rultor是如何运行它的：<a href="https://www.rultor.com/t/11705-302080694">完整日志</a>。此外，也可以在Travis中查看其运行方式：<a href="https://travis-ci.org/yegor256/sixnines">Travis链接</a>。简而言之：<ul><li><p>Rake试图运行<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L32"><code class="language-plaintext highlighter-rouge">default</code></a>任务，该任务依赖于<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L36"><code class="language-plaintext highlighter-rouge">test</code></a>。<li><p>Rake 尝试运行 <code class="language-plaintext highlighter-rouge">test</code>，它依赖于 <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L50"><code class="language-plaintext highlighter-rouge">dynamo</code></a>。<li><p>Rake，在<code class="language-plaintext highlighter-rouge">test</code>任务中，使用此<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml"><code class="language-plaintext highlighter-rouge">pom.xml</code></a>在后台运行<code class="language-plaintext highlighter-rouge">mvn install</code>。<li><p>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L38-L60">unpacks</a> DynamoDB Local 安装包；<li><p>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L61-L78">保留</a> 一个随机的TCP端口，并将其值存储在<code class="language-plaintext highlighter-rouge">${dynamo.port}</code>中；<li><p>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L79-L100">saves</a> <code class="language-plaintext highlighter-rouge">${dynamo.port}</code> and key/secret pair info;</ul><p>Maven 会保存 <code class="language-plaintext highlighter-rouge">${dynamo.port}</code> 和密钥/密码对信息；<ul><li><p>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L101-L128">starts</a> DynamoDB Local，将其绑定到保留的TCP端口上；<li><p>Rake <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L57-L65">waits</a> for DynamoDB Local availability on the reserved port;</ul><p>Rake在保留端口上等待DynamoDB Local的可用性；<ul><li><p>从<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test__helper.rb">test__helper.rb</a>开始，<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L38-L39">导入</a>所有的<a href="https://github.com/yegor256/sixnines/tree/0.17/test">测试类</a>。<li><p>环境变量 <code class="language-plaintext highlighter-rouge">RACK_ENV</code> 被设置为 <code class="language-plaintext highlighter-rouge">"test"</code>；<li><p>Rack::Test 试图 <a href="https://github.com/yegor256/sixnines/blob/0.17/test/test_sixnines.rb#L145">尝试</a> 分发一个网页；<li><p><a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb"><code class="language-plaintext highlighter-rouge">Dynamo</code></a> 从 <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/config/dynamo.yml"><code class="language-plaintext highlighter-rouge">dynamo.yml</code></a> 加载 YAML 配置并连接到 DynamoDB Local。<li><p>Rake stops;<li><p>Ruby <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L53-L56">terminates</a> Maven and it stops DynamoDB Local.</ul><p>Ruby终止Maven并停止DynamoDB Local。<p>That’s it.<p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/42 on 2023-11-17 at 16:46</article></div><div class="wrapper"><footer class="footer"><p>&copy; <span itemscope=""itemprop="copyrightHolder"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span> </span>2014&ndash;<span itemprop="copyrightYear">2023</span></footer></div></section><div class="wrapper unprintable"style="text-align:center;margin-top:2em"><a href="https://www.sixnines.io/h/3ba1652f"><img src="//www.sixnines.io/b/3ba1652f?style=flat"alt="sixnines availability badge"></a>&nbsp; <a href="https://github.com/yegor256/blog/stargazers"><img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square"alt="GitHub stars"></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script><script src="/js/all.js?36c03a29597"></script><script>var disqus_shortname="yegor256"</script><script id="dsq-count-scr"src="//yegor256.disqus.com/count.js"async="async"></script><script>((e,a,t,g,n)=>{e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),n=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",n.parentNode.insertBefore(g,n)})(window,document,"script"),ga("create","UA-1963507-32","auto"),ga("send","pageview")</script><script>Cd=document,Cr="&"+Math.random(),Cp="&s=1",Cd.cookie="b=b",Cd.cookie&&(Cp+="&c=1"),Cp+="&t="+(new Date).getTimezoneOffset(),self!=top&&(Cp+="&f=1")</script><script>navigator.javaEnabled()&&(Cp+="&j=1")</script><script>"undefined"!=typeof screen&&(Cp+="&w="+screen.width+"&h="+screen.height+"&d="+(screen.colorDepth||screen.pixelDepth))</script><script>Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+"&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+"' border='0' width='1' height='1'/>")</script><script type="application/ld+json">{ "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] }</script>