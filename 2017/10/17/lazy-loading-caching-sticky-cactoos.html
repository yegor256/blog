<!doctypehtml><html xmlns="https://www.w3.org/1999/xhtml"lang="en-US"xml:lang="en-US"itemscope=""itemtype="http://schema.org/WebSite"><meta charset="utf-8"><meta name="description"content="Lazy loading is a popular technique in OOP, which is usually done through NULL references; Cactoos offers a better way, with the help of a few Java primitives."><meta name="keywords"content="cactoos, java cache, java cache in memory, java cactoos, java lazy loading"><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><meta name="google-site-verification"content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8"><meta name="author"content="Yegor Bugayenko"><meta name="article:published_time"content="2017-10-17 00:00:00 +0000"><meta name="yandex-verification"content="7d2a0afee14d72bc"><meta name="og:site_name"content="Yegor Bugayenko"><meta name="og:type"content="article"><meta name="og:locale"content="en_US"><meta name="twitter:account_id"content="4503599630178231"><meta name="twitter:creator"content="@yegor256"><meta name="twitter:site"content="@yegor256"><meta name="twitter:title"property="og:title"content="Lazy Loading and Caching via Sticky Cactoos Primitives"><meta name="twitter:description"property="og:description"content="Lazy loading is a popular technique in OOP, which is usually done through NULL references; Cactoos offers a better way, with the help of a few Java primitives."><meta name="twitter:url"property="og:url"content="https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html"><meta name="telegram:channel"content="AAAAAEJFMRzsRTRxM3ec6A"><link rel="search"type="application/opensearchdescription+xml"href="/opensearch.xml"title="yegor256"><link rel="icon"href="/favicon.ico?96f99ee"type="image/x-icon"><link rel="shortcut icon"href="/favicon.ico?96f99ee"><link rel="apple-touch-icon"href="/favicon.ico?96f99ee"><link rel="alternate"type="application/rss+xml"title="RSS for yegor256.com"href="https://www.yegor256.com/rss.xml"><link rel="stylesheet"href="/css/layout.css?96f99ee"><link rel="stylesheet"href="/css/icons.css?96f99ee"><link rel="canonical"href="https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html"><title>Lazy Loading and Caching via Sticky Cactoos Primitives</title><meta name="og:image"content="https://www.yegor256.com/images/2017/10/reality.jpg"><meta name="twitter:image"content="https://www.yegor256.com/images/2017/10/reality.jpg"><meta name="og:image:width"content="1828"><meta name="twitter:image:width"content="1828"><meta name="og:image:height"content="778"><meta name="twitter:image:height"content="778"><meta name="twitter:card"content="summary_large_image"><meta name="twitter:image:alt"content="Reality (2012) by Matteo Garrone"><div class="wrapper"><aside class="header-toggle unprintable"id="header-toggle"title="Show the menu"onclick='$("#header").show(),$("#header-toggle").hide()'>&#9776;</aside><header class="header"id="header"><div class="face"><a href="/about-me.html#form"class="sub"title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html"style="position:relative"><img src="/images/face-256x256.jpg"class="photo"alt="Yegor Bugayenko"></a></div><nav><ul class="menu social notranslate"><li><a href="https://twitter.com/intent/follow?screen_name=yegor256"rel="nofollow"title="Follow me on Twitter"><i class="icon icon-twitter notranslate"aria-hidden="true"></i></a><li><a href="/rss.xml"rel="nofollow"title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://github.com/yegor256"rel="nofollow"title="My GitHub profile"><i class="icon icon-github notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="http://stackoverflow.com/users/187141/yegor256"rel="nofollow"title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.facebook.com/yegor256"rel="nofollow"title="Follow me on Facebook"><i class="icon icon-facebook notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://instagram.com/yegor256"rel="nofollow"title="Follow me on Instagram"><i class="icon icon-instagram notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.linkedin.com/in/yegor256"rel="nofollow"title="My LinkedIn profile"><i class="icon icon-linkedin notranslate"aria-hidden="true"></i></a><li><a itemprop="sameAs"href="https://www.youtube.com/c/yegor256?sub_confirmation=1"rel="nofollow"title="My Youtube video channel"><i class="icon icon-youtube notranslate"aria-hidden="true"></i></a><li><a href="https://soundcloud.com/yegor256"rel="nofollow"title="My podcast"><i class="icon icon-podcast notranslate"aria-hidden="true"></i></a><li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721"rel="nofollow"title="My iTunes podcast"><i class="icon icon-itunes notranslate"aria-hidden="true"></i></a><li><a href="https://t.me/yegor256news"rel="nofollow"title="My Telegram public channel"><i class="icon icon-telegram notranslate"aria-hidden="true"></i></a><li><a href="mailto:blog@yegor256.com"rel="nofollow"title="Email me any time"><i class="icon icon-mail notranslate"aria-hidden="true"></i></a></ul><ul class="menu"><li><a href="/"title="Home page">Home</a><li><a href="/best.html"title="Best articles to read">12&#160;Best</a><li><a href="/contents.html"title="The contents of the entire blog">All&#160;481</a><li><a href="/teaching.html"title="My courses and lectures">Teaching</a><li><a href="/talks.html"title="Future and past conference talks">Talks</a><li><a href="/books.html"title="The books I wrote">Books</a><li><a href="/research.html"title="My research directions and progress">Research</a><li><a href="/pets.html"title="My loved pet projects">Pets</a><li><a href="/trainings.html"title="On-site trainings">Trainings</a><li><a href="https://www.iccq.ru"title="International Conference on Code Quality">ICCQ</a><li><a href="https://www.kaicode.org"title="Open Source Festival">KaiCode</a><li><a href="/testimonials.html"title="What some people say about me">Testimonials</a><li><a href="/shift-m.html"title="Audio podcast about project management">Shift-M</a><li><a href="/paintings.html"title="My paintings for sale">Art</a></ul></nav><div class="search"><form action="https://www.google.com/search"itemprop="potentialAction"itemscope=""itemtype="http://schema.org/SearchAction"><meta itemprop="target"content="https://www.google.com/search?q={q}"><input name="sitesearch"value="yegor256.com"type="hidden"> <input itemprop="query-input"id="search-query"class="field field-text"required="required"onfocus='$(".google").css("visibility","visible")'name="q"placeholder="Search..."autocomplete="off"> <input type="image"src="/images/google-search-icon.svg"class="google"title="Search via Google"alt="Search via Google"></form></div><div class="hot"><ul><li>Are you familiar with open source and have a decent GitHub portfolio of contributions? <strong>We need freelancers</strong>, working remotely and paid by result, for <a href="https://www.eolang.org">EO</a>, a new programming language. Join our Telegram group, we'll discuss: <a href="https://t.me/eolang_org">@eolang_org</a>.</ul></div></header></div><section itemscope=""itemtype="http://schema.org/BlogPosting"><div class="wrapper"><header><p class="printable"><img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html&amp;format=svg"style="width:125px;height:125px"alt="QR code"><p class="printable"><code itemprop="url">https://www.yegor256.com/171017.html</code><h1 itemprop="name headline mainEntityOfPage">Lazy Loading and Caching via Sticky Cactoos Primitives</h1><ul class="subline"><li><time itemprop="datePublished"datetime="2017-10-17T00:00:00+00:00">17 October 2017</time><li class="desktop-only"itemprop="locationCreated">Odessa, Ukraine<li class="printable"itemscope=""itemprop="author"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span><li class="unprintable"><i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html#disqus_thread"itemprop="discussionUrl">comments</a></ul><ul class="unprintable subline"><li title="The page is translated by ChatGPT from English to a few languages">Translated by <i class="icon icon-chatgpt notranslate"aria-hidden="true"></i> to<li title="Click to see this page translated to Chinese"><a href="https://www.yegor256.com/zh/2017/10/17/lazy-loading-caching-sticky-cactoos.html">中文</a><li title="Click to see this page translated to Russian"><a href="https://www.yegor256.com/ru/2017/10/17/lazy-loading-caching-sticky-cactoos.html">русский</a></ul><p class="unprintable"><a href="/tag/java.html"class="tag notranslate"><img src="/images/icons/java-white.svg"alt="Java">java</a><nav class="buttons notranslate desktop-only"><a href="https://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html"title="Share on Facebook"class="button"rel="nofollow"><span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate"aria-hidden="true"></i> </a><a href="https://twitter.com/share?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html&amp;text=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives"title="Share on Twitter"class="button"rel="nofollow"><span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate"aria-hidden="true"></i> </a><a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html"title="Share on LinkedIn"class="button"rel="nofollow"><span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate"aria-hidden="true"></i> </a><a href="https://reddit.com/submit?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html%3F2017-42&amp;title=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives"title="Share on Reddit"class="button"rel="nofollow"><span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate"aria-hidden="true"></i> </a><a href="https://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html%3F2017-42&amp;t=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives"title="Share on Hacker News"class="button"rel="nofollow"><span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate"aria-hidden="true"></i> </a><a href="#"title="Cite it via BibTeX"class="button"onclick='return $("#bibtex").toggle(),!1'><i class="icon icon-tex notranslate"aria-hidden="true"></i></a></nav></header><article class="main"itemprop="articleBody"><div><div id="bibtex"style="display:none"><p>Please, cite this blog post via <a href="https://www.bibtex.org/">BibTeX</a> as such:<pre style="color:#053c5e">@misc&#123;bugayenko2017blog1017,
  author = &#123;Bugayenko, Yegor&#125;,
  title = &#123;&#123;Lazy Loading and Caching via Sticky Cactoos Primitives&#125;&#125;,
  howpublished = &#123;\url&#123;https://www.yegor256.com/171017.html&#125;&#125;,
  year = &#123;2017&#125;,
  month = &#123;oct&#125;,
  note = &#123;[Online; accessed 05-10-2025]&#125;
&#125;</pre></div><p>You obviously know what <a href="https://en.wikipedia.org/wiki/Lazy_loading">lazy loading</a> is, right? And you no doubt know about <a href="https://en.wikipedia.org/wiki/Cache_%28computing%29">caching</a>. To my knowledge, there is no elegant way in Java to implement either of them. Here is what I found out for myself with the help of Cactoos primitives.<figure class="jb_picture"><img itemprop="image"alt="Reality (2012) by Matteo Garrone"src="/images/2017/10/reality.jpg"longdesc="#e68b1cc6"><figcaption id="e68b1cc6">Reality (2012) by Matteo Garrone</figcaption></figure><p>Let’s say we need an object that will encrypt some text. Speaking in a more object-oriented way, it will encapsulate the text and <em>become</em> its encrypted form. Here is how we will use it (let’s create <a href="/2017/03/24/tdd-that-works.html">tests first</a>):<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span>
<span class="nc">Encrypted</span> <span class="n">enc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EncryptedX</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">enc</span><span class="o">.</span><span class="na">asString</span><span class="o">());</span>
</code></pre></div></div><p>Now let’s implement it, in a very primitive way, with one <a href="/2015/05/28/one-primary-constructor.html">primary</a> constructor. The encryption mechanism will just add <code class="language-plaintext highlighter-rouge">+1</code> to each byte in the incoming data, and will assume that the encryption won’t break anything (a very stupid assumption, but for the sake of this example it will work):<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted1</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted1</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Looks correct so far? I <a href="https://github.com/yegor256/blog/tree/master/_samples/2017/10/sticky">tested it</a> and it works. If the input is <code class="language-plaintext highlighter-rouge">"Hello, world!"</code>, the output will be <code class="language-plaintext highlighter-rouge">"Ifmmp-!xpsme\""</code>.<p>Next, let’s say that we want our class to accept an <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html"><code class="language-plaintext highlighter-rouge">InputStream</code></a> as well as a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><code class="language-plaintext highlighter-rouge">String</code></a>. We want to call it like this, for example:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Encrypted</span> <span class="n">enc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Encrypted2</span><span class="o">(</span>
  <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="s">"/tmp/hello.txt"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">enc</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div></div><p>Here is the most obvious implementation, with two <a href="/2015/05/28/one-primary-constructor.html">primary</a> constructors (again, the implementation is primitive, but works):<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted2</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted2</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="nc">Encrypted2</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// asString() is exactly the same as in Encrypted1</span>
<span class="o">}</span>
</code></pre></div></div><p>Technically it works, but stream reading is right inside the constructor, which is <a href="/2015/05/07/ctors-must-be-code-free.html">bad practice</a>. <a href="/2015/05/28/one-primary-constructor.html">Primary</a> constructors must not do anything but attribute assignments, while secondary ones may only create new objects.<p>Let’s try to refactor and introduce lazy loading:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted3</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">InputStream</span> <span class="n">input</span><span class="o">;</span>
  <span class="nc">Encrypted3</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">stream</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nc">Encrypted3</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Works great, but looks ugly. The ugliest part is these two lines of course:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</code></pre></div></div><p>They make the object <a href="/2014/06/09/objects-should-be-immutable.html">mutable</a> and they’re using <a href="/2014/05/13/why-null-is-bad.html">NULL</a>. It’s ugly, trust me. Unfortunately, lazy loading and NULL references always come together in <a href="https://stackoverflow.com/a/2192271/187141">classic examples</a>. However there is a better way to implement it. Let’s refactor our class, this time using <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/Scalar.html"><code class="language-plaintext highlighter-rouge">Scalar</code></a> from <a href="https://www.cactoos.org">Cactoos</a>:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted4</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
          <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">txt</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div><p>Now it looks way better. First of all, there is only one primary constructor and two secondary ones. Second, the object is <a href="/2014/06/09/objects-should-be-immutable.html">immutable</a>. Third, there is still a lot of room for <a href="/2014/11/07/how-immutability-helps.html">improvement</a>: we can add more constructors which will accept other sources of data, for example <a href="https://docs.oracle.com/javase/8/docs/api/java/io/File.html"><code class="language-plaintext highlighter-rouge">File</code></a> or a byte array.<aside class="youtube"><a href="https://www.youtube.com/watch?v=7WmsiV22IXM"><div class="box"><img src="https://i.ytimg.com/vi/7WmsiV22IXM/mqdefault.jpg"alt="YouTube video #7WmsiV22IXM"><div class="play"><i class="icon icon-play"></i></div></div></a><div>Lazy Loading via Java Lambda (Webinar #30); 13 December 2017.</div></aside><p>In a nutshell, the attribute that is supposed to be loaded in a “lazy” way is represented inside an object as a “function” (<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">lambda expression</a> in Java 8). Until we touch that attribute, it’s not loaded. Once we need to work with it, the function gets executed and we have the result.<p>There is one problem with this code though. It will read the input stream every time we call <code class="language-plaintext highlighter-rouge">asString()</code>, which will obviously not work, since only the first time will the stream have the data. On every subsequent call the stream will simply be empty. Thus, we need to make sure that <code class="language-plaintext highlighter-rouge">this.text.value()</code> executes the encapsulated <code class="language-plaintext highlighter-rouge">Scalar</code> only once. All later calls must return the previously calculated value. So we need to <em>cache</em> it. Here is how:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted5</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="c1">// same as above in Encrypted4</span>
  <span class="nc">Encrypted5</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span>
      <span class="k">new</span> <span class="nc">StickyScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// same as above in Encrypted4</span>
</code></pre></div></div><p>This <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/StickyScalar.html"><code class="language-plaintext highlighter-rouge">StickyScalar</code></a> will make sure that only the first call to its method <code class="language-plaintext highlighter-rouge">value()</code> will go through to the encapsulated <code class="language-plaintext highlighter-rouge">Scalar</code>. All other calls will receive the result of the first call.<p>The last problem to solve is about concurrency. The code we have above is not thread safe. If I create an instance of <code class="language-plaintext highlighter-rouge">Encrypted5</code> and pass it to two threads, which call <code class="language-plaintext highlighter-rouge">asString()</code> simultaneously, the result will be unpredictable, simply because <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/StickyScalar.html"><code class="language-plaintext highlighter-rouge">StickyScalar</code></a> is not thread-safe. There is another primitive to help us out though, called <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/SyncScalar.html"><code class="language-plaintext highlighter-rouge">SyncScalar</code></a>:<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Encrypted5</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="c1">// same as above in Encrypted4</span>
  <span class="nc">Encrypted5</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span>
      <span class="k">new</span> <span class="nc">SyncScalar</span><span class="o">&lt;&gt;(</span>
        <span class="k">new</span> <span class="nc">StickyScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// same as above in Encrypted4</span>
</code></pre></div></div><p>Now we’re safe and the design is elegant. It includes lazy loading and caching.<p>I’m using this approach in many projects now and it seems convenient, clear, and object-oriented.</div></article></div><div class="disqus"role="complementary"aria-hidden="true"><p class="disqus_hint">Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.<div id="disqus_thread"class="disqus-thread"><a>&nbsp;</a></div><script>var disqus_config=function(){this.page.url=document.location.href.split("?")[0].split("#")[0],this.page.identifier=this.page.url};(()=>{var e=document,t=e.createElement("script");t.src="//yegor256.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript><div><p class="red">JavaScript is disabled in your browser, that's why you can't see comments under this post.</div></noscript></div><div class="wrapper"><footer class="footer"><p>&copy; <span itemscope=""itemprop="copyrightHolder"itemtype="http://schema.org/Person"><span itemprop="name">Yegor Bugayenko</span> </span>, 2014&ndash;<span itemprop="copyrightYear">2025</span></footer></div></section><div class="wrapper unprintable"style="text-align:center;margin-top:2em"><a href="https://www.sixnines.io/h/3ba1652f"><img src="https://www.sixnines.io/b/3ba1652f?style=flat"alt="sixnines availability badge"></a>&nbsp; <a href="https://github.com/yegor256/blog/stargazers"><img src="https://img.shields.io/github/stars/yegor256/blog.svg?style=flat-square"alt="GitHub stars"></a></div><script src="https://code.jquery.com/jquery-1.9.0.min.js"></script><script src="/js/all.js?96f99ee"></script><script type="application/ld+json">{ "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] }</script>