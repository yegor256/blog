<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Lazy loading is a popular technique in OOP, which is usually done through NULL references; Cactoos offers a better way, with the help of a few Java primitives." /> <meta name="keywords" content="cactoos, java cache, java cache in memory, java cactoos, java lazy loading" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2017-10-17 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Lazy Loading and Caching via Sticky Cactoos Primitives"/> <meta name="twitter:description" property="og:description" content="Lazy loading is a popular technique in OOP, which is usually done through NULL references; Cactoos offers a better way, with the help of a few Java primitives."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?9b17558998c"/> <link rel="apple-touch-icon" href="/favicon.ico?9b17558998c"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?9b17558998c"/> <link rel="stylesheet" href="/css/icons.css?9b17558998c"/> <link rel="canonical" href="https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html" /> <title>Lazy Loading and Caching via Sticky Cactoos Primitives </title> <meta name='og:image' content='https://www.yegor256.com/images/2017/10/reality.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2017/10/reality.jpg'/><meta name='og:image:width' content='1828'/> <meta name='twitter:image:width' content='1828'/><meta name='og:image:height' content='778'/> <meta name='twitter:image:height' content='778'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Reality (2012) by Matteo Garrone'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;363</a></li> <li ><a href="/webinars.html" title="My webinars">Webinars</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html</code></p><h1 itemprop="name headline mainEntityOfPage">Lazy Loading and Caching via Sticky Cactoos Primitives</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2017-10-17T00:00:00+00:00"> 17 October 2017 </time> </li> <li class="desktop-only" itemprop="locationCreated">Odessa, Ukraine</li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'><img src='/images/java-icon.svg' alt='Java'/>java</a></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html&amp;text=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html%3F2017-42&amp;title=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2017/10/17/lazy-loading-caching-sticky-cactoos.html%3F2017-42&amp;t=Lazy+Loading+and+Caching+via+Sticky+Cactoos+Primitives" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>You obviously know what <a href="https://en.wikipedia.org/wiki/Lazy_loading">lazy loading</a> is, right? And you no doubt know about <a href="https://en.wikipedia.org/wiki/Cache_%28computing%29">caching</a>. To my knowledge, there is no elegant way in Java to implement either of them. Here is what I found out for myself with the help of Cactoos primitives.</p><figure class="jb_picture"><img itemprop="image" alt="Reality (2012) by Matteo Garrone" src="/images/2017/10/reality.jpg" longdesc="#e68b1cc6" /><figcaption id="e68b1cc6">Reality (2012) by Matteo Garrone</figcaption></figure><p>Let’s say we need an object that will encrypt some text. Speaking in a more object-oriented way, it will encapsulate the text and <em>become</em> its encrypted form. Here is how we will use it (let’s create <a href="/2017/03/24/tdd-that-works.html">tests first</a>):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span>
<span class="nc">Encrypted</span> <span class="n">enc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EncryptedX</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">enc</span><span class="o">.</span><span class="na">asString</span><span class="o">());</span></code></pre></figure><p>Now let’s implement it, in a very primitive way, with one <a href="/2015/05/28/one-primary-constructor.html">primary</a> constructor. The encryption mechanism will just add <code class="highlighter-rouge">+1</code> to each byte in the incoming data, and will assume that the encryption won’t break anything (a very stupid assumption, but for the sake of this example it will work):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted1</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted1</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Looks correct so far? I <a href="https://github.com/yegor256/blog/tree/master/_samples/2017/10/sticky">tested it</a> and it works. If the input is <code class="highlighter-rouge">"Hello, world!"</code>, the output will be <code class="highlighter-rouge">"Ifmmp-!xpsme\""</code>.</p><p>Next, let’s say that we want our class to accept an <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html"><code class="highlighter-rouge">InputStream</code></a> as well as a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html"><code class="highlighter-rouge">String</code></a>. We want to call it like this, for example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Encrypted</span> <span class="n">enc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Encrypted2</span><span class="o">(</span>
  <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="s">"/tmp/hello.txt"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">enc</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span></code></pre></figure><p>Here is the most obvious implementation, with two <a href="/2015/05/28/one-primary-constructor.html">primary</a> constructors (again, the implementation is primitive, but works):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted2</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted2</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="nc">Encrypted2</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// asString() is exactly the same as in Encrypted1</span>
<span class="o">}</span></code></pre></figure><p>Technically it works, but stream reading is right inside the constructor, which is <a href="/2015/05/07/ctors-must-be-code-free.html">bad practice</a>. <a href="/2015/05/28/one-primary-constructor.html">Primary</a> constructors must not do anything but attribute assignments, while secondary ones may only create new objects.</p><p>Let’s try to refactor and introduce lazy loading:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted3</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">text</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">InputStream</span> <span class="n">input</span><span class="o">;</span>
  <span class="nc">Encrypted3</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="n">stream</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nc">Encrypted3</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Works great, but looks ugly. The ugliest part is these two lines of course:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">input</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span></code></pre></figure><p>They make the object <a href="/2014/06/09/objects-should-be-immutable.html">mutable</a> and they’re using <a href="/2014/05/13/why-null-is-bad.html">NULL</a>. It’s ugly, trust me. Unfortunately, lazy loading and NULL references always come together in <a href="https://stackoverflow.com/a/2192271/187141">classic examples</a>. However there is a better way to implement it. Let’s refactor our class, this time using <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/Scalar.html"><code class="highlighter-rouge">Scalar</code></a> from <a href="http://www.cactoos.org">Cactoos</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted4</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span>
      <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span>
          <span class="k">new</span> <span class="nf">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">one</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">one</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">baos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">one</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">txt</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nc">Encrypted4</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">asString</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">in</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">value</span><span class="o">().</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="o">(</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
  <span class="o">}</span></code></pre></figure><p>Now it looks way better. First of all, there is only one primary constructor and two secondary ones. Second, the object is <a href="/2014/06/09/objects-should-be-immutable.html">immutable</a>. Third, there is still a lot of room for <a href="/2014/11/07/how-immutability-helps.html">improvement</a>: we can add more constructors which will accept other sources of data, for example <a href="https://docs.oracle.com/javase/8/docs/api/java/io/File.html"><code class="highlighter-rouge">File</code></a> or a byte array.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=7WmsiV22IXM"><div class="box"> <img src="https://i.ytimg.com/vi/7WmsiV22IXM/mqdefault.jpg" alt="YouTube video #7WmsiV22IXM" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Lazy Loading via Java Lambda (Webinar #30); 13 December 2017.</div></aside><p>In a nutshell, the attribute that is supposed to be loaded in a “lazy” way is represented inside an object as a “function” (<a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">lambda expression</a> in Java 8). Until we touch that attribute, it’s not loaded. Once we need to work with it, the function gets executed and we have the result.</p><p>There is one problem with this code though. It will read the input stream every time we call <code class="highlighter-rouge">asString()</code>, which will obviously not work, since only the first time will the stream have the data. On every subsequent call the stream will simply be empty. Thus, we need to make sure that <code class="highlighter-rouge">this.text.value()</code> executes the encapsulated <code class="highlighter-rouge">Scalar</code> only once. All later calls must return the previously calculated value. So we need to <em>cache</em> it. Here is how:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted5</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="c1">// same as above in Encrypted4</span>
  <span class="nc">Encrypted5</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span>
      <span class="k">new</span> <span class="nc">StickyScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// same as above in Encrypted4</span></code></pre></figure><p>This <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/StickyScalar.html"><code class="highlighter-rouge">StickyScalar</code></a> will make sure that only the first call to its method <code class="highlighter-rouge">value()</code> will go through to the encapsulated <code class="highlighter-rouge">Scalar</code>. All other calls will receive the result of the first call.</p><p>The last problem to solve is about concurrency. The code we have above is not thread safe. If I create an instance of <code class="highlighter-rouge">Encrypted5</code> and pass it to two threads, which call <code class="highlighter-rouge">asString()</code> simultaneously, the result will be unpredictable, simply because <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/StickyScalar.html"><code class="highlighter-rouge">StickyScalar</code></a> is not thread-safe. There is another primitive to help us out though, called <a href="http://static.javadoc.io/org.cactoos/cactoos/0.16/org/cactoos/scalar/SyncScalar.html"><code class="highlighter-rouge">SyncScalar</code></a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">Encrypted5</span> <span class="kd">implements</span> <span class="nc">Encrypted</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">text</span><span class="o">;</span>
  <span class="c1">// same as above in Encrypted4</span>
  <span class="nc">Encrypted5</span><span class="o">(</span><span class="nc">Scalar</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IoCheckedScalar</span><span class="o">&lt;&gt;(</span>
      <span class="k">new</span> <span class="nc">SyncScalar</span><span class="o">&lt;&gt;(</span>
        <span class="k">new</span> <span class="nc">StickyScalar</span><span class="o">&lt;&gt;(</span><span class="n">source</span><span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
  <span class="c1">// same as above in Encrypted4</span></code></pre></figure><p>Now we’re safe and the design is elegant. It includes lazy loading and caching.</p><p>I’m using this approach in many projects now and it seems convenient, clear, and object-oriented.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2021</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?9b17558998c"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
