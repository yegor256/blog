<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>DynamoDB + Rake + Maven + Rack::Test</title>
    <link rel="canonical" href="https://www.yegor256.com/2017/06/13/dynamodb-rack-maven.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2017/06/13/dynamodb-rack-maven.html"
        },
        "headline": "DynamoDB + Rake + Maven + Rack::Test",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1200x1200.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2017-06-13",
        "dateModified": "2017-06-13",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "The article explains how DynamoDB Local can be
used in Rake integration testing; a practical
example of SixNines.io testing is provided.
",
        "keywords": ["dynamodb local", "dynamodb", "rake dynamodb", "rack::test dynamodb", "testing dynamodb ruby"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2017/06/13/dynamodb-rack-maven.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>13 June 2017</p>
      <h1>DynamoDB + Rake + Maven + Rack::Test</h1>
      <p>In
<a href="/2017/04/25/sixnines.html">SixNines.io</a>,
one of my Ruby pet web apps, I’m using
<a href="https://aws.amazon.com/dynamodb/">DynamoDB</a>, a NoSQL cloud database
by <a href="https://aws.amazon.com/">AWS</a>. It works like a charm, but the problem
is that it’s not so easy to create an integration test, to make sure
my code works together with the “real” DynamoDB server and tables. Let me
show you how it was solved. The code is open source and you can see it
in the <a href="https://github.com/yegor256/sixnines">yegor256/sixnines</a> GitHub repo.</p>



<h2 id="how-to-bootstrap-dynamodb-local">How to bootstrap DynamoDB Local</h2>

<p>First, you need to use
<a href="https://aws.amazon.com/blogs/aws/dynamodb-local-for-desktop-development/">DynamoDB Local</a>,
a command line tool created by AWS exactly for the
purposes of testing. You need to start it before your integration
tests and stop it afterwards.</p>

<p>To make things simpler
I suggest you use <a href="https://dynamodb.jcabi.com/"><code class="language-plaintext highlighter-rouge">jcabi-dynamodb-maven-plugin</code></a>,
a <a href="https://maven.apache.org/">Maven</a> plugin that I
<a href="/2014/05/01/dynamodb-local-maven-plugin.html">made</a> a few years ago.
You will need to add
<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml"><code class="language-plaintext highlighter-rouge">pom.xml</code></a> to your
repository and start/stop Maven from a
<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile"><code class="language-plaintext highlighter-rouge">Rakefile</code></a>,
just like I’m doing <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L50-L67">here</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">task</span> <span class="ss">:dynamo</span> <span class="k">do</span>
  <span class="no">FileUtils</span><span class="p">.</span><span class="nf">rm_rf</span><span class="p">(</span><span class="s1">'dynamodb-local/target'</span><span class="p">)</span>
  <span class="n">pid</span> <span class="o">=</span> <span class="no">Process</span><span class="p">.</span><span class="nf">spawn</span><span class="p">(</span><span class="s1">'mvn'</span><span class="p">,</span> <span class="s1">'install'</span><span class="p">,</span> <span class="ss">chdir: </span><span class="s1">'dynamodb-local'</span><span class="p">)</span>
  <span class="nb">at_exit</span> <span class="k">do</span>
    <span class="sb">`kill -TERM </span><span class="si">#{</span><span class="n">pid</span><span class="si">}</span><span class="sb">`</span>
  <span class="k">end</span>
  <span class="k">begin</span>
    <span class="no">Dynamo</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">aws</span><span class="p">.</span><span class="nf">describe_table</span><span class="p">(</span><span class="ss">table_name: </span><span class="s1">'sn-endpoints'</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">retry</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>First, I’m removing <code class="language-plaintext highlighter-rouge">dynamodb-local/target</code>, the directory where Maven keeps
its temporary files, to make sure we always start from scratch.</p>

<p>Then, I’m starting <code class="language-plaintext highlighter-rouge">mvn install</code>, using <code class="language-plaintext highlighter-rouge">Process.spawn</code>, as a background
process with <code class="language-plaintext highlighter-rouge">pid</code> as its process ID (this won’t work in Windows, only Linux/Mac).
Then I immediately register an
<a href="https://ruby-doc.org/core-2.2.3/Kernel.html#method-i-at_exit"><code class="language-plaintext highlighter-rouge">at_exit</code></a>
Ruby hook, which will be executed if Ruby dies for any reason. I’m sure
it’s obvious why I have to do that—in order to avoid garbage running
in the background after Rake is finished or terminated.</p>

<p>Pay attention, I’m using <code class="language-plaintext highlighter-rouge">kill -TERM</code> instead of <code class="language-plaintext highlighter-rouge">kill -KILL</code>, in order to
give Maven a chance to wrap everything up, terminate DynamoDB Local correctly,
close its TCP port and exit.</p>

<h2 id="how-to-check-that-its-running">How to check that it’s running</h2>

<p>Next I’m checking the status of <code class="language-plaintext highlighter-rouge">sn-endpoints</code>, one of the tables in the
DynamoDB Local. It has to be there if the server is up and running. It will
be created by <code class="language-plaintext highlighter-rouge">jcabi-dynamodb-maven-plugin</code> according to
<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/tables/sn-endpoints.json"><code class="language-plaintext highlighter-rouge">sn-endpoints.json</code></a>,
its JSON configuration.</p>

<p>Most probably the table won’t be ready immediately though, since it takes time to
bootstrap Maven, start the server, and create tables there. That’s why, if the
exception is thrown, I catch it, wait for 5 seconds and try again.
I keep trying many times, until the server is ready. Eventually it will be.
It takes about 12-15 seconds on my MacBook, which means 2-3 attempts/exceptions.</p>

<h2 id="how-to-connect-to-dynamodb-local">How to connect to DynamoDB Local</h2>

<p>My classes need to know how to connect to the server during integration tests.
In production they need to connect to AWS, in testing they have to
know about the DynamoDB Local instance I just started. This is what I have in my class
<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb"><code class="language-plaintext highlighter-rouge">Dynamo</code></a>,
which is responsible for the very connection with DynamoDB. Its decision
on where to connect is based on the environment variable <code class="language-plaintext highlighter-rouge">RACK_ENV</code>, which
is set to <code class="language-plaintext highlighter-rouge">"test"</code> in
<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test__helper.rb#L25"><code class="language-plaintext highlighter-rouge">test__helper.rb</code></a>,
which is included by
<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L39"><code class="language-plaintext highlighter-rouge">rake/testtask</code></a>
in front of all other tests, thanks to the double underscore in its name.</p>

<p>If the environment variable is set to <code class="language-plaintext highlighter-rouge">"test"</code>,
<code class="language-plaintext highlighter-rouge">Dynamo</code> takes the connectivity parameters from the YAML file
<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb#L37"><code class="language-plaintext highlighter-rouge">dynamodb-local/target/dynamo.yml</code></a>
created by
<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L79-L100"><code class="language-plaintext highlighter-rouge">maven-resources-plugin:copy-resources</code></a>.
The TCP port of the DynamoDB Local database will be
<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/config/dynamo.yml">there</a>,
as well as the DynamoDB authentication key and secret.</p>

<h2 id="how-to-run-the-integration-tests">How to run the integration tests</h2>

<p>This is the easiest part. I just use my objects the way they are supposed
to be used in production and they connect to DynamoDB Local instead of AWS.</p>

<p>I’m using Rack::Test in order to test the entire application, via a set
of HTTP calls. For example,
<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test_sixnines.rb#L143-L147">here</a>
I’m trying to render Jeff’s user account page.
Its HTTP response code is supposed to be 200:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">require</span> <span class="err">'</span><span class="n">test</span><span class="o">/</span><span class="n">unit</span><span class="err">'</span>
<span class="n">require</span> <span class="err">'</span><span class="n">rack</span><span class="o">/</span><span class="n">test</span><span class="err">'</span>
<span class="kd">class</span> <span class="nc">AppTest</span> <span class="o">&lt;</span> <span class="nl">Test:</span><span class="o">:</span><span class="nl">Unit:</span><span class="o">:</span><span class="nc">TestCase</span>
  <span class="n">include</span> <span class="nl">Rack:</span><span class="o">:</span><span class="nl">Test:</span><span class="o">:</span><span class="nc">Methods</span>
  <span class="n">def</span> <span class="n">app</span>
    <span class="nl">Sinatra:</span><span class="o">:</span><span class="nc">Application</span>
  <span class="n">end</span>
  <span class="n">def</span> <span class="n">test_user_account</span>
    <span class="nf">header</span><span class="o">(</span><span class="err">'</span><span class="nc">Cookie</span><span class="err">'</span><span class="o">,</span> <span class="err">'</span><span class="n">sixnines</span><span class="o">=</span><span class="n">jeff</span><span class="err">'</span><span class="o">)</span>
    <span class="n">get</span><span class="o">(</span><span class="err">'</span><span class="o">/</span><span class="n">a</span><span class="err">'</span><span class="o">)</span>
    <span class="n">assert_equal</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">last_response</span><span class="o">.</span><span class="na">status</span><span class="o">)</span>
  <span class="n">end</span>
</code></pre></div></div>

<p>##</p>

<p>Now you can run the entire test from the command line. You can see how
<a href="/2014/09/11/deployment-script-vs-rultor.html">Rultor</a>
runs it while releasing a new version: <a href="https://www.rultor.com/t/11705-302080694">full log</a>.
Also, see how it works <a href="https://travis-ci.org/yegor256/sixnines">in Travis</a>.
In a nutshell:</p>

<ul>
  <li>You call <code class="language-plaintext highlighter-rouge">rake</code> in the command line and Rake starts;</li>
  <li>Rake attempts to run the <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L32"><code class="language-plaintext highlighter-rouge">default</code></a> task,
which depends on <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L36"><code class="language-plaintext highlighter-rouge">test</code></a>;</li>
  <li>Rake attempts to run <code class="language-plaintext highlighter-rouge">test</code>, which depends on
<a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L50"><code class="language-plaintext highlighter-rouge">dynamo</code></a>;</li>
  <li>Rake, inside <code class="language-plaintext highlighter-rouge">test</code> task, runs <code class="language-plaintext highlighter-rouge">mvn install</code> in the background
with this <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml"><code class="language-plaintext highlighter-rouge">pom.xml</code></a>;</li>
  <li>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L38-L60">unpacks</a>
DynamoDB Local installation package;</li>
  <li>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L61-L78">reserves</a>
a random TCP port and stores its value into <code class="language-plaintext highlighter-rouge">${dynamo.port}</code>;</li>
  <li>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L79-L100">saves</a>
<code class="language-plaintext highlighter-rouge">${dynamo.port}</code> and key/secret pair info;</li>
  <li>Maven <a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/pom.xml#L101-L128">starts</a>
DynamoDB Local, binding it to the reserved TCP port;</li>
  <li>Rake <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L57-L65">waits</a>
for DynamoDB Local availability on the reserved port;</li>
  <li>Rake <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L38-L39">imports</a>
all <a href="https://github.com/yegor256/sixnines/tree/0.17/test">test classes</a> starting from
<a href="https://github.com/yegor256/sixnines/blob/0.17/test/test__helper.rb">test__helper.rb</a>;</li>
  <li>Environment variable <code class="language-plaintext highlighter-rouge">RACK_ENV</code> is <a href="https://github.com/yegor256/sixnines/blob/0.17/test/test__helper.rb#L25">set</a>
to <code class="language-plaintext highlighter-rouge">"test"</code>;</li>
  <li>Rack::Test <a href="https://github.com/yegor256/sixnines/blob/0.17/test/test_sixnines.rb#L145">attempts</a>
to dispatch a web page;</li>
  <li>
<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb"><code class="language-plaintext highlighter-rouge">Dynamo</code></a>
<a href="https://github.com/yegor256/sixnines/blob/0.17/objects/dynamo.rb#L37-L39">loads</a> YAML config from
<a href="https://github.com/yegor256/sixnines/blob/0.17/dynamodb-local/config/dynamo.yml"><code class="language-plaintext highlighter-rouge">dynamo.yml</code></a>
and connects to DynamoDB Local;</li>
  <li>Rake stops;</li>
  <li>Ruby <a href="https://github.com/yegor256/sixnines/blob/0.17/Rakefile#L53-L56">terminates</a>
Maven and it stops DynamoDB Local.</li>
</ul>

<p>That’s it.</p>


    </article>
  </body>
</html>
