<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Limit Java Method Execution Time</title>
    <link rel="canonical" href="https://www.yegor256.com/2014/06/20/limit-method-execution-time.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/06/20/limit-method-execution-time.html"
        },
        "headline": "Limit Java Method Execution Time",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-06-20",
        "dateModified": "2014-06-20",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "Aspect oriented programming with AspectJ and jcabi-aspects can
help you to control maximum execution time for any single Java method
",
        "keywords": ["aop java", "limit method execution time java", "java limit method execution time", "aspect oriented programming java", "aop annotations Timeable", "aop method time annotations", "aspectj timing", "aspectj weaving annotations"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2014/06/20/limit-method-execution-time.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>20 June 2014</p>
      <h1>Limit Java Method Execution Time</h1>
      

<p>Say, you want to allow a Java method to work for
a maximum of five seconds and want an exception
to be thrown if the timeframe is exceeded. Here is how
you can do it with <a href="https://aspects.jcabi.com">jcabi-aspects</a>
and <a href="http://eclipse.org/aspectj/">AspectJ</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Resource</span> <span class="o">{</span>
  <span class="nd">@Timeable</span><span class="o">(</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">load</span><span class="o">(</span><span class="no">URL</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">().</span><span class="na">getContent</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>



<p>Keep in mind that you should weave your classes after
compilation, as explained <a href="https://aspects.jcabi.com/example-weaving.html">here</a>.</p>

<p>Let’s discuss how this actually works, but first,
I recommend you read <a href="/2014/06/01/aop-aspectj-java-method-logging.html">this post</a>,
which explains how AOP aspects work together with
<a href="/2016/04/12/java-annotations-are-evil.html">Java annotations</a>.</p>

<p>Due to <a href="https://aspects.jcabi.com/annotation-timeable.html"><code class="language-plaintext highlighter-rouge">@Timeable</code></a>
annotation and class weaving, every call to a method <code class="language-plaintext highlighter-rouge">load()</code>
is intercepted by an aspect from <a href="https://aspects.jcabi.com">jcabi-aspects</a>.
That aspect starts a new thread that monitors the execution of a method
every second, checking whether it is still running.</p>

<p>If the method runs for over five seconds, the thread
calls <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code class="language-plaintext highlighter-rouge">interrupt()</code></a>
on the method’s thread.</p>

<p>Despite a very common expectation that a thread should be terminated
immediately on that call, it is not happening at all.
<a href="http://docs.oracle.com/javase/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html">This article</a>
explains the mechanism in more detail. Let’s discuss it briefly:</p>

<ol>
  <li>
    <p><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code class="language-plaintext highlighter-rouge">interrupt()</code></a>
    sets a marker in a thread;</p>
  </li>
  <li>
    <p>The thread checks <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupt%28%29"><code class="language-plaintext highlighter-rouge">interrupted()</code></a>
    as often as it can;</p>
  </li>
  <li>
    <p>If the marker is set, the thread stops and throws
    <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/InterruptedException.html"><code class="language-plaintext highlighter-rouge">InterruptedException</code></a></p>
  </li>
</ol>

<p>This method will <strong>not</strong> react to <code class="language-plaintext highlighter-rouge">interrupt()</code> call and will work until JVM is killed (very bad design):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">work</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// do something</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This is how we should refactor it in order to make
sensitive to interruption requests:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">work</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interruped</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// do something</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In other words, your method can only stop itself. Nothing else can do it.
The thread it is running in can’t be terminated by another thread. The best
thing that the other thread can do is to send your thread a “message”
(through <code class="language-plaintext highlighter-rouge">interrupt()</code> method) that it’s time to stop. If your thread
ignores the message, nobody can do anything.</p>

<p>Most I/O operations in JDK are designed this way. They check the
interruption status of their threads while waiting for I/O resources.</p>

<p>Thus, use <code class="language-plaintext highlighter-rouge">@Timeable</code> annotation, but keep in mind that there could
be situations when a thread can’t be interrupted.</p>

    </article>
  </body>
</html>
