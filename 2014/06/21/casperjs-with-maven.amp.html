<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>CasperJS Tests in Maven Build</title>
    <link rel="canonical" href="http://www.yegor256.com/2014/06/21/casperjs-with-maven.html">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "http://www.yegor256.com/2014/06/21/casperjs-with-maven.html"
        },
        "headline": "CasperJS Tests in Maven Build",
        "image": {
          "@type": "ImageObject",
          "url": "http://www.yegor256.com/images/face-1400x1400.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-06-21",
        "dateModified": "2014-06-21",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "http://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "Practical example of running automated integration tests
in Maven build using Tomcat, PhantomJS and CasperJS
",
        "keywords": ["maven casperjs", "maven phantomjs", "maven tomcat casperjs", "maven phantomjs tomcat", "integration tests with casperjs", "maven tests with casperjs", "phantomjs maven plugin"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <style amp-custom="amp-custom">
      body { padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="http://www.yegor256.com/2014/06/21/casperjs-with-maven.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/yegor-bugayenko-192x192.png" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>21 June 2014</p>
      <h1>CasperJS Tests in Maven Build</h1>
      <p>I'm a big fan of automated testing in general and integration
testing in particular. I strongly believe that effort spent on
writing tests are direct investments into quality and stability
of the product under development.</p>

<p><a href="http://casperjs.org/">CasperJS</a> is a testing framework on top of
<a href="http://phantomjs.org/">PhantomJS</a>, which is a headless browser. Using
CasperJS, we can ensure that our application responds correctly
to requests sent by a regular web browser.</p>



<p>This is a sample CasperJS test, which makes an HTTP request to a home page
of a running WAR application and asserts that the response has
<code>200</code> HTTP status code:</p>

<pre>casper.test.begin(
  'home page can be rendered',
  function (test) {
    casper.start(
      casper.cli.get('home'), // URL of home page
      function () {
        test.assertHttpStatus(200);
      }
    );
    casper.run(
      function () {
        test.done();
      }
    );
  }
);</pre>

<p>I keep this test in the <code>src/test/casperjs/home-page.js</code> file.
Let's see how CasperJS can be executed automatically on every Maven build.</p>

<p>Here is the test scenario, implemented with a combination of Maven plugins:</p>

<ol>
<li><p>Install PhantomJS</p></li>
<li><p>Install CasperJS</p></li>
<li><p>Reserve a random TCP port</p></li>
<li><p>Start Tomcat on that TCP port (with WAR inside)</p></li>
<li><p>Run CasperJS tests and point them to the running Tomcat</p></li>
<li><p>Shutdown Tomcat</p></li>
</ol>

<p>I'm using a combination of plugins. Let's go through the steps one by one.</p>

<p>BTW, I'm not showing plugin versions in the examples below, primarily
because most of them are in active development. Check their versions
at <a href="http://search.maven.org/">Maven Central</a> (yes, all of them are available there).</p>

<h2 id="1-install-phantomjs">1. Install PhantomJS</h2>

<p>First of all, we have to download the PhantomJS executable.
It is a platform-specific binary. Thanks to <a href="https://github.com/klieber">Kyle Lieber</a>,
we have an off-the-shelf Maven plugin:
<a href="https://github.com/klieber/phantomjs-maven-plugin">phantomjs-maven-plugin</a>
that understands what the current platform is and downloads the appropriate
binary automatically, placing it into the <code>target</code> directory.</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;com.github.klieber&lt;/groupId&gt;
  &lt;artifactId&gt;phantomjs-maven-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;goals&gt;
        &lt;goal&gt;install&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
  &lt;configuration&gt;
    &lt;version&gt;1.9.2&lt;/version&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;</pre>

<p>The exact name of the downloaded binary is stored in the
<code>${phantomjs.binary}</code> Maven property.</p>

<h2 id="2-install-casperjs">2. Install CasperJS</h2>

<p>Unfortunately, there is no similar plugin for the CasperJS installation
(at least I haven't found any as of yet). That's why I'm using plain
old <code>git</code> (you should have it installed on your build machine).</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
  &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;casperjs-install&lt;/id&gt;
      &lt;phase&gt;pre-integration-test&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;exec&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;executable&gt;git&lt;/executable&gt;
        &lt;arguments&gt;
          &lt;argument&gt;clone&lt;/argument&gt;
          &lt;argument&gt;--depth=1&lt;/argument&gt;
          &lt;argument&gt;https://github.com/n1k0/casperjs.git&lt;/argument&gt;
          &lt;argument&gt;${project.build.directory}/casperjs&lt;/argument&gt;
        &lt;/arguments&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<h2 id="3-reserve-tcp-port">3. Reserve TCP Port</h2>

<p>I need to obtain a random TCP port where Tomcat will be started.
The port has to be available on the build machine. I want to be able
to run multiple Maven builds in parallel, so that's why I get a random port on every build.</p>

<p>In other examples, you may see people using fixed port numbers,
like <code>5555</code> or something similar. This is a very bad practice.
Always reserve a new random port when you need it.</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
  &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;tomcat-port&lt;/id&gt;
      &lt;goals&gt;
        &lt;goal&gt;reserve-network-port&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;portNames&gt;
          &lt;portName&gt;tomcat.port&lt;/portName&gt;
        &lt;/portNames&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<p>The plugin reserves a port and sets it value to the <code>${tomcat.port}</code> Maven property.</p>

<h2 id="4-start-tomcat">4. Start Tomcat</h2>

<p>Now, it's time to start Tomcat with the WAR package inside.
I'm using <a href="http://tomcat.apache.org/maven-plugin-2.0/tomcat7-maven-plugin/">tomcat7-maven-plugin</a>
that starts a real Tomcat7 server and configures it to serve on the port reserved above.</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt;
  &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;path&gt;/&lt;/path&gt;
  &lt;/configuration&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;start-tomcat&lt;/id&gt;
      &lt;phase&gt;pre-integration-test&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;run-war-only&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;port&gt;${tomcat.port}&lt;/port&gt;
        &lt;fork&gt;true&lt;/fork&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<p>Due to the option <code>fork</code> being set to <code>true</code>, Tomcat7 continues
to run when the plugin execution finishes. That's exactly what I need.</p>

<h2 id="5-run-casperjs">5. Run CasperJS</h2>

<p>Now, it's time to run CasperJS. Even though there are some
plugins exist for this, I'm using plain old
<code>exec-maven-plugin</code>,
mostly because it is more configurable.</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
  &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;casperjs-test&lt;/id&gt;
      &lt;phase&gt;integration-test&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;exec&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;executable&gt;
          ${project.build.directory}/casperjs/bin/casperjs
        &lt;/executable&gt;
        &lt;workingDirectory&gt;${basedir}&lt;/workingDirectory&gt;
        &lt;arguments&gt;
          &lt;argument&gt;test&lt;/argument&gt;
          &lt;argument&gt;--verbose&lt;/argument&gt;
          &lt;argument&gt;--no-colors&lt;/argument&gt;
          &lt;argument&gt;--concise&lt;/argument&gt;
          &lt;argument&gt;--home=http://localhost:${tomcat.port}&lt;/argument&gt;
          &lt;argument&gt;${basedir}/src/test/casperjs&lt;/argument&gt;
        &lt;/arguments&gt;
        &lt;environmentVariables&gt;
          &lt;PHANTOMJS_EXECUTABLE&gt;${phantomjs.binary}&lt;/PHANTOMJS_EXECUTABLE&gt;
        &lt;/environmentVariables&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<p>The environment variable <code>PHANTOMJS_EXECUTABLE</code> is the undocumented
feature that makes this whole scenario possible. It configures
the location of the PhantomJS executable, which was downloaded a few steps above.</p>

<h2 id="6-shutdown-tomcat">6. Shutdown Tomcat</h2>

<p>In the last step, I shut down the Tomcat server.</p>

<pre>&lt;plugin&gt;
  &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt;
  &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;id&gt;stop-tomcat&lt;/id&gt;
      &lt;phase&gt;post-integration-test&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;shutdown&lt;/goal&gt;
      &lt;/goals&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;</pre>

<h2 id="real-example">Real Example</h2>

<p>If you want to see how this all works in action, take
a look at <a href="http://www.stateful.co">stateful.co</a>. It is a Java
Web application hosted at <a href="http://www.cloudbees.com">CloudBees</a>.
Its source code is open and available in <a href="https://github.com/sttc/stateful">GitHub</a>.</p>

<p>Its <a href="https://github.com/sttc/stateful/blob/sttc-1.5/pom.xml"><code>pom.xml</code></a>
contains exactly the same configurations explained above, but joined together.</p>

<p>If you have any questions, please don't hesitate to ask below.</p>

<p>PS. Also, check this:
<a href="/2014/04/06/phandom.html">PhantomJS as an HTML Validator</a></p>

    </article>
  </body>
</html>
