<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>CasperJS Tests in Maven Build</title>
    <link rel="canonical" href="https://www.yegor256.com/2014/06/21/casperjs-with-maven.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/06/21/casperjs-with-maven.html"
        },
        "headline": "CasperJS Tests in Maven Build",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-06-21",
        "dateModified": "2014-06-21",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "Practical example of running automated integration tests
in Maven build using Tomcat, PhantomJS and CasperJS
",
        "keywords": ["maven casperjs", "maven phantomjs", "maven tomcat casperjs", "maven phantomjs tomcat", "integration tests with casperjs", "maven tests with casperjs", "phantomjs maven plugin"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2014/06/21/casperjs-with-maven.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>21 June 2014</p>
      <h1>CasperJS Tests in Maven Build</h1>
      <p>I’m a big fan of automated testing in general and integration
testing in particular. I strongly believe that effort spent on
writing tests are direct investments into
<a href="/2017/12/26/software-quality-formula.html">quality</a> and stability
of the product under development.</p>

<p><a href="http://casperjs.org/">CasperJS</a> is a testing framework on top of
<a href="http://phantomjs.org/">PhantomJS</a>, which is a headless browser. Using
CasperJS, we can ensure that our application responds correctly
to requests sent by a regular web browser.</p>



<p>This is a sample CasperJS test, which makes an HTTP request to a home page
of a running WAR application and asserts that the response has
<code class="language-plaintext highlighter-rouge">200</code> HTTP status code:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">casper</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span>
  <span class="dl">'</span><span class="s1">home page can be rendered</span><span class="dl">'</span><span class="p">,</span>
  <span class="nf">function </span><span class="p">(</span><span class="nx">test</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">casper</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span>
      <span class="nx">casper</span><span class="p">.</span><span class="nx">cli</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">home</span><span class="dl">'</span><span class="p">),</span> <span class="c1">// URL of home page</span>
      <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">test</span><span class="p">.</span><span class="nf">assertHttpStatus</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">casper</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span>
      <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">test</span><span class="p">.</span><span class="nf">done</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>

<p>I keep this test in the <code class="language-plaintext highlighter-rouge">src/test/casperjs/home-page.js</code> file.
Let’s see how CasperJS can be executed automatically on every Maven build.</p>

<p>Here is the test scenario, implemented with a combination of Maven plugins:</p>

<ol>
  <li>
    <p>Install PhantomJS</p>
  </li>
  <li>
    <p>Install CasperJS</p>
  </li>
  <li>
    <p>Reserve a random TCP port</p>
  </li>
  <li>
    <p>Start Tomcat on that TCP port (with WAR inside)</p>
  </li>
  <li>
    <p>Run CasperJS tests and point them to the running Tomcat</p>
  </li>
  <li>
    <p>Shutdown Tomcat</p>
  </li>
</ol>

<p>I’m using a combination of plugins. Let’s go through the steps one by one.</p>

<p>BTW, I’m not showing plugin versions in the examples below, primarily
because most of them are in active development. Check their versions
at <a href="http://search.maven.org/">Maven Central</a> (yes, all of them are available there).</p>

<h2 id="1-install-phantomjs">1. Install PhantomJS</h2>

<p>First of all, we have to download the PhantomJS executable.
It is a platform-specific binary. Thanks to <a href="https://github.com/klieber">Kyle Lieber</a>,
we have an off-the-shelf Maven plugin:
<a href="https://github.com/klieber/phantomjs-maven-plugin">phantomjs-maven-plugin</a>
that understands what the current platform is and downloads the appropriate
binary automatically, placing it into the <code class="language-plaintext highlighter-rouge">target</code> directory.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.github.klieber<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>phantomjs-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>install<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
  <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.9.2<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>The exact name of the downloaded binary is stored in the
<code class="language-plaintext highlighter-rouge">${phantomjs.binary}</code> Maven property.</p>

<h2 id="2-install-casperjs">2. Install CasperJS</h2>

<p>Unfortunately, there is no similar plugin for the CasperJS installation
(at least I haven’t found any as of yet). That’s why I’m using plain
old <code class="language-plaintext highlighter-rouge">git</code> (you should have it installed on your build machine).</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>exec-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>casperjs-install<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;phase&gt;</span>pre-integration-test<span class="nt">&lt;/phase&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>exec<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;executable&gt;</span>git<span class="nt">&lt;/executable&gt;</span>
        <span class="nt">&lt;arguments&gt;</span>
          <span class="nt">&lt;argument&gt;</span>clone<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>--depth=1<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>https://github.com/n1k0/casperjs.git<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>${project.build.directory}/casperjs<span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;/arguments&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<h2 id="3-reserve-tcp-port">3. Reserve TCP Port</h2>

<p>I need to obtain a random TCP port where Tomcat will be started.
The port has to be available on the build machine. I want to be able
to run multiple Maven builds in parallel, so that’s why I get a random port on every build.</p>

<p>In other examples, you may see people using fixed port numbers,
like <code class="language-plaintext highlighter-rouge">5555</code> or something similar. This is a very bad practice.
Always reserve a new random port when you need it.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>build-helper-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>tomcat-port<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>reserve-network-port<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;portNames&gt;</span>
          <span class="nt">&lt;portName&gt;</span>tomcat.port<span class="nt">&lt;/portName&gt;</span>
        <span class="nt">&lt;/portNames&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>The plugin reserves a port and sets it value to the <code class="language-plaintext highlighter-rouge">${tomcat.port}</code> Maven property.</p>

<h2 id="4-start-tomcat">4. Start Tomcat</h2>

<p>Now, it’s time to start Tomcat with the WAR package inside.
I’m using <a href="http://tomcat.apache.org/maven-plugin-2.0/tomcat7-maven-plugin/">tomcat7-maven-plugin</a>
that starts a real Tomcat7 server and configures it to serve on the port reserved above.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.maven<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>tomcat7-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;path&gt;</span>/<span class="nt">&lt;/path&gt;</span>
  <span class="nt">&lt;/configuration&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>start-tomcat<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;phase&gt;</span>pre-integration-test<span class="nt">&lt;/phase&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>run-war-only<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;port&gt;</span>${tomcat.port}<span class="nt">&lt;/port&gt;</span>
        <span class="nt">&lt;fork&gt;</span>true<span class="nt">&lt;/fork&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>Due to the option <code class="language-plaintext highlighter-rouge">fork</code> being set to <code class="language-plaintext highlighter-rouge">true</code>, Tomcat7 continues
to run when the plugin execution finishes. That’s exactly what I need.</p>

<h2 id="5-run-casperjs">5. Run CasperJS</h2>

<p>Now, it’s time to run CasperJS. Even though there are some
plugins exist for this, I’m using plain old
<code class="language-plaintext highlighter-rouge">exec-maven-plugin</code>,
mostly because it is more configurable.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>exec-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>casperjs-test<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;phase&gt;</span>integration-test<span class="nt">&lt;/phase&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>exec<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;executable&gt;</span>
          ${project.build.directory}/casperjs/bin/casperjs
        <span class="nt">&lt;/executable&gt;</span>
        <span class="nt">&lt;workingDirectory&gt;</span>${basedir}<span class="nt">&lt;/workingDirectory&gt;</span>
        <span class="nt">&lt;arguments&gt;</span>
          <span class="nt">&lt;argument&gt;</span>test<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>--verbose<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>--no-colors<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>--concise<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>--home=http://localhost:${tomcat.port}<span class="nt">&lt;/argument&gt;</span>
          <span class="nt">&lt;argument&gt;</span>${basedir}/src/test/casperjs<span class="nt">&lt;/argument&gt;</span>
        <span class="nt">&lt;/arguments&gt;</span>
        <span class="nt">&lt;environmentVariables&gt;</span>
          <span class="nt">&lt;PHANTOMJS_EXECUTABLE&gt;</span>${phantomjs.binary}<span class="nt">&lt;/PHANTOMJS_EXECUTABLE&gt;</span>
        <span class="nt">&lt;/environmentVariables&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>The environment variable <code class="language-plaintext highlighter-rouge">PHANTOMJS_EXECUTABLE</code> is the undocumented
feature that makes this whole scenario possible. It configures
the location of the PhantomJS executable, which was downloaded a few steps above.</p>

<h2 id="6-shutdown-tomcat">6. Shutdown Tomcat</h2>

<p>In the last step, I shut down the Tomcat server.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.maven<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>tomcat7-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;executions&gt;</span>
    <span class="nt">&lt;execution&gt;</span>
      <span class="nt">&lt;id&gt;</span>stop-tomcat<span class="nt">&lt;/id&gt;</span>
      <span class="nt">&lt;phase&gt;</span>post-integration-test<span class="nt">&lt;/phase&gt;</span>
      <span class="nt">&lt;goals&gt;</span>
        <span class="nt">&lt;goal&gt;</span>shutdown<span class="nt">&lt;/goal&gt;</span>
      <span class="nt">&lt;/goals&gt;</span>
    <span class="nt">&lt;/execution&gt;</span>
  <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<h2 id="real-example">Real Example</h2>

<p>If you want to see how this all works in action, take
a look at <a href="https://www.stateful.co">stateful.co</a>. It is a Java
Web application hosted at <a href="https://www.cloudbees.com">CloudBees</a>.
Its source code is open and available in <a href="https://github.com/sttc/stateful">GitHub</a>.</p>

<p>Its <a href="https://github.com/sttc/stateful/blob/sttc-1.5/pom.xml"><code class="language-plaintext highlighter-rouge">pom.xml</code></a>
contains exactly the same configurations explained above, but joined together.</p>

<p>If you have any questions, please don’t hesitate to ask below.</p>

<p>PS. Also, check this:
<a href="/2014/04/06/phandom.html">PhantomJS as an HTML Validator</a></p>

    </article>
  </body>
</html>
