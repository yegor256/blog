<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="The article gives arguments about why classes/objects in object-oriented programming have to be immutable, i.e. never modify their encapsulated state" /> <meta name="keywords" content="immutability in java, immutable class java, immutable java design pattern, java immutable object, java immutable object advantage, java immutable value object, java mutable immutable object" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-06-09 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Objects Should Be Immutable"/> <meta name="twitter:description" property="og:description" content="The article gives arguments about why classes/objects in object-oriented programming have to be immutable, i.e. never modify their encapsulated state"/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?218873848f7"/> <link rel="apple-touch-icon" href="/favicon.ico?218873848f7"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?218873848f7"/> <link rel="stylesheet" href="/css/icons.css?218873848f7"/> <link rel="canonical" href="https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html" /> <title>Objects Should Be Immutable</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;385</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html</code></p><h1 itemprop="name headline mainEntityOfPage">Objects Should Be Immutable</h1><aside class='book'><a href='http://amzn.to/2qFt4Tn'><img src='/images/books/elegant-objects/cover-eo1.png' class='book-cover' alt='book cover'/></a>Read more about this subject in <a href='http://amzn.to/2qFt4Tn'>Section&nbsp;2.6</a><br/> of my book<a href='http://amzn.to/2qFt4Tn'><img src='/images/books/amazon-buy-button.png' class='amazon-button' alt='Click to buy'/></a></aside><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-06-09T00:00:00+00:00"> 9 June 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><ul class="subline"> <li>Discussed at:</li> <li><a href="https://www.reddit.com/r/programming/comments/2ld05q/proper_objects_should_be_immutable_dont_you_think/">reddit</a></li></ul><p class="unprintable"><a href='/tag/oop.html' class='tag notranslate'><img src='/images/icons/cactus.svg' alt='OOP'/>oop</a></p><nav class="buttons notranslate desktop-only"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html&amp;text=Objects+Should+Be+Immutable" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="https://reddit.com/submit?url=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html%3F2014-23&amp;title=Objects+Should+Be+Immutable" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="https://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/06/09/objects-should-be-immutable.html%3F2014-23&amp;t=Objects+Should+Be+Immutable" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>In object-oriented programming, an object is <a href="http://en.wikipedia.org/wiki/Immutable_object">immutable</a> if its state can’t be modified after it is created. In Java, a good example of an immutable <a href="/2016/07/14/who-is-object.html">object</a> is <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/String.html"><code class="language-plaintext highlighter-rouge">String</code></a>. Once created, we can’t modify its state. We can request that it creates new strings, but its own state will never change.</p><p>However, there are not so many immutable classes in JDK. Take, for example, class <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Date.html"><code class="language-plaintext highlighter-rouge">Date</code></a>. It is possible to modify its state using <code class="language-plaintext highlighter-rouge">setTime()</code>.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=KwP7Ay9Z-hc"><div class="box"> <img src="https://i.ytimg.com/vi/KwP7Ay9Z-hc/mqdefault.jpg" alt="YouTube video #KwP7Ay9Z-hc" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Immutable Objects vs. Common Sense (webinar #2); 6 May 2015.</div></aside><p>I don’t know why the JDK designers decided to make these two very similar classes differently. However, I believe that the design of a mutable <code class="language-plaintext highlighter-rouge">Date</code> has many flaws, while the immutable <code class="language-plaintext highlighter-rouge">String</code> is much more in the spirit of the object-oriented paradigm.</p><p>Moreover, I think that <strong>all classes should be immutable in a perfect object-oriented world</strong>. Unfortunately, sometimes, it is technically not possible due to limitations in JVM. Nevertheless, we should always aim for the best.</p><p>This is an incomplete list of arguments in favor of immutability:</p><ul> <li>immutable objects are simpler to construct, test, and use</li> <li>truly immutable objects are always thread-safe</li> <li>they help to avoid <a href="/2015/12/08/temporal-coupling-between-method-calls.html">temporal coupling</a></li> <li>their usage is side-effect free (no defensive copies)</li> <li>identity mutability problem is avoided</li> <li>they always have <a href="https://stackoverflow.com/questions/29842845/">failure atomicity</a></li> <li>they are much easier to cache</li> <li>they prevent NULL references, <a href="/2014/05/13/why-null-is-bad.html">which are bad</a></li></ul><p>Let’s discuss the most important arguments one by one.</p><h2 id="thread-safety">Thread Safety</h2><p>The first and the most obvious argument is that immutable objects are thread-safe. This means that multiple threads can access the same object at the same time, without clashing with another thread.</p><figure class="badge"><a href="http://amzn.to/2bQVqBr"><img src="/images/2014/12/java-concurrency-in-practice.png" style="width:100px;max-width:100%;" alt="badge" /></a></figure><p>If no object methods can modify its state, no matter how many of them and how often are being called parallel—they will work in their own memory space in stack.</p><p>Goetz et al. explained the advantages of immutable objects in more details in their very famous book <a href="http://amzn.to/2bQVqBr">Java Concurrency in Practice</a> (highly recommended).</p><h2 id="avoiding-temporal-coupling">Avoiding Temporal Coupling</h2><p>Here is an example of temporal coupling (the code makes two consecutive HTTP POST requests, where the second one contains HTTP body):</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">"http://localhost"</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
<span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"text=hello"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>This code works. However, you must remember that the first request should be configured before the second one may happen. If we decide to remove the first request from the script, we will remove the second and the third line, and won’t get any errors from the compiler:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">"http://localhost"</span><span class="o">);</span>
<span class="c1">// request.method("POST");</span>
<span class="c1">// String first = request.fetch();</span>
<span class="n">request</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"text=hello"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>Now, the script is broken although it compiled without errors. This is what <a href="/2015/12/08/temporal-coupling-between-method-calls.html">temporal coupling</a> is about—there is always some hidden information in the code that a programmer has to remember. In this example, we have to remember that the configuration for the first request is also used for the second one.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=EnhRgXrHCC4"><div class="box"> <img src="https://i.ytimg.com/vi/EnhRgXrHCC4/mqdefault.jpg" alt="YouTube video #EnhRgXrHCC4" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>How Immutability Helps in OOP (in Russian with English subtitles); 21 May 2016.</div></aside><p>We have to remember that the second request should always stay together and be executed after the first one.</p><p>If <code class="language-plaintext highlighter-rouge">Request</code> class were immutable, the first snippet wouldn’t work in the first place, and would have been rewritten like:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">).</span><span class="na">fetch</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">).</span><span class="na">body</span><span class="o">(</span><span class="s">"text=hello"</span><span class="o">).</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>Now, these two requests are not coupled. We can safely remove the first one, and the second one will still work correctly. You may point out that there is a code duplication. Yes, we should get rid of it and re-write the code:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="kd">final</span> <span class="nc">Request</span> <span class="n">post</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"text=hello"</span><span class="o">).</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>See, refactoring didn’t break anything and we still don’t have temporal coupling. The first request can be removed safely from the code without affecting the second one.</p><p>I hope this example demonstrates that the code manipulating immutable objects is more readable and maintainable, because it doesn’t have <a href="/2015/12/08/temporal-coupling-between-method-calls.html">temporal coupling</a>.</p><h2 id="avoiding-side-effects">Avoiding Side Effects</h2><p>Let’s try to use our <code class="language-plaintext highlighter-rouge">Request</code> class in a new method (now it is mutable):</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">String</span> <span class="nf">post</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">);</span>
  <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p>Let’s try to make two requests—the first with GET method and the second with POST:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">"http://localhost"</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"GET"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>Method <code class="language-plaintext highlighter-rouge">post()</code> has a “side effect”—it makes changes to the mutable object <code class="language-plaintext highlighter-rouge">request</code>. These changes are not really expected in this case. We expect it to make a POST request and return its body. We don’t want to read its documentation just to find out that behind the scene it also modifies the request we’re passing to it as an argument.</p><p>Needless to say, such side effects lead to bugs and maintainability issues. It would be much better to work with an immutable <code class="language-plaintext highlighter-rouge">Request</code>:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">String</span> <span class="nf">post</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="s">"POST"</span><span class="o">).</span><span class="na">fetch</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p>In this case, we may not have any side effects. Nobody can modify our <code class="language-plaintext highlighter-rouge">request</code> object, no matter where it is used and how deep through the call stack it is passed by method calls:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">(</span><span class="s">"http://localhost"</span><span class="o">).</span><span class="na">method</span><span class="o">(</span><span class="s">"GET"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">second</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
</code></pre></div></div><p>This code is perfectly safe and side effect free.</p><h2 id="avoiding-identity-mutability">Avoiding Identity Mutability</h2><p>Very often, we want objects to be identical if their internal states are the same. <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Date.html"><code class="language-plaintext highlighter-rouge">Date</code></a> class is a good example:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Date</span> <span class="n">first</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="nc">Date</span> <span class="n">second</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="k">assert</span> <span class="n">first</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">second</span><span class="o">);</span> <span class="c1">// true</span>
</code></pre></div></div><p>There are two different objects; however, they are equal to each other because their encapsulated states are the same. This is made possible through their custom overloaded implementation of <code class="language-plaintext highlighter-rouge">equals()</code> and <code class="language-plaintext highlighter-rouge">hashCode()</code> methods.</p><p>The consequence of this convenient approach being used with mutable objects is that every time we modify object’s state it changes its identity:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Date</span> <span class="n">first</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="nc">Date</span> <span class="n">second</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="n">first</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="mi">2L</span><span class="o">);</span>
<span class="k">assert</span> <span class="n">first</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">second</span><span class="o">);</span> <span class="c1">// false</span>
</code></pre></div></div><p>This may look natural, until you start using your mutable objects as keys in maps:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Date</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="s">"hello, world!"</span><span class="o">);</span>
<span class="n">date</span><span class="o">.</span><span class="na">setTime</span><span class="o">(</span><span class="mi">12345L</span><span class="o">);</span>
<span class="k">assert</span> <span class="n">map</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">date</span><span class="o">);</span> <span class="c1">// false</span>
</code></pre></div></div><p>When modifying the state of <code class="language-plaintext highlighter-rouge">date</code> object, we’re not expecting it to change its identity. We’re not expecting to lose an entry in the map just because the state of its key is changed. However, this is exactly what is happening in the example above.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=p7m7_iiqaHI"><div class="box"> <img src="https://i.ytimg.com/vi/p7m7_iiqaHI/mqdefault.jpg" alt="YouTube video #p7m7_iiqaHI" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>How Much Immutability Is Enough?; 19 May 2016.</div></aside><p>When we add an object to the map, its <code class="language-plaintext highlighter-rouge">hashCode()</code> returns one value. This value is used by <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html"><code class="language-plaintext highlighter-rouge">HashMap</code></a> to place the entry into the internal hash table. When we call <code class="language-plaintext highlighter-rouge">containsKey()</code> hash code of the object is different (because it is based on its internal state) and <code class="language-plaintext highlighter-rouge">HashMap</code> can’t find it in the internal hash table.</p><p>It is a very annoying and difficult to debug side effects of mutable objects. Immutable objects avoid it completely.</p><h2 id="failure-atomicity">Failure Atomicity</h2><p>Here is a simple example:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stack</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">items</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="nc">String</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">size</span><span class="o">++;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"stack overflow"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">items</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="n">item</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>It is obvious that an object of class <code class="language-plaintext highlighter-rouge">Stack</code> will be left in a broken state if it <a href="/2015/12/01/rethrow-exceptions.html">throws</a> a runtime exception on overflow. Its <code class="language-plaintext highlighter-rouge">size</code> property will be incremented, while <code class="language-plaintext highlighter-rouge">items</code> won’t get a new element.</p><figure class="badge"><a href="http://amzn.to/2cs4aiR"><img src="/images/2014/06/effective-java-second-edition.png" style="width:100px;max-width:100%;" alt="badge" /></a></figure><p>Immutability prevents this problem. An object will never be left in a broken state because its state is modified only in its constructor. The constructor will either fail, rejecting object instantiation, or succeed, making a valid solid object, which never changes its encapsulated state.</p><p>For more on this subject, read <a href="http://amzn.to/2cs4aiR"><em>Effective Java</em></a> by Joshua Bloch.</p><h2 id="arguments-against-immutability">Arguments Against Immutability</h2><p>There are a number of arguments against immutability.</p><ol> <li><p>“Immutability is not for enterprise systems”. Very often, I hear people say that immutability is a fancy feature, while absolutely impractical in real enterprise systems. As a counter-argument, I can only show some examples of real-life applications that contain only immutable Java objects: <a href="http://http.jcabi.com"><code class="language-plaintext highlighter-rouge">jcabi-http</code></a>, <a href="/2014/04/24/java-xml-parsing-and-traversing.html"><code class="language-plaintext highlighter-rouge">jcabi-xml</code></a>, <a href="/2014/05/14/object-oriented-github-java-sdk.html"><code class="language-plaintext highlighter-rouge">jcabi-github</code></a>, <a href="/2014/05/26/amazon-s3-java-oop-adapter.html"><code class="language-plaintext highlighter-rouge">jcabi-s3</code></a>, <a href="/2014/04/14/jcabi-dynamo-java-api-of-aws-dynamodb.html"><code class="language-plaintext highlighter-rouge">jcabi-dynamo</code></a>, <a href="/2014/04/29/w3c-java-validators.html"><code class="language-plaintext highlighter-rouge">jcabi-w3c</code></a>, <a href="/2014/08/18/fluent-jdbc-decorator.html"><code class="language-plaintext highlighter-rouge">jcabi-jdbc</code></a>, <a href="http://simpledb.jcabi.com"><code class="language-plaintext highlighter-rouge">jcabi-simpledb</code></a>, <a href="/2014/09/02/java-ssh-client.html"><code class="language-plaintext highlighter-rouge">jcabi-ssh</code></a>. The above are all Java libraries that work solely with immutable classes/objects. <a href="https://github.com/netbout/netbout">netbout.com</a> and <a href="/2014/12/04/synchronization-between-nodes.html">stateful.co</a> are web applications that work solely with immutable objects.</p></li> <li><p>“It’s cheaper to update an existing object than create a new one”. Oracle <a href="http://docs.oracle.com/javase/tutorial/essential/concurrency/immutable.html">thinks</a> that “The impact of object creation is often overestimated and can be offset by some of the efficiency associated with immutable objects. These include decreased overhead due to garbage collection, and the elimination of code needed to protect mutable objects from corruption.” I agree.</p></li> </ol><p>If you have some other arguments, please post them below and I’ll try to comment.</p><p>P.S. Check <a href="http://www.takes.org">takes.org</a>, a Java web framework that consists entirely of immutable objects.</p></div></article></div><div class="wrapper" aria-hidden="true"><div class="unprintable"> <hr/><p>If you like this article, you will definitely like these <strong>very relevant</strong> posts too:</p><p><a href='/2014/12/22/immutable-objects-not-dumb.html'><strong>Immutable Objects Are Not Dumb</strong></a><br/>Immutable objects are not the same as passive data structures without setters, despite a very common mis-belief.</p><p><a href='/2014/12/09/immutable-object-state-and-behavior.html'><strong>How an Immutable Object Can Have State and Behavior?</strong></a><br/>Object state and behavior are two very different things, and confusing the two often leads to incorrect design.</p><p><a href='/2016/09/07/gradients-of-immutability.html'><strong>Gradients of Immutability</strong></a><br/>There are a few levels and forms of immutability in object-oriented programming, all of which can be used when they seem appropriate.</p></div></div><div class="disqus" role="complementary" aria-hidden="true"><p class="disqus_hint" > Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?218873848f7"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
