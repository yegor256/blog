<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Basic HTTP Auth for S3 Buckets</title>
    <link rel="canonical" href="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html"
        },
        "headline": "Basic HTTP Auth for S3 Buckets",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-04-21",
        "dateModified": "2014-04-21",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "Since Amazon S3 doesn't allow you to secure access
to buckets with HTTP Basic Authentication, I've created
a free cloud service for this purpose
",
        "keywords": ["amazon s3 basic auth", "amazon s3 bucket authentication", "aws s3 basic auth", "basic auth s3", "http basic auth"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2014/04/21/s3-http-basic-auth.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>21 April 2014</p>
      <h1>Basic HTTP Auth for S3 Buckets</h1>
      

<p><a href="http://aws.amazon.com/s3/">Amazon S3</a> is a simple and very useful storage of
binary objects (aka “files”). To use it, you create a “bucket” there with a
unique name and upload your objects.</p>

<p>Afterwards, AWS guarantees your object will be available for download through
their <a href="http://docs.aws.amazon.com/AmazonS3/latest/API/APIRest.html">RESTful API</a>.</p>

<p>A few years ago, AWS introduced a S3 feature called
<a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html">static website hosting</a>.</p>

<p>With static website hosting, you simply turn on the feature and all objects in
your bucket become available through public HTTP. This is an awesome feature for
hosting static content, such as images, JavaScript files, video and audio
content.</p>

<p>When using the hosting, you need to change the CNAME record in your DNS so that
it points to <code class="language-plaintext highlighter-rouge">www.example.com.aws.amazon.com</code>. After changing the DNS entry,
your static website is available at <code class="language-plaintext highlighter-rouge">www.example.com</code> just as it would be
normally.</p>

<p>When using Amazon S3, though, it is not possible to protect your website because
the content is purely static. This means you can’t have a login page on the
front end. With the service, you can either make your objects either absolutely
public—so that anyone can see them online—or assign access
rights to them—but only for users connected through RESTful API.</p>



<p>My use case with the service was a bit more complex, though. I wanted to host my
static content as S3 objects. However, I wanted to do this while ensuring only a
few people had access to the content using their Web browsers.</p>

<h2 id="http-basic-authentication">HTTP Basic Authentication</h2>

<p>The HTTP protocol offers a nice
<a href="https://en.wikipedia.org/wiki/Basic_access_authentication">“basic access authentication”</a>
feature that doesn’t require any extra site pages.</p>

<p>When an HTTP request arrives at the server, it doesn’t deliver the content but
replies with a 401 status response. This response means literally “I don’t know
who you are, please authenticate yourself.”</p>

<p>The browser shows its native login screen and prompts for a user name and
password. After entering the login credentials, they are concatenated,
<a href="https://en.wikipedia.org/wiki/Base64">Base64</a> encoded, and added to the next
request in <code class="language-plaintext highlighter-rouge">Authorization</code> HTTP header.</p>



<p>Now, the browser tries to make another attempt to fetch the same webpage. But,
this time, the HTTP request contains a header:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Authorization: Basic am9lOnNlY3JldA==
</code></pre></div></div>

<p>The above is just an example. In the example, the Base64 encoded part means
<code class="language-plaintext highlighter-rouge">joe:secret</code>, where <code class="language-plaintext highlighter-rouge">joe</code> is the user name and <code class="language-plaintext highlighter-rouge">secret</code> the password entered by
the user.</p>

<p>This time the server has authentication information and can make a decision
whether this user is authenticated (his password matches the server’s records)
and authorized (he has permission to access the request webpage).</p>

<h2 id="s3authcom"><code class="language-plaintext highlighter-rouge">s3auth.com</code></h2>

<p>Since Amazon doesn’t provide this feature, I decided to create a simple web
service, <a href="https://www.s3auth.com">s3auth.com</a>, which stays in front of my Amazon
S3 buckets and implements the HTTP-native authentication and authorization
mechanism.</p>

<p>Instead of making my objects public, though, I make them private and point my
CNAME record to <code class="language-plaintext highlighter-rouge">relay.s3auth.com</code>. HTTP requests from Web browsers then arrive
at my server, connect to Amazon S3, retrieve my objects and deliver them back in
HTTP responses.</p>

<p>The server implements authentication and authorization using a special file
<code class="language-plaintext highlighter-rouge">.htpasswd</code> in the root of my bucket. The format of the <code class="language-plaintext highlighter-rouge">.htpasswd</code> file is
identical to the one used by
<a href="http://httpd.apache.org/docs/2.2/programs/htpasswd.html">Apache HTTP Server</a>—one user
per line. Every line has the name of a user and a hash version of his password.</p>

<h2 id="implementation">Implementation</h2>

<p>I made this software open source mostly to guarantee to my users that the server
doesn’t store their private data anywhere, but rather acts only as a
pass-through service. As a result, the software is on
<a href="https://github.com/yegor256/s3auth">GitHub</a>.</p>

<p>For the sake of privacy and convenience, I use only OAuth2 for user accounts.
This means that I don’t know who my users are. I don’t possess their names or
emails, but only their account numbers in Facebook, Google Plus or GitHub. Of
course, I can find their names using these numbers, but this information is
public anyway.</p>

<p>The server is implemented in Java6. For its hosting, I’m using a single Amazon
EC2 <a href="http://aws.amazon.com/ec2/instance-types/">m1.small</a> Ubuntu server. These
days, the server seems to work properly and is stable.</p>

<h2 id="extra-features">Extra Features</h2>

<p>Besides authentication and authorization, the
<a href="https://www.s3auth.com">s3auth.com</a> server can render lists of pages—just like Apache HTTP Server. If you have a collection of objects in your bucket—but the <code class="language-plaintext highlighter-rouge">index.html</code> file is missing—Amazon S3 delivers a “page
not found” result. Conversely, my server displays a list of objects in the
bucket, when no <code class="language-plaintext highlighter-rouge">index.html</code> is present, and makes it possible to navigate up or
down one folder.</p>

<p>When your bucket has the versioning feature turned on, you are able to list all
versions of any object in the browser. To do this, just add <code class="language-plaintext highlighter-rouge">?all-versions</code> to
the end of the URL to display the list. Next, click a version to have
<a href="https://www.s3auth.com">s3auth.com</a> retrieve and render it.</p>

<h2 id="traction">Traction</h2>

<p>I created this service mostly for myself, but apparently I’m not the only with
the problems described above. At the moment, <a href="https://www.s3auth.com">s3auth.com</a>
hosts over 300 domains and sends through more than 10Mb of data each hour.</p>

<p>PS. This post explains how <a href="https://www.s3auth.com">s3auth.com</a> can be
used as a front-end to your Maven repository:
<a href="/2015/09/07/maven-repository-amazon-s3.html">How to Set Up a Private Maven Repository in Amazon S3</a>.</p>

    </article>
  </body>
</html>
