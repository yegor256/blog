<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Liquibase with Maven</title>
    <link rel="canonical" href="https://www.yegor256.com/2014/07/20/liquibase-in-maven.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/07/20/liquibase-in-maven.html"
        },
        "headline": "Liquibase with Maven",
        "image": {
          "@type": "ImageObject",
          "url": "http://www.yegor256.com/images/face-1200x1200.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-07-20",
        "dateModified": "2014-07-20",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "http://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "Liquibase is a convenient tool for database migration
management. Here, I explain how to use it with Maven projects.
",
        "keywords": ["liquibase integration testing java", "liquibase java mysql", "liquibase java postgresql", "liquibase java test", "liquibase maven example", "liquibase maven integration test", "liquibase maven mysql"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2014/07/20/liquibase-in-maven.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>20 July 2014</p>
      <h1>Liquibase with Maven</h1>
      <p><a href="http://www.liquibase.org">Liquibase</a> is a migration management tool
for relational databases. It versionalizes schema and data changes in
a database; similar to the way Git or SVN works for source code.
Thanks to their <a href="http://www.liquibase.org/documentation/maven/">Maven plugin</a>,
Liquibase can be used as a part
of a build automation scenario.</p>



<h2 id="maven-plugin">Maven Plugin</h2>

<p>Let’s assume you’re using MySQL (PostgreSQL or any other
database configuration will be very similar.)</p>

<p>Add <code>liquibase-maven-plugin</code>
to your <a href="http://maven.apache.org/pom.html"><code>pom.xml</code></a> (get its latest
version in <a href="http://search.maven.org/">Maven Central</a>):</p>

<pre>&lt;project&gt;
  [...]
  &lt;build&gt;
    [...]
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.liquibase&lt;/groupId&gt;
        &lt;artifactId&gt;liquibase-maven-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;changeLogFile&gt;
            ${basedir}/src/main/liquibase/master.xml
          &lt;/changeLogFile&gt;
          &lt;driver&gt;com.mysql.jdbc.Driver&lt;/driver&gt;
          &lt;url&gt;jdbc:mysql://${mysql.host}:${mysql.port}/${mysql.db}&lt;/url&gt;
          &lt;username&gt;${mysql.login}&lt;/username&gt;
          &lt;password&gt;${mysql.password}&lt;/password&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;</pre>

<p>To check that it works, run <code>mvn liquibase:help</code>.</p>

<p>I would recommend you keep database credentials
in <a href="http://maven.apache.org/settings.html"><code>settings.xml</code></a>
and  in their respective profiles. For example:</p>

<pre>&lt;settings&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;production&lt;/id&gt;
      &lt;properties&gt;
        &lt;mysql.host&gt;db.example.com&lt;/mysql.host&gt;
        &lt;mysql.port&gt;3306&lt;/mysql.port&gt;
        &lt;mysql.db&gt;example&lt;/mysql.db&gt;
      &lt;/properties&gt;
    &lt;/profile&gt;
    &lt;profile&gt;
      &lt;id&gt;test&lt;/id&gt;
      &lt;properties&gt;
        &lt;mysql.host&gt;test-db.example.com&lt;/mysql.host&gt;
        &lt;mysql.port&gt;3306&lt;/mysql.port&gt;
        &lt;mysql.db&gt;example-db&lt;/mysql.db&gt;
      &lt;/properties&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
&lt;/settings&gt;</pre>

<p>When you run Maven, don’t forget to turn
on one of the profiles. For example: <code>mvn -Pproduction</code>.</p>

<h2 id="initial-schema">Initial Schema</h2>

<p>I assume you already have a database with
a schema (tables, triggers, views, etc.) and some data.
You should “reverse engineer” it and create an initial schema
file for Liquibase. In other words, we should inform Liquibase
where we are at the moment, so that it starts to apply
changes from this point.</p>

<p>Maven plugin doesn’t support it, so you will have to run
Liquibase directly. But, it’s not that difficult. First,
run <code>mvn liquibase:help</code> in order to download all artifacts.
Then, replace placeholders with your actual credentials:</p>

<pre>$ java -jar \
  ~/.m2/repository/org/liquibase/liquibase-core/3.1.1/liquibase-core-3.1.1.jar \
  --driver=com.mysql.jdbc.Driver \
  --url=jdbc:mysql://db.example.com:3306/example \
  --username=example --password=example \
  generateChangeLog &gt; src/main/liquibase/2014/000-initial-schema.xml</pre>

<p>Liquibase will analyze your current database schema
and copy its own schema into <code>src/main/liquibase/2014/000-initial-schema.xml</code>.</p>

<h2 id="master-changeset">Master Changeset</h2>

<p>Now, create XML master changeset and save it to <code>src/main/liquibase/master.xml</code>:</p>

<pre>&lt;databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd"&gt;
  &lt;includeAll path="src/main/liquibase/2014" /&gt;
&lt;/databaseChangeLog&gt;</pre>

<p>It is an entry point for Liquibase. It starts from this file
and loads all other changesets available in <code>src/main/liquibase/2014</code>.
They should be either <code>.xml</code> or <code>.sql</code>. I recommend that you use
XML mostly because it is easier to maintain and works faster.</p>

<h2 id="incremental-changesets">Incremental Changesets</h2>

<p>Let’s create a simple changeset, which adds a new column to an existing table:</p>

<pre>&lt;databaseChangeLog xmlns='http://www.liquibase.org/xml/ns/dbchangelog'
  xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
  xsi:schemaLocation='http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd'&gt;
  &lt;changeSet id="002" author="Yegor"&gt;
    &lt;sql&gt;
      ALTER TABLE user ADD COLUMN address VARCHAR(1024);
    &lt;/sql&gt;
  &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</pre>

<p>We save this file in <code>src/main/liquibase/2014/002-add-user-address.xml</code>.
In big projects, you can name your files by the names of the tickets
they are produced in. For example, <code>045-3432.xml</code>, which means changeset
number 45 coming from ticket #3432.</p>

<p>The important thing is to have this numeric prefix in front of file names,
in order to sort them correctly. We want changes to be applied in their
correct chronological order.</p>

<p>That’s it. We’re ready to run <code>mvn liquibase:update -Pproduction</code> and
our production database will be updated—a new column will be
added to the <code>user</code> table.</p>

<p>Also, see how <a href="/2014/05/21/mysql-maven-plugin.html">MySQL Maven Plugin</a>
can help you to automate integration testing of database-connected classes.</p>

    </article>
  </body>
</html>
