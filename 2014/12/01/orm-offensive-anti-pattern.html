<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Object-relational mapping is a design pattern that violates encapsulation, one of the fundamental principles of OOP, but what is a possible alternative to it?" /> <meta name="keywords" content="object relational mapping, object relational mapping tools, object relational mapping tutorials, orm is an anti-pattern, orm is antipattern" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2014-12-01 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="ORM Is an Offensive Anti-Pattern"/> <meta name="twitter:description" property="og:description" content="Object-relational mapping is a design pattern that violates encapsulation, one of the fundamental principles of OOP, but what is a possible alternative to it?"/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?7f69172ff02"/> <link rel="apple-touch-icon" href="/favicon.ico?7f69172ff02"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?7f69172ff02"/> <link rel="stylesheet" href="/css/icons.css?7f69172ff02"/> <link rel="canonical" href="https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html" /> <title>ORM Is an Offensive Anti-Pattern </title> <meta name='og:image' content='https://www.yegor256.com/images/2014/11/broken-object.png'/><meta name='twitter:image' content='https://www.yegor256.com/images/2014/11/broken-object.png'/><meta name='og:image:width' content='1287'/> <meta name='twitter:image:width' content='1287'/><meta name='og:image:height' content='784'/> <meta name='twitter:image:height' content='784'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Vinni-Pukh (1969) by Fyodor Khitruk'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;370</a></li> <li ><a href="/webinars.html" title="My webinars">Webinars</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul> <li> Are you a Java developer? Ready to move to Moscow (Russia) and join my team for a full-time employment in Fortune-100 company? We are working with <a href="https://www.eolang.org">EO</a>, a new programming language. <a href="mailto:job@yegor256.com">Email me</a>, we'll discuss. </li></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html</code></p><h1 itemprop="name headline mainEntityOfPage">ORM Is an Offensive Anti-Pattern</h1><aside class='book'><a href='http://amzn.to/2pyceWc'><img src='/images/books/elegant-objects/cover-eo2.png' class='book-cover' alt='book cover'/></a>Read more about this subject in <a href='http://amzn.to/2pyceWc'>Section&nbsp;6.5</a><br/> of my book<a href='http://amzn.to/2pyceWc'><img src='/images/books/amazon-buy-button.png' class='amazon-button' alt='Click to buy'/></a></aside><ul class="subline"> <li> <time itemprop="datePublished" datetime="2014-12-01T00:00:00+00:00"> 1 December 2014 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><ul class="unprintable subline"> <li>Translated:</li> <li><a href="http://tbd.kaitoy.xyz/2015/09/13/orm-is-offensive-anti-pattern/">Japanese</a></li> <li><a href="mailto:translate@yegor256.com">add yours!</a></li></ul><ul class="subline"> <li>Discussed at:</li> <li><a href="https://news.ycombinator.com/item?id=8686346">hackernews</a></li> <li><a href="https://www.reddit.com/r/programming/comments/2nx4vq/orm_is_an_offensive_antipattern/">reddit</a></li></ul><p class="unprintable"><a href='/tag/oop.html' class='tag notranslate'><img src='/images/books/elegant-objects/cactus.svg' alt='OOP'/>oop</a></p><nav class="buttons notranslate desktop-only"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html&amp;text=ORM+Is+an+Offensive+Anti-Pattern" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="https://reddit.com/submit?url=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html%3F2014-48&amp;title=ORM+Is+an+Offensive+Anti-Pattern" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="https://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2014/12/01/orm-offensive-anti-pattern.html%3F2014-48&amp;t=ORM+Is+an+Offensive+Anti-Pattern" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>TL;DR ORM is a terrible <a href="/2016/02/03/design-patterns-and-anti-patterns.html">anti-pattern</a> that violates all principles of object-oriented programming, tearing <a href="/2016/07/14/who-is-object.html">objects</a> apart and turning them into dumb and passive data bags. There is no excuse for ORM existence in any application, be it a small web app or an enterprise-size system with thousands of tables and CRUD manipulations on them. What is the alternative? <strong>SQL-speaking objects</strong>.</p><figure class="jb_picture"><img itemprop="image" alt="Vinni-Pukh (1969) by Fyodor Khitruk" src="/images/2014/11/broken-object.png" longdesc="#6ad080f0" /><figcaption id="6ad080f0">Vinni-Pukh (1969) by Fyodor Khitruk</figcaption></figure><h2 id="how-orm-works">How ORM Works</h2><p><a href="https://en.wikipedia.org/wiki/Object-relational_mapping">Object-relational mapping</a> (ORM) is a technique (a.k.a. design pattern) of accessing a relational database from an object-oriented language (Java, for example). There are multiple implementations of ORM in almost every language; for example: <a href="http://hibernate.org/orm/">Hibernate</a> for Java, <a href="/2016/07/26/active-record.html">ActiveRecord</a> for Ruby on Rails, <a href="http://www.doctrine-project.org/">Doctrine</a> for PHP, and <a href="http://www.sqlalchemy.org/">SQLAlchemy</a> for Python. In Java, the ORM design is even standardized as <a href="https://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a>.</p><p>First, let’s see how ORM works, by example. Let’s use Java, PostgreSQL, and Hibernate. Let’s say we have a single table in the database, called <code class="highlighter-rouge">post</code>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">+-----+------------+--------------------------+
| id  | date       | title                    |
+-----+------------+--------------------------+
|   9 | 10/24/2014 | How to cook a sandwich   |
|  13 | 11/03/2014 | My favorite movies       |
|  27 | 11/17/2014 | How much I love my job   |
+-----+------------+--------------------------+</code></pre></figure> <aside class="youtube"> <a href="https://www.youtube.com/watch?v=DEqcn4-freM"><div class="box"> <img src="https://i.ytimg.com/vi/DEqcn4-freM/mqdefault.jpg" alt="YouTube video #DEqcn4-freM" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Why ORM is an Anti-Pattern? (webinar #10); 6 January 2016.</div></aside><p>Now we want to CRUD-manipulate this table from our Java app (CRUD stands for create, read, update, and delete). First, we should create a <code class="highlighter-rouge">Post</code> class (I’m sorry it’s so long, but that’s the best I can do):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"post"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Date</span> <span class="n">date</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>
  <span class="nd">@Id</span>
  <span class="nd">@GeneratedValue</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Temporal</span><span class="o">(</span><span class="nc">TemporalType</span><span class="o">.</span><span class="na">TIMESTAMP</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">date</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Title</span> <span class="nf">getTitle</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">title</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="nc">Date</span> <span class="n">when</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">when</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">txt</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Before any operation with Hibernate, we have to create a session factory:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">SessionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfiguration</span><span class="o">()</span>
  <span class="o">.</span><span class="na">configure</span><span class="o">()</span>
  <span class="o">.</span><span class="na">addAnnotatedClass</span><span class="o">(</span><span class="nc">Post</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">buildSessionFactory</span><span class="o">();</span></code></pre></figure><p>This factory will give us “sessions” every time we want to manipulate with <code class="highlighter-rouge">Post</code> objects. Every manipulation with the session should be wrapped in this code block:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="nc">Transaction</span> <span class="n">txn</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
  <span class="c1">// your manipulations with the ORM, see below</span>
  <span class="n">txn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">HibernateException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">txn</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure><p>When the session is ready, here is how we get a list of all posts from that database table:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">List</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"FROM Post"</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Post</span> <span class="n">post</span> <span class="o">:</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;)</span> <span class="n">posts</span><span class="o">){</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Title: "</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="na">getTitle</span><span class="o">());</span>
<span class="o">}</span></code></pre></figure><p>I think it’s clear what’s going on here. Hibernate is a big, powerful engine that makes a connection to the database, executes necessary SQL <code class="highlighter-rouge">SELECT</code> requests, and retrieves the data. Then it makes instances of class <code class="highlighter-rouge">Post</code> and stuffs them with the data. When the object comes to us, it is filled with data, and we should use getters to take them out, like we’re using <code class="highlighter-rouge">getTitle()</code> above.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=aER4uwyFbqQ"><div class="box"> <img src="https://i.ytimg.com/vi/aER4uwyFbqQ/mqdefault.jpg" alt="YouTube video #aER4uwyFbqQ" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>ORM is offensive (in Russian with English subtitles); 24 April 2016.</div></aside><p>When we want to do a reverse operation and send an object to the database, we do all of the same but in reverse order. We make an instance of class <code class="highlighter-rouge">Post</code>, stuff it with the data, and ask Hibernate to save it:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Post</span><span class="o">();</span>
<span class="n">post</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
<span class="n">post</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"How to cook an omelette"</span><span class="o">);</span>
<span class="n">session</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">post</span><span class="o">);</span></code></pre></figure><p>This is how almost every ORM works. The basic principle is always the same—ORM objects are <a href="/2016/07/06/data-transfer-object.html">anemic envelopes</a> with data. We are talking with the ORM framework, and the framework is talking to the database. Objects only help us send our requests to the ORM framework and understand its response. Besides <a href="/2016/07/18/law-of-demeter.html">getters and setters</a>, objects have no other methods. They don’t even know which database they came from.</p><p>This is how object-relational mapping works.</p><p>What’s wrong with it, you may ask? Everything!</p><h2 id="whats-wrong-with-orm">What’s Wrong With ORM?</h2><p>Seriously, what is wrong? Hibernate has been one of the most popular Java libraries for more than 10 years already. Almost every SQL-intensive application in the world is using it. Each Java tutorial would mention Hibernate (or maybe <a href="https://en.wikipedia.org/wiki/List_of_object-relational_mapping_software">some other ORM</a> like TopLink or OpenJPA) for a database-connected application. It’s a standard <em>de-facto</em> and still I’m saying that it’s wrong? Yes.</p><p>I’m claiming that the entire idea behind ORM is wrong. Its invention was maybe the second big mistake in <a href="/2016/08/15/what-is-wrong-object-oriented-programming.html">OOP</a> after <a href="/2014/05/13/why-null-is-bad.html">NULL reference</a>.</p><aside class="quote">ORM, instead of encapsulating database interaction inside an object, extracts it away, literally tearing a solid and cohesive living organism apart. </aside><p>Actually, I’m not the only one saying something like this, and definitely not the first. A lot about this subject has already been published by very respected authors, including <a href="http://martinfowler.com/bliki/OrmHate.html">OrmHate</a> by Martin Fowler (not against ORM, but worth mentioning anyway), <a href="http://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/">Object-Relational Mapping Is the Vietnam of Computer Science</a> by Jeff Atwood, <a href="http://blogs.tedneward.com/post/the-vietnam-of-computer-science/">The Vietnam of Computer Science</a> by Ted Neward, <a href="http://seldo.com/weblog/2011/08/11/orm_is_an_antipattern">ORM Is an Anti-Pattern</a> by Laurie Voss, and many others.</p><p>However, my argument is different than what they’re saying. Even though their reasons are practical and valid, like “ORM is slow” or “database upgrades are hard,” they miss the main point. You can see a very good, practical answer to these practical arguments given by Bozhidar Bozhanov in his <a href="http://techblog.bozho.net/orm-haters-dont-get-it/">ORM Haters Don’t Get It</a> blog post.</p><figure class="badge"><img src="/images/2014/11/orm-anti-pattern.svg" style="width:413px;max-width:100%;" alt="badge" /></figure><p>The main point is that ORM, instead of encapsulating database interaction inside an object, extracts it away, literally tearing a solid and cohesive <a href="/2014/11/20/seven-virtues-of-good-object.html">living organism</a> apart. One part of the object keeps the data while another one, implemented inside the ORM engine (session factory), knows how to deal with this data and transfers it to the relational database. Look at this picture; it illustrates what ORM is doing.</p><p>I, being a reader of posts, have to deal with two components: 1) the ORM and 2) the “ob-truncated” object returned to me. The behavior I’m interacting with is supposed to be provided through a single entry point, which is an object in OOP. In the case of ORM, I’m getting this behavior via <strong>two</strong> entry points—the ORM engine and the “thing,” which we can’t even call an object.</p><p>Because of this terrible and offensive violation of the object-oriented paradigm, we have a lot of practical issues already mentioned in respected publications. I can only add a few more.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=63tS3HNmhiE"><div class="box"> <img src="https://i.ytimg.com/vi/63tS3HNmhiE/mqdefault.jpg" alt="YouTube video #63tS3HNmhiE" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>ORM is a perfect anti-pattern; 23 May 2016.</div></aside><p><strong>SQL Is Not Hidden</strong>. Users of ORM have to speak SQL (or its dialect, like <a href="https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/queryhql.html">HQL</a>). See the example above; we’re calling <code class="highlighter-rouge">session.createQuery("FROM Post")</code> in order to get all posts. Even though it’s not SQL, it is very similar to it. Thus, the relational model is not encapsulated inside objects. Instead, it is exposed to the entire application. Everybody, with each object, inevitably has to deal with a relational model in order to get or save something. Thus, ORM doesn’t hide and wrap the SQL but pollutes the entire application with it.</p><p><strong>Difficult to Test</strong>. When some object is working with a list of posts, it needs to deal with an instance of <code class="highlighter-rouge">SessionFactory</code>. How can we <a href="/2014/09/23/built-in-fake-objects.html">mock</a> this dependency? We have to create a mock of it? How complex is this task? Look at the code above, and you will realize how verbose and cumbersome that unit test will be. Instead, we can write integration tests and connect the entire application to a test version of PostgreSQL. In that case, there is no need to mock <code class="highlighter-rouge">SessionFactory</code>, but such tests will be rather slow, and even more important, our having-nothing-to-do-with-the-database objects will be tested against the database instance. A terrible design.</p><p>Again, let me reiterate. Practical problems of ORM are just consequences. The fundamental drawback is that ORM tears objects apart, terribly and offensively violating the very idea of <a href="/2014/11/20/seven-virtues-of-good-object.html">what an object is</a>.</p><h2 id="sql-speaking-objects">SQL-Speaking Objects</h2><figure class="badge"><img src="/images/2014/11/sql-speaking-object.svg" style="width:213px;max-width:100%;" alt="badge" /></figure><p>What is the alternative? Let me show it to you by example. Let’s try to design that class, <code class="highlighter-rouge">Post</code>, my way. We’ll have to break it down into two classes: <code class="highlighter-rouge">Post</code> and <code class="highlighter-rouge">Posts</code>, singular and plural. I already mentioned in one of my previous <a href="/2014/11/20/seven-virtues-of-good-object.html">articles</a> that a good object is always an abstraction of a real-life entity. Here is how this principle works in practice. We have two entities: database table and table row. That’s why we’ll make two classes; <code class="highlighter-rouge">Posts</code> will represent the table, and <code class="highlighter-rouge">Post</code> will represent the row.</p><p>As I also mentioned in that <a href="/2014/11/20/seven-virtues-of-good-object.html">article</a>, every object should work by contract and implement an interface. Let’s start our design with two <a href="/2016/04/26/why-inputstream-design-is-wrong.html">interfaces</a>. Of course, our objects will be <a href="/2014/12/22/immutable-objects-not-dumb.html">immutable</a>. Here is how <code class="highlighter-rouge">Posts</code> would look:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Posts</span> <span class="o">{</span>
  <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">iterate</span><span class="o">();</span>
  <span class="nc">Post</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Date</span> <span class="n">date</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>This is how a single <code class="highlighter-rouge">Post</code> would look:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Post</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="nf">id</span><span class="o">();</span>
  <span class="nc">Date</span> <span class="nf">date</span><span class="o">();</span>
  <span class="nc">String</span> <span class="nf">title</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure><p>Here is how we will list all posts in the database table:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Posts</span> <span class="n">posts</span> <span class="o">=</span> <span class="c1">// we'll discuss this right now</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Post</span> <span class="n">post</span> <span class="o">:</span> <span class="n">posts</span><span class="o">.</span><span class="na">iterate</span><span class="o">()){</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Title: "</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="na">title</span><span class="o">());</span>
<span class="o">}</span></code></pre></figure><p>Here is how we will create a new post:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Posts</span> <span class="n">posts</span> <span class="o">=</span> <span class="c1">// we'll discuss this right now</span>
<span class="n">posts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(),</span> <span class="s">"How to cook an omelette"</span><span class="o">);</span></code></pre></figure><p>As you see, we have true objects now. They are in charge of all operations, and they perfectly hide their implementation details. There are no transactions, sessions, or factories. We don’t even know whether these objects are actually talking to the PostgreSQL or if they keep all the data in text files. All we need from <code class="highlighter-rouge">Posts</code> is an ability to list all posts for us and to create a new one. Implementation details are perfectly hidden inside. Now let’s see how we can implement these two classes.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=03PXmPc7Q3g"><div class="box"> <img src="https://i.ytimg.com/vi/03PXmPc7Q3g/mqdefault.jpg" alt="YouTube video #03PXmPc7Q3g" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>ORM is an Offensive Anti-Pattern; 9 November 2016.</div></aside><p>I’m going to use <a href="http://jdbc.jcabi.com">jcabi-jdbc</a> as a JDBC wrapper, but you can use something else like <a href="http://www.jooq.org">jOOQ</a>, or just plain JDBC if you like. It doesn’t really matter. What matters is that your database interactions are hidden inside objects. Let’s start with <code class="highlighter-rouge">Posts</code> and implement it in class <code class="highlighter-rouge">PgPosts</code> (“pg” stands for PostgreSQL):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PgPosts</span> <span class="kd">implements</span> <span class="nc">Posts</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Source</span> <span class="n">dbase</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">PgPosts</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dbase</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">iterate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"SELECT id FROM post"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">select</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">ListOutcome</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;(</span>
          <span class="k">new</span> <span class="nc">ListOutcome</span><span class="o">.</span><span class="na">Mapping</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Post</span> <span class="nf">map</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ResultSet</span> <span class="n">rset</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="k">new</span> <span class="nf">PgPost</span><span class="o">(</span>
                <span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">,</span>
                <span class="n">rset</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
              <span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">)</span>
      <span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Post</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Date</span> <span class="n">date</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">PgPost</span><span class="o">(</span>
      <span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">,</span>
      <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">)</span>
        <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"INSERT INTO post (date, title) VALUES (?, ?)"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">Utc</span><span class="o">(</span><span class="n">date</span><span class="o">))</span>
        <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">title</span><span class="o">)</span>
        <span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="k">new</span> <span class="nc">SingleOutcome</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Next, let’s implement the <code class="highlighter-rouge">Post</code> interface in class <code class="highlighter-rouge">PgPost</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">PgPost</span> <span class="kd">implements</span> <span class="nc">Post</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Source</span> <span class="n">dbase</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">number</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">PgPost</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">data</span><span class="o">,</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dbase</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">id</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">number</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">date</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"SELECT date FROM post WHERE id = ?"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">number</span><span class="o">)</span>
      <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="k">new</span> <span class="nc">SingleOutcome</span><span class="o">&lt;</span><span class="nc">Utc</span><span class="o">&gt;(</span><span class="nc">Utc</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">title</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"SELECT title FROM post WHERE id = ?"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">number</span><span class="o">)</span>
      <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="k">new</span> <span class="nc">SingleOutcome</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This is how a full database interaction scenario would look like using the classes we just created:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">Posts</span> <span class="n">posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PgPosts</span><span class="o">(</span><span class="n">dbase</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Post</span> <span class="n">post</span> <span class="o">:</span> <span class="n">posts</span><span class="o">.</span><span class="na">iterate</span><span class="o">()){</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Title: "</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="na">title</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
  <span class="k">new</span> <span class="nf">Date</span><span class="o">(),</span> <span class="s">"How to cook an omelette"</span>
<span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Just added post #"</span> <span class="o">+</span> <span class="n">post</span><span class="o">.</span><span class="na">id</span><span class="o">());</span></code></pre></figure><p>You can see a full practical example <a href="https://github.com/aintshy/hub/tree/0.7.2/src/main/java/com/aintshy/pgsql">here</a>. It’s an open source web app that works with PostgreSQL using the exact approach explained above—SQL-speaking objects.</p><h2 id="what-about-performance">What About Performance?</h2><p>I can hear you screaming, “What about performance?” In that script a few lines above, we’re making many redundant round trips to the database. First, we retrieve post IDs with <code class="highlighter-rouge">SELECT id</code> and then, in order to get their titles, we make an extra <code class="highlighter-rouge">SELECT title</code> call for each post. This is inefficient, or simply put, too slow.</p><p>No worries; this is object-oriented programming, which means it is flexible! Let’s create a decorator of <code class="highlighter-rouge">PgPost</code> that will accept all data in its constructor and cache it internally, forever:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ConstPost</span> <span class="kd">implements</span> <span class="nc">Post</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Post</span> <span class="n">origin</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Date</span> <span class="n">dte</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">ttl</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">ConstPost</span><span class="o">(</span><span class="nc">Post</span> <span class="n">post</span><span class="o">,</span> <span class="nc">Date</span> <span class="n">date</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">origin</span> <span class="o">=</span> <span class="n">post</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dte</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ttl</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">id</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">origin</span><span class="o">.</span><span class="na">id</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">Date</span> <span class="nf">date</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dte</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">title</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">ttl</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Pay attention: This decorator doesn’t know anything about PostgreSQL or JDBC. It just decorates an object of type <code class="highlighter-rouge">Post</code> and pre-caches the date and title. As usual, this decorator is also immutable.</p><p>Now let’s create another implementation of <code class="highlighter-rouge">Posts</code> that will return the “constant” objects:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">ConstPgPosts</span> <span class="kd">implements</span> <span class="nc">Posts</span> <span class="o">{</span>
  <span class="c1">// ...</span>
  <span class="kd">public</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">iterate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"SELECT * FROM post"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">select</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">ListOutcome</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;(</span>
          <span class="k">new</span> <span class="nc">ListOutcome</span><span class="o">.</span><span class="na">Mapping</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">Post</span> <span class="nf">map</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ResultSet</span> <span class="n">rset</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span> <span class="k">new</span> <span class="nf">ConstPost</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">PgPost</span><span class="o">(</span>
                  <span class="nc">ConstPgPosts</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">,</span>
                  <span class="n">rset</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
                <span class="o">),</span>
                <span class="nc">Utc</span><span class="o">.</span><span class="na">getTimestamp</span><span class="o">(</span><span class="n">rset</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span>
                <span class="n">rset</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
              <span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">)</span>
      <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Now all posts returned by <code class="highlighter-rouge">iterate()</code> of this new class are pre-equipped with dates and titles fetched in one round trip to the database.</p><p>Using <a href="/2015/02/26/composable-decorators.html">decorators</a> and multiple implementations of the same interface, you can compose any functionality you wish. What is the most important is that while functionality is being extended, the complexity of the design is not escalating, because classes don’t grow in size. Instead, we’re introducing new classes that stay cohesive and solid, because they are small.</p><h2 id="what-about-transactions">What About Transactions?</h2><p>Every object should deal with its own transactions and encapsulate them the same way as <code class="highlighter-rouge">SELECT</code> or <code class="highlighter-rouge">INSERT</code> queries. This will lead to nested transactions, which is perfectly fine provided the database server supports them. If there is no such support, create a session-wide transaction object that will accept a “callable” class. For example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="kd">class</span> <span class="nc">Txn</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DataSource</span> <span class="n">dbase</span><span class="o">;</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">call</span><span class="o">(</span><span class="nc">Callable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">callable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">JdbcSession</span> <span class="n">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcSession</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">dbase</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">session</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"START TRANSACTION"</span><span class="o">).</span><span class="na">exec</span><span class="o">();</span>
      <span class="no">T</span> <span class="n">result</span> <span class="o">=</span> <span class="n">callable</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
      <span class="n">session</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"COMMIT"</span><span class="o">).</span><span class="na">exec</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">session</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"ROLLBACK"</span><span class="o">).</span><span class="na">exec</span><span class="o">();</span>
      <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Then, when you want to wrap a few object manipulations in one transaction, do it like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">new</span> <span class="nc">Txn</span><span class="o">(</span><span class="n">dbase</span><span class="o">).</span><span class="na">call</span><span class="o">(</span>
  <span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">Posts</span> <span class="n">posts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PgPosts</span><span class="o">(</span><span class="n">dbase</span><span class="o">);</span>
      <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">posts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">Date</span><span class="o">(),</span> <span class="s">"How to cook an omelette"</span>
      <span class="o">);</span>
      <span class="n">post</span><span class="o">.</span><span class="na">comments</span><span class="o">().</span><span class="na">post</span><span class="o">(</span><span class="s">"This is my first comment!"</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">post</span><span class="o">.</span><span class="na">id</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">);</span></code></pre></figure><p>This code will create a new post and post a comment to it. If one of the calls fail, the entire transaction will be rolled back.</p><p>This approach looks object-oriented to me. I’m calling it “SQL-speaking objects,” because they know how to speak SQL with the database server. It’s their skill, perfectly encapsulated inside their borders.</p></div></article></div><div class="wrapper" aria-hidden="true"> <related-posts /></div><div class="disqus" role="complementary" aria-hidden="true"><p class="disqus_hint" > Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2022</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?7f69172ff02"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
