<!DOCTYPE html>
<html amp lang="en">
  <head>

    <meta charset="utf-8">
    <title>Object-Oriented Java Adapter of Amazon S3 SDK</title>
    <link rel="canonical" href="https://www.yegor256.com/2014/05/26/amazon-s3-java-oop-adapter.html">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/05/26/amazon-s3-java-oop-adapter.html"
        },
        "headline": "Object-Oriented Java Adapter of Amazon S3 SDK",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-05-26",
        "dateModified": "2014-05-26",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "jcabi-s3 is an object-oriented Java adapter for Amazon S3
that simplifies basic read and write operations and
makes them truly object-oriented
",
        "keywords": ["amazon s3 java", "s3 java", "s3 java api", "s3 java client", "s3 java example", "s3 java api example", "s3 java adapter", "s3 java object-oriented"]
      }
    </script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style>
<noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500">
    <style amp-custom="amp-custom">
      @font-face {
        font-family: 'Cambria';
        src: url('https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf');
      }
      body { font-family: 'Cambria', 'Times New Roman', serif; padding: .5em; font-size: 1.2em; }
      article { width: 600px; max-width: 100%; margin-left: auto; margin-right: auto; }
      pre, code { font-family: 'Source Code Pro', 'Courier New', monospace; font-size: .8em; }
      code { padding: 0 .3em; background-color: lightgray; }
      a, a:hover, a:visited { color: inherit; }
      .intro { color: red; font-size: .75em; }
      .photo { border-radius: 50%; }
      pre { overflow-x:scroll; }
    </style>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  <body>
    <article>
      <p class="intro">
        This is a mobile version, full one is
        <a href="https://www.yegor256.com/2014/05/26/amazon-s3-java-oop-adapter.html">here</a>.
      </p>
      <p>
        <amp-img src="/images/face-256x256.jpg" width="80" height="80" alt="Yegor Bugayenko" class="photo"></amp-img>
      </p>
      <p>Yegor Bugayenko<br>26 May 2014</p>
      <h1>Object-Oriented Java Adapter of Amazon S3 SDK</h1>
      

<p>I’m a big fan of Amazon Web Services (AWS). I’m using them
in almost all of my projects. One of their most popular
services is <a href="http://aws.amazon.com/s3/">Simple Storage Service (S3)</a>.
It is a storage for binary objects (files) with unique names,
accessible through HTTP or RESTful API.</p>

<p>Using S3 is very simple. You create a “bucket” with a unique name,
upload your “object” into the bucket through their web interface or
through RESTful API, and then download it again (either through HTTP or the API.)</p>

<p>Amazon ships the <a href="https://aws.amazon.com/sdkforjava/">Java SDK</a>
that wraps their RESTful API. However, this SDK is not object-oriented
at all. It is purely imperative and procedural—it just mirrors the API.</p>

<p>For example, in order to download an existing object <code class="language-plaintext highlighter-rouge">doc.txt</code>
from bucket <code class="language-plaintext highlighter-rouge">test-1</code>, you have to do something like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AWSCredentials</span> <span class="n">creds</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicAWSCredentials</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">secret</span><span class="o">);</span>
<span class="nc">AmazonS3</span> <span class="n">aws</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AmazonS3Client</span><span class="o">(</span><span class="n">creds</span><span class="o">);</span>
<span class="nc">S3Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">aws</span><span class="o">.</span><span class="na">getObject</span><span class="o">(</span>
  <span class="k">new</span> <span class="nf">GetObjectRequest</span><span class="o">(</span><span class="s">"test-1"</span><span class="o">,</span> <span class="s">"doc.txt"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">getObjectContent</span><span class="o">();</span>
<span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="nc">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="s">"UTF-8"</span><span class="o">);</span>
<span class="n">input</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div>



<p>As always, procedural programming has its inevitable
disadvantages. To overcome them all, I designed
<a href="http://s3.jcabi.com">jcabi-s3</a>, which is a small
object-oriented adapter for Amazon SDK. This is how the same
object-reading task can be accomplished with <a href="http://s3.jcabi.com">jcabi-s3</a>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Region</span> <span class="n">region</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Region</span><span class="o">.</span><span class="na">Simple</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">secret</span><span class="o">);</span>
<span class="nc">Bucket</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="s">"test-1"</span><span class="o">);</span>
<span class="nc">Ocket</span> <span class="n">ocket</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="na">ocket</span><span class="o">(</span><span class="s">"doc.txt"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Ocket</span><span class="o">.</span><span class="na">Text</span><span class="o">(</span><span class="n">ocket</span><span class="o">).</span><span class="na">read</span><span class="o">();</span>
</code></pre></div></div>

<p>Why is this approach better? Well, there are a number of obvious advantages.</p>



<h2 id="s3-object-is-an-object-in-java">S3 Object is an Object in Java</h2>

<p>S3 object get its representative in Java. It is not
a collection of procedures to be called in order to
get its properties (as with AWS SDK). Rather, it is a Java object
with certain behaviors. I called them “ockets” (similar to “buckets”),
in order to avoid clashes with <code class="language-plaintext highlighter-rouge">java.lang.Object</code>.</p>

<p><a href="http://s3.jcabi.com/apidocs-0.5/com/jcabi/s3/Ocket.html"><code class="language-plaintext highlighter-rouge">Ocket</code></a> is
an interface, that exposes the behavior of a real AWS S3 object:
read, write, check existence. There is also a convenient decorator
<code class="language-plaintext highlighter-rouge">Ocket.Text</code> that simplifies working with binary objects:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Ocket</span><span class="o">.</span><span class="na">Text</span> <span class="n">ocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Ocket</span><span class="o">.</span><span class="na">Text</span><span class="o">(</span><span class="n">ocket_from_s3</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">ocket</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">ocket</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">ocket</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, you can pass an object to another class, instead of giving it
your AWS credentials, bucket name, and object name. You simply pass
a Java object, which encapsulates all AWS interaction details.</p>

<h2 id="extendability-through-decoration">Extendability Through Decoration</h2>

<p>Since <a href="http://s3.jcabi.com">jcabi-s3</a> exposes all entities
as interfaces, they can easily be extended through encapsulation
(<a href="https://en.wikipedia.org/wiki/Decorator_pattern">Decorator Pattern</a>).</p>

<p>For example, you want your code to retry S3 object read operations
a few times before giving up and
<a href="/2015/12/01/rethrow-exceptions.html">throwing</a> an <code class="language-plaintext highlighter-rouge">IOException</code>
(by the way, this is a very good practice when working with web services).
So, you want all your S3 reading operations to be redone a few times
if first attempts fail.</p>

<p>You define a new decorator class, say, <code class="language-plaintext highlighter-rouge">RetryingOcket</code>,
which encapsulates an original <code class="language-plaintext highlighter-rouge">Ocket</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">RetryingOcket</span> <span class="kd">implements</span> <span class="nc">Ocket</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Ocket</span> <span class="n">origin</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">RetryingOcket</span><span class="o">(</span><span class="nc">Ocket</span> <span class="n">ocket</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">origin</span> <span class="o">=</span> <span class="n">ocket</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">origin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">attempt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="c1">// same for other methods</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, everywhere where <code class="language-plaintext highlighter-rouge">Ocket</code> is expected you send
an instance of <code class="language-plaintext highlighter-rouge">RetryingOcket</code> that wraps your original object:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="k">new</span> <span class="nc">RetryingOcket</span><span class="o">(</span><span class="n">ocket</span><span class="o">));</span>
</code></pre></div></div>

<p>Method <code class="language-plaintext highlighter-rouge">foo.process()</code> won’t see a difference, since
it is the same <code class="language-plaintext highlighter-rouge">Ocket</code> interface it is expecting.</p>

<p>By the way, this retry functionality is implemented
out-of-the-box in <a href="http://s3.jcabi.com">jcabi-s3</a>,
in <a href="http://s3.jcabi.com/apidocs-0.5/com/jcabi/s3/retry/package-summary.html"><code class="language-plaintext highlighter-rouge">com.jcabi.s3.retry</code></a> package.</p>

<h2 id="easy-mocking">Easy Mocking</h2>

<p>Again, due to the fact that all entities in
<a href="http://s3.jcabi.com">jcabi-s3</a> are interfaces, they are
very easy to mock. For example, your class expects an
S3 object, reads its data and calculates the MD5
hash (I’m using <a href="http://commons.apache.org/proper/commons-codec/apidocs/org/apache/commons/codec/digest/DigestUtils.html"><code class="language-plaintext highlighter-rouge">DigestUtils</code></a>
from <a href="http://commons.apache.org/proper/commons-codec/">commons-codec</a>):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.jcabi.s3.Ocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.codec.digest.DigestUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S3Md5Hash</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Ocket</span> <span class="n">ocket</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nf">S3Md5Hash</span><span class="o">(</span><span class="nc">Ocket</span> <span class="n">okt</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ocket</span> <span class="o">=</span> <span class="n">okt</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="nf">hash</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">ocket</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">baos</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">DigestUtils</span><span class="o">.</span><span class="na">md5hex</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Here is how simple a unit test will look (try to create
a unit test for a class using AWS SDK and you will see the difference):</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.jcabi.s3.Ocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">S3Md5HashTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">generatesHash</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Ocket</span> <span class="n">ocket</span> <span class="o">=</span> <span class="nc">Mockito</span><span class="o">.</span><span class="na">mock</span><span class="o">(</span><span class="nc">Ocket</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">Mockito</span><span class="o">.</span><span class="na">doAnswer</span><span class="o">(</span>
      <span class="k">new</span> <span class="nc">Answer</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">answer</span><span class="o">(</span><span class="kd">final</span> <span class="nc">InvocationOnMock</span> <span class="n">inv</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
          <span class="nc">OutputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">inv</span><span class="o">.</span><span class="na">getArguments</span><span class="o">()[</span><span class="mi">0</span><span class="o">]).</span><span class="na">write</span><span class="o">(</span><span class="sc">' '</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">).</span><span class="na">when</span><span class="o">(</span><span class="n">ocket</span><span class="o">).</span><span class="na">read</span><span class="o">(</span><span class="nc">Mockito</span><span class="o">.</span><span class="na">any</span><span class="o">(</span><span class="nc">OutputStream</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="nc">String</span> <span class="n">hash</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">S5Md5Hash</span><span class="o">(</span><span class="n">ocket</span><span class="o">);</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="s">"7215ee9c7d9dc229d2921a40e899ec5f"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I’m using <a href="http://junit.org/">JUnit</a> and <a href="https://code.google.com/p/mockito/">Mockito</a> in this test.</p>

<h2 id="immutability">Immutability</h2>

<p>All classes in <a href="http://s3.jcabi.com">jcabi-s3</a> are
annotated with <a href="https://aspects.jcabi.com/annotation-immutable.html"><code class="language-plaintext highlighter-rouge">@Immutable</code></a>
and are truly immutable.</p>

<p>The library ships as a JAR dependency in
<a href="https://repo1.maven.org/maven2/com/jcabi/jcabi-s3">Maven Central</a>
(get its latest versions in <a href="http://search.maven.org/">Maven Central</a>):</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jcabi-s3<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>As always, your comments and criticism are welcome as
<a href="https://github.com/jcabi/jcabi-s3/issues">GitHub issues</a>.</p>

    </article>
  </body>
</html>
