<!doctypehtml><html amp lang="en"><meta charset="utf-8"><title>MySQL Maven Plugin</title><link rel="canonical"href="https://www.yegor256.com/2014/05/21/mysql-maven-plugin.html"><link rel="icon"type="image/png"href="/favicon.ico"><meta name="viewport"content="width=device-width,minimum-scale=1,initial-scale=1"><script type="application/ld+json">{
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "mainEntityOfPage":{
          "@type": "WebPage",
          "@id": "https://www.yegor256.com/2014/05/21/mysql-maven-plugin.html"
        },
        "headline": "MySQL Maven Plugin",
        "image": {
          "@type": "ImageObject",
          "url": "https://www.yegor256.com/images/face-1024x1024.jpg",
          "height": 1400,
          "width": 1400
        },
        "datePublished": "2014-05-21",
        "dateModified": "2014-05-21",
        "author": {
          "@type": "Person",
          "name": "Yegor Bugayenko"
        },
        "publisher": {
          "@type": "Organization",
          "name": "yegor256.com",
          "logo": {
            "@type": "ImageObject",
            "url": "https://www.yegor256.com/images/face-512x512.jpg",
            "width": 512,
            "height": 512
          }
        },
        "description": "jcabi-mysql-maven-plugin starts a fresh instance of MySQL
server before integration tests and shuts it down
when tests are finished.
",
        "keywords": ["mysql maven", "mysql maven plugin", "maven plugin for mysql", "mysql integration testing java", "mysql java test", "maven mysql java test", "mariadb maven plugin", "maven linux mysql"]
      }</script><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript><link rel="stylesheet"href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500"><style amp-custom="amp-custom">@font-face{font-family:Cambria;src:url(https://www.yegor256.com/fonts/cambria/2EAA54_2_0.ttf)}body{font-family:Cambria,'Times New Roman',serif;padding:.5em;font-size:1.2em}article{width:600px;max-width:100%;margin-left:auto;margin-right:auto}code,pre{font-family:'Source Code Pro','Courier New',monospace;font-size:.8em}code{padding:0 .3em;background-color:#d3d3d3}a,a:hover,a:visited{color:inherit}.intro{color:red;font-size:.75em}.photo{border-radius:50%}pre{overflow-x:scroll}</style><script async src="https://cdn.ampproject.org/v0.js"></script><article><p class="intro">This is a mobile version, full one is <a href="https://www.yegor256.com/2014/05/21/mysql-maven-plugin.html">here</a>.<p><amp-img src="/images/face-256x256.jpg"width="80"height="80"alt="Yegor Bugayenko"class="photo"></amp-img><p>Yegor Bugayenko<br>21 May 2014<h1>MySQL Maven Plugin</h1><p>I was using MySQL in a few Java web projects and found out there was no Maven plugin that would help me to test my <a href="/2017/12/05/data-access-object.html">DAOs</a> against a real MySQL server. There are plenty of mechanisms to mock a database persistence layer both in memory and on disc. However, it is always good to make sure that your classes are tested against a database identical to the one you have in production environment.<p>I’ve created my own Maven plugin, <a href="https://mysql.jcabi.com">jcabi-mysql-maven-plugin</a>, that does exactly two things: starts a MySQL server on <code class="language-plaintext highlighter-rouge">pre-integration-test</code> phase and shuts it down on <code class="language-plaintext highlighter-rouge">post-integration-test</code>.<p>This is how you configure it in <code class="language-plaintext highlighter-rouge">pom.xml</code> (see also its full <a href="https://mysql.jcabi.com/usage.html">usage instructions</a>):<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>build-helper-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>reserve-network-port<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;portNames&gt;</span>
                <span class="nt">&lt;portName&gt;</span>mysql.port<span class="nt">&lt;/portName&gt;</span>
              <span class="nt">&lt;/portNames&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>unpack<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;artifactItems&gt;</span>
                <span class="nt">&lt;artifactItem&gt;</span>
                  <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
                  <span class="nt">&lt;artifactId&gt;</span>mysql-dist<span class="nt">&lt;/artifactId&gt;</span>
                  <span class="nt">&lt;version&gt;</span>5.6.14<span class="nt">&lt;/version&gt;</span>
                  <span class="nt">&lt;classifier&gt;</span>${mysql.classifier}<span class="nt">&lt;/classifier&gt;</span>
                  <span class="nt">&lt;type&gt;</span>zip<span class="nt">&lt;/type&gt;</span>
                  <span class="nt">&lt;overWrite&gt;</span>false<span class="nt">&lt;/overWrite&gt;</span>
                  <span class="nt">&lt;outputDirectory&gt;</span>
                    ${project.build.directory}/mysql-dist
                  <span class="nt">&lt;/outputDirectory&gt;</span>
                <span class="nt">&lt;/artifactItem&gt;</span>
              <span class="nt">&lt;/artifactItems&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.jcabi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jcabi-mysql-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;id&gt;</span>mysql-test<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>classify<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>start<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>stop<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;port&gt;</span>${mysql.port}<span class="nt">&lt;/port&gt;</span>
              <span class="nt">&lt;data&gt;</span>${project.build.directory}/mysql-data<span class="nt">&lt;/data&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-failsafe-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;systemPropertyVariables&gt;</span>
            <span class="nt">&lt;mysql.port&gt;</span>${mysql.port}<span class="nt">&lt;/mysql.port&gt;</span>
          <span class="nt">&lt;/systemPropertyVariables&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>integration-test<span class="nt">&lt;/goal&gt;</span>
              <span class="nt">&lt;goal&gt;</span>verify<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
  [...]
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>There are two plugins configured above. Let’s take a look at what each does.<ol><li><p><strong><code class="language-plaintext highlighter-rouge">build-helper-maven-plugin</code></strong> is reserving a temporary random TCP port, which will be used by MySQL server. We don’t want to start a server on its default 3306 port, because there could be another server already running there. Besides that, if we use a hard-coded TCP port, we won’t be able to run multiple builds in parallel. Maybe not a big deal when you’re developing locally, but in <a href="/2014/10/08/continuous-integration-is-dead.html">continuous integration</a> environment this can be a problem. That’s why we’re reserving a TCP port first.<li><p><a href="https://maven.apache.org/plugins/maven-dependency-plugin/unpack-mojo.html"><strong><code class="language-plaintext highlighter-rouge">maven-dependency-plugin</code></strong></a> is downloading a MySQL distribution in a zip archive (rather big file, over 300Mb for Linux), and unpacks it. This archive contains exactly the same files as you would use for a traditional MySQL installation. When the archive is unpacked, it is ready to start serving SQL requests as a normal MySQL server.<li><p><a href="https://mysql.jcabi.com"><strong><code class="language-plaintext highlighter-rouge">jcabi-mysql-maven-plugin</code></strong></a> starts a server, binding it to a TCP port reserved randomly. The main responsibility of my Maven plugin is to make sure that MySQL server starts correctly on every platform (Mac OS, Linux, Windows) and stops when it’s not needed any more. All the rest is done by the MySQL distribution itself.<li><p><strong><code class="language-plaintext highlighter-rouge">maven-failsafe-plugin</code></strong> is running unit tests on <code class="language-plaintext highlighter-rouge">integration-test</code> phase. Its main difference from maven-surefire-plugin is that it doesn’t fail a build when some tests fail. Instead, it saves all failures into supplementary files in <code class="language-plaintext highlighter-rouge">target</code> directory and allows the build continue. Later, when we call its <code class="language-plaintext highlighter-rouge">verify</code> goal, it will fail a build if there were any errors during its <code class="language-plaintext highlighter-rouge">integration-test</code> goal execution.</ol><p>To be precise, this is the order in which Maven will execute configured goals:<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jcabi-mysql-maven-plugin:classify
maven-dependency-plugin:unpack
build-helper-maven-plugin:reserve-network-port
jcabi-mysql-maven-plugin:start
maven-failsafe-plugin:integration-test
jcabi-mysql-maven-plugin:stop
maven-failsafe-plugin:verify
</code></pre></div></div><p>Run <code class="language-plaintext highlighter-rouge">mvn clean install</code> and see how it works. If it doesn’t work for some reason, don’t hesitate <a href="https://github.com/jcabi/jcabi-mysql-maven-plugin/issues">to report an issue to GitHub</a>.<p>Now it’s time to create an integration test, which will connect to the temporary MySQL server, create a table there and insert some data into it. This is just an example to show that MySQL server is running and is capable of serving transactions (I’m using <a href="https://jdbc.jcabi.com">jcabi-jdbc</a>):<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FooITCase</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PORT</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"mysql.port"</span><span class="o">);</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">worksWithMysqlServer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="nc">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span>
      <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
        <span class="s">"jdbc:mysql://localhost:%s/root?user=root&amp;password=root"</span><span class="o">,</span>
        <span class="nc">FooITCase</span><span class="o">.</span><span class="na">PORT</span>
      <span class="o">)</span>
    <span class="o">);</span>
    <span class="k">new</span> <span class="nf">JdbcSession</span><span class="o">(</span><span class="n">conn</span><span class="o">)</span>
      <span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"CREATE TABLE foo (id INT PRIMARY KEY)"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>If you’re using Hibernate, just create a <code class="language-plaintext highlighter-rouge">db.properties</code> file in <code class="language-plaintext highlighter-rouge">src/test/resources</code> directory. In that file you would do something like:<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">hibernate.connection.url</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:${mysql.port}/root</span>
<span class="py">hibernate.connection.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">hibernate.connection.password</span><span class="p">=</span><span class="s">root</span>
</code></pre></div></div><p>Maven will replace that <code class="language-plaintext highlighter-rouge">${mysql.port}</code> with the number of reserved TCP port, during resources copying. This operation is called “resources filtering,” and you can read about it <a href="https://maven.apache.org/plugins/maven-resources-plugin/examples/filter.html">here</a>.<p>That’s pretty much it. I’m using <a href="https://mysql.jcabi.com">jcabi-mysql-maven-plugin</a> in a few projects, and it helps me to stay confident that my code works with a real MySQL server. I’m also using the <a href="https://www.liquibase.org/">Liquibase</a> Maven <a href="https://www.liquibase.org/documentation/maven/">plugin</a> in order to populate an empty server with tables required for the application. Nevertheless, that is a story for the <a href="/2014/07/20/liquibase-in-maven.html">next post</a>.</article>